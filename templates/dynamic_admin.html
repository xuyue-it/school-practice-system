<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>{{ form_name }} - è¡¨å•ç®¡ç†</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f5f7fb;
      margin: 0;
      padding: 0;
      color: #111;
    }
    header {
      background: #2563eb;
      color: #fff;
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 900;
    }
    header .actions a {
      margin-left: 12px;
      padding: 8px 14px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      color: #fff;
      background: #10b981;
      transition: 0.2s;
    }
    header .actions a.logout { background: #ef4444; }
    header .actions a:hover { opacity: 0.9; }
    main {
      max-width: 1000px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
    }
    h2 {
      margin: 0 0 20px 0;
      font-size: 20px;
      font-weight: 900;
      border-left: 6px solid #2563eb;
      padding-left: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 12px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #f3f4f6;
      font-weight: 700;
    }
    tr:hover { background: #f9fafb; }
    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      font-size: 13px;
    }
    .btn.export { background: #2563eb; color: #fff; }
    .btn.export:hover { background: #1d4ed8; }
    .btn.delete { background: #ef4444; color: #fff; }
    .btn.delete:hover { background: #dc2626; }
    .status {
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-block;
    }
    .status.å¾…å®¡æ ¸ { background: #fef9c3; color: #92400e; }
    .status.é€šè¿‡ { background: #dcfce7; color: #166534; }
    .status.æ‹’ç» { background: #fee2e2; color: #991b1b; }
    footer {
      margin-top: 30px;
      font-size: 13px;
      color: #888;
      text-align: center;
    }

    /* ====== æ–°å¢ï¼šå¤–è§‚ä¸ä¸»é¢˜é¢æ¿çš„è½»é‡æ ·å¼ï¼ˆåªä½œç”¨äºé¢æ¿ï¼‰ ====== */
    #theme-bg-panel .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
    #theme-bg-panel .box{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    #theme-bg-panel .muted{color:#6b7280;font-size:12px}
    #theme-bg-panel .preview-card{
      border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px;
      max-width:420px;background:#fff;
    }
    #theme-bg-panel .preview-card h5{margin:0 0 8px 0}
    #theme-bg-panel .preview-card .btn-demo{
      display:inline-block;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;
      color:#fff;background:var(--brand, #2563eb);font-weight:700
    }
    #theme-bg-panel .img-wrap{
      position:relative;margin-top:8px;border:1px dashed #d1d5db;border-radius:12px;overflow:hidden;height:180px;
      background:#f9fafb
    }
    #theme-bg-panel .img{
      width:100%;height:100%;object-fit:cover;display:none;object-position:50% 50%;
    }
    #theme-bg-panel .del{
      position:absolute;top:8px;right:8px;border:none;border-radius:50%;
      width:28px;height:28px;line-height:28px;text-align:center;
      background:rgba(0,0,0,.55);color:#fff;font-weight:900;cursor:pointer;display:none;
    }
    #theme-bg-panel .img-wrap:hover .del{display:block;}
    #theme-bg-panel input[type="color"]{width:42px;height:42px;border:none;cursor:pointer}
    #theme-bg-panel input[type="text"].color-text{width:120px;padding:8px;border:1px solid #ddd;border-radius:8px}
    #theme-bg-panel input[type="range"]{width:160px}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“‘ è¡¨å•åå°ç®¡ç† - {{ form_name }}</h1>
    <div class="actions">
      <a href="/" class="home">ğŸ  è¿”å›é¦–é¡µ</a>
      <a href="/logout" class="logout">é€€å‡º</a>
    </div>
  </header>

  <main>

    <!-- ====== æ–°å¢ï¼šå¤–è§‚ä¸ä¸»é¢˜ï¼ˆå®æ—¶é¢„è§ˆï¼‰é¢æ¿ ====== -->
    <div id="theme-bg-panel" style="margin:0 0 22px;">
      <div class="box">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <h4 style="margin:0;">å¤–è§‚ä¸ä¸»é¢˜ï¼ˆå®æ—¶é¢„è§ˆï¼‰</h4>
          <button id="saveTheme" type="button"
                  style="padding:8px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer">
            ä¿å­˜å¤–è§‚
          </button>
        </div>

        <div class="row" style="margin-top:10px">
          <label>ä¸»é¢˜è‰²ï¼š</label>
          <input id="brandColor" type="color" value="#2563eb">
          <input id="brandColorText" class="color-text" type="text" value="#2563eb" placeholder="#2563eb">
          <span class="muted">ä¿å­˜æ—¶å°†å†™å…¥ <code>schema.theme.brand</code></span>
        </div>

        <div class="row" style="align-items:flex-start;">
          <div style="flex:1;min-width:280px">
            <label>èƒŒæ™¯å›¾ç‰‡ï¼š</label>
            <input id="bgFile" type="file" accept="image/*">
            <div class="img-wrap" id="bgWrap">
              <img id="bgImg" class="img" alt="">
              <button id="bgDel" class="del" title="åˆ é™¤">Ã—</button>
            </div>
            <div class="muted">æç¤ºï¼šæŒ‰ä½é¢„è§ˆåŒºæ‹–åŠ¨å³å¯ç§»åŠ¨èƒŒæ™¯ï¼›ä¸‹é¢æ»‘æ†å¯å¾®è°ƒã€‚</div>
            <div class="row">
              <label>æ°´å¹³</label><input id="bgX" type="range" min="0" max="100" value="50">
              <label>å‚ç›´</label><input id="bgY" type="range" min="0" max="100" value="50">
              <span id="bgPosText" class="muted">50% 50%</span>
            </div>
          </div>

          <div class="preview-card" style="flex:1;min-width:260px">
            <h5>é¢„è§ˆ</h5>
            <div class="muted">ç¤ºæ„æŒ‰é’®ä¼šä½¿ç”¨ä¸»é¢˜è‰²ï¼›èƒŒæ™¯å›¾ä½ç½®ä»…ä½œå‚è€ƒã€‚</div>
            <div style="margin-top:10px">
              <input type="text" placeholder="ç¤ºä¾‹è¾“å…¥æ¡†" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px">
            </div>
            <div style="margin-top:10px">
              <button class="btn-demo" type="button">æäº¤ï¼ˆç¤ºæ„ï¼‰</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ====== æ–°å¢é¢æ¿ç»“æŸ ====== -->

    <h2>æäº¤è®°å½•</h2>
    {% if submissions %}
      <table>
        <tr>
          <th>ID</th>
          {% for field in field_order %}
            <th>{{ field_labels[field] }}</th>
          {% endfor %}
          <th>çŠ¶æ€</th>
          <th>å®¡æ ¸æ„è§</th>
          <th>æ“ä½œ</th>
        </tr>
        {% for sub in submissions %}
          <tr>
            <td>{{ sub[0] }}</td>
            {% for field in field_order %}
              <td>{{ sub[2][field] }}</td>
            {% endfor %}
            <td><span class="status {{ sub[3] }}">{{ sub[3] }}</span></td>
            <td>{{ sub[4] or '-' }}</td>
            <td>
              <a href="/site/{{ site_name }}/admin/export_word/{{ sub[0] }}" class="btn export">å¯¼å‡º Word</a>
              <a href="/site/{{ site_name }}/admin/export_excel/{{ sub[0] }}" class="btn export">å¯¼å‡º Excel</a>
              <a href="/form/{{ form_id }}/delete/{{ sub[0] }}" class="btn delete">åˆ é™¤</a>
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p style="color:#666;">æš‚æ— æäº¤è®°å½•ã€‚</p>
    {% endif %}
  </main>

  <footer>
    Powered by Flask Â· è¡¨å•æäº¤ä¸ç®¡ç†å¹³å°
  </footer>

  <!-- ====== æ–°å¢ï¼šå¤–è§‚ä¸ä¸»é¢˜è„šæœ¬ï¼ˆé›¶ä¾èµ–ï¼‰ ====== -->
  <script>
  (function(){
    // ç«™ç‚¹åæä¾›ç»™ä¸Šä¼ /åˆ é™¤/ä¿å­˜æ¥å£
    const site = {{ site_name|tojson }};
    // è‹¥å­˜åœ¨å…¨å±€ schemaï¼Œåˆ™å¤ç”¨ï¼Œå¦åˆ™åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„ï¼Œä»…ç”¨äºä¿å­˜æ—¶åˆå¹¶
    const schema = window.currentSchema || (window.currentSchema = { fields: [], theme: {} });

    // DOM
    const $ = s => document.querySelector(s);
    const brandInput = $('#brandColor');
    const brandText  = $('#brandColorText');
    const bgFile     = $('#bgFile');
    const bgImg      = $('#bgImg');
    const bgWrap     = $('#bgWrap');
    const bgDel      = $('#bgDel');
    const bgX        = $('#bgX');
    const bgY        = $('#bgY');
    const bgPosText  = $('#bgPosText');
    const saveBtn    = $('#saveTheme');

    // åˆå§‹åŒ–ä¸»é¢˜/èƒŒæ™¯ï¼ˆä» schema è¯»ï¼Œè‹¥æ— åˆ™å–é»˜è®¤ï¼‰
    const initBrand = (schema.theme && schema.theme.brand) || '#2563eb';
    brandInput.value = initBrand;
    brandText.value  = initBrand;
    document.documentElement.style.setProperty('--brand', initBrand);

    const initBg = schema.bg || "";
    const initPos = (schema.bg_position || "50% 50%").split(" ");
    if(initBg){ bgImg.src = initBg; bgImg.style.display='block'; }
    bgX.value = parseFloat(initPos[0]) || 50;
    bgY.value = parseFloat(initPos[1]) || 50;
    bgPosText.textContent = `${bgX.value}% ${bgY.value}%`;
    bgImg.style.objectPosition = `${bgX.value}% ${bgY.value}%`;

    // â€”â€” ä¸»é¢˜è‰²åŒæ­¥ â€”â€” //
    function setBrand(v){
      if(!schema.theme) schema.theme = {};
      schema.theme.brand = v;
      brandInput.value = v; brandText.value = v;
      document.documentElement.style.setProperty('--brand', v);
    }
    brandInput.addEventListener('input', e => setBrand(e.target.value));
    brandText.addEventListener('change', e => setBrand(e.target.value));

    // â€”â€” ä¸Šä¼ èƒŒæ™¯ â€”â€” //
    bgFile.addEventListener('change', async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const fd = new FormData();
      fd.append('file', f);
      try{
        const res = await fetch(`/site/${encodeURIComponent(site)}/admin/api/upload_asset`, { method:'POST', body: fd });
        const j = await res.json();
        if(!j.ok) return alert(j.error || 'ä¸Šä¼ å¤±è´¥');
        schema.bg = j.url;
        bgImg.src = j.url; bgImg.style.display='block';
      }catch(err){ alert('ä¸Šä¼ å¤±è´¥'); console.error(err); }
    });

    // â€”â€” åˆ é™¤èƒŒæ™¯ï¼ˆæ‚¬æµ®å³ä¸Šè§’ Ã—ï¼‰ â€”â€” //
    bgDel.addEventListener('click', async ()=>{
      if(!schema.bg) return;
      const name = (schema.bg.split('/').pop()||'').split('?')[0];
      try{
        await fetch(`/site/${encodeURIComponent(site)}/admin/api/delete_asset`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ filename: name })
        });
      }catch(_){}
      schema.bg = ""; bgImg.src=""; bgImg.style.display='none';
    });

    // â€”â€” èƒŒæ™¯ä½ç½®ï¼šæ»‘æ† + æ‹–åŠ¨ â€”â€” //
    function applyPos(){
      const pos = `${bgX.value}% ${bgY.value}%`;
      schema.bg_position = pos;
      bgPosText.textContent = pos;
      bgImg.style.objectPosition = pos;
    }
    bgX.addEventListener('input', applyPos);
    bgY.addEventListener('input', applyPos);

    let dragging=false, startX=0, startY=0, startPX=+bgX.value, startPY=+bgY.value;
    bgWrap.addEventListener('mousedown', e=>{
      dragging=true; startX=e.clientX; startY=e.clientY;
      startPX=+bgX.value; startPY=+bgY.value;
    });
    window.addEventListener('mouseup', ()=> dragging=false);
    window.addEventListener('mousemove', e=>{
      if(!dragging) return;
      const dx = e.clientX - startX, dy = e.clientY - startY;
      let nx = Math.max(0, Math.min(100, startPX + dx*0.1));
      let ny = Math.max(0, Math.min(100, startPY + dy*0.1));
      bgX.value = nx.toFixed(1);
      bgY.value = ny.toFixed(1);
      applyPos();
    });

    // â€”â€” ç›´æ¥ä¿å­˜å¤–è§‚åˆ°æ•°æ®åº“ â€”â€” //
    if (saveBtn) {
      saveBtn.addEventListener('click', async ()=>{
        try{
          const res = await fetch(`/site/${encodeURIComponent(site)}/admin/api/save_theme_bg`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              theme: { brand: (schema.theme && schema.theme.brand) || '#2563eb' },
              bg: schema.bg || "",
              bg_position: schema.bg_position || "50% 50%"
            })
          });
          const j = await res.json();
          if(!j.ok){ alert(j.error||'ä¿å­˜å¤±è´¥'); return; }
          alert('å·²ä¿å­˜å¤–è§‚è®¾ç½®');
        }catch(e){ console.error(e); alert('ä¿å­˜å¤±è´¥'); }
      });
    }

    // â€”â€” éšè—â€œæäº¤è§„åˆ™ / åˆä½œä¸éšç§â€ä¸¤ä¸ªè®¾ç½®åŒºå—ï¼ˆè‹¥å­˜åœ¨äºé¡µé¢ï¼‰ â€”â€” //
    function hideBlocks(){
      const keyTitles = ['æäº¤è§„åˆ™','åˆä½œä¸éšç§'];
      const candidates = document.querySelectorAll('h1,h2,h3,h4,.section-title,.tab-title,label,span');
      candidates.forEach(el=>{
        const t = (el.textContent||'').trim();
        if(!t) return;
        if(keyTitles.some(k => t.includes(k))){
          const box = el.closest('.section, .card, .panel, fieldset, .setting-block, .block, .tab-pane, .box, .tab-content');
          if(box) box.style.display='none';
        }
      });
    }
    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', hideBlocks);
    }else{ hideBlocks(); setTimeout(hideBlocks, 500); }
  })();
  </script>
</body>
</html>
