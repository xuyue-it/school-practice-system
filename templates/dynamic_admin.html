<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>{{ form_name }} - 动态表单管理</title>
  <style>
    body {
      font-family:"Microsoft YaHei", sans-serif;
      background:#f5f7fb;
      margin:20px;
      color:#111;
    }
    h1 {
      text-align:center;
      font-weight:900;
      margin-bottom:20px;
    }
    .topbar {
      display:flex;
      justify-content:center;
      gap:16px;
      margin-bottom:20px;
    }
    .topbar a {
      text-decoration:none;
      padding:8px 14px;
      border-radius:8px;
      background:#2563eb;
      color:white;
      font-weight:600;
    }
    .topbar a:hover { background:#1d4ed8; }

    /* 卡片样式 */
    .card {
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      padding:20px;
      margin-bottom:20px;
    }
    .card h2 {
      font-size:18px;
      font-weight:700;
      margin-bottom:12px;
    }
    .meta {
      font-size:14px;
      color:#555;
      margin-bottom:10px;
    }
    .detail {
      border-collapse: collapse;
      width:100%;
      font-size:13px;
      margin-bottom:12px;
    }
    .detail td {
      border:1px solid #ddd;
      padding:6px 8px;
      text-align:left;
    }
    .badge {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      margin-left:6px;
    }
    .badge-pending { background:#facc15; color:#111; }
    .badge-approved { background:#16a34a; color:#fff; }
    .badge-rejected { background:#dc2626; color:#fff; }

    input.comment {
      width:100%;
      padding:8px;
      margin-bottom:10px;
      border-radius:6px;
      border:1px solid #ccc;
    }
    .actions {
      display:flex;
      gap:10px;
    }
    button {
      flex:1;
      padding:8px 12px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    .btn-approve { background:#22c55e; color:#fff; }
    .btn-reject { background:#ef4444; color:#fff; }
    .btn-delete { background:#f59e0b; color:#111; }
    button:hover { opacity:0.9; }
  </style>
</head>
<body>
  <h1>📊 {{ form_name }} - 提交管理</h1>

  <div class="topbar">
    <a href="/">🏠 返回首页</a>
    <a href="/site/{{ site_name }}/admin/users">👥 用户管理</a>
    <a href="/logout/{{ site_name }}">🚪 退出登录</a>
  </div>

  {% for s in submissions %}
  <div class="card" id="row-{{ s[0] }}">
    <h2>提交 #{{ s[0] }}</h2>
    <div class="meta">
      提交用户: {{ s[1] }} ｜ 时间: {{ s[5] }}
      {% if s[3] == "待审核" %}
        <span class="badge badge-pending">{{ s[3] }}</span>
      {% elif s[3] == "通过" %}
        <span class="badge badge-approved">{{ s[3] }}</span>
      {% elif s[3] == "不通过" %}
        <span class="badge badge-rejected">{{ s[3] }}</span>
      {% else %}
        {{ s[3] }}
      {% endif %}
    </div>
    <div class="data">
      <table class="detail">
        {% for k, v in s[2].items() %}
          <tr><td>{{ k }}</td><td>{{ v }}</td></tr>
        {% endfor %}
      </table>
    </div>
    <div>审核说明: {{ s[4] or "（无）" }}</div>
    <input type="text" id="comment-{{ s[0] }}" class="comment" placeholder="输入审核说明">
    <div class="actions">
      <button class="btn-approve" onclick="updateStatus({{ form_id }}, {{ s[0] }}, '通过')">通过</button>
      <button class="btn-reject" onclick="updateStatus({{ form_id }}, {{ s[0] }}, '不通过')">不通过</button>
      <button class="btn-delete" onclick="deleteSubmission({{ form_id }}, {{ s[0] }})">删除</button>
    </div>
  </div>
  {% endfor %}

<script>
async function updateStatus(form_id, sub_id, status){
  const comment = document.getElementById(`comment-${sub_id}`).value;
  const res = await fetch(`/form/${form_id}/update_status/${sub_id}`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({status:status, comment:comment})
  });
  const data = await res.json();
  if(data.success){
    alert("✅ 状态已更新为 " + status);
    location.reload();
  } else {
    alert("❌ " + (data.message || "更新失败"));
  }
}

async function deleteSubmission(form_id, sub_id){
  if(!confirm("确定删除该提交？")) return;
  const res = await fetch(`/form/${form_id}/delete/${sub_id}`, {method:"POST"});
  const data = await res.json();
  if(data.success){
    document.getElementById("row-"+sub_id).remove();
    alert("✅ 已删除");
  } else {
    alert("❌ " + (data.message || "删除失败"));
  }
}
</script>
</body>
</html>
