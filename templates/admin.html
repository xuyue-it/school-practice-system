<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>管理审核 - 通用申请系统</title>
<script src="/static/theme.js"></script>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
  :root{
    --bg-gradient: linear-gradient(135deg, #f8fafc, #e2e8f0);
    --card-gradient-odd: linear-gradient(90deg, #ffffff, #f1f5f9);
    --card-gradient-even: linear-gradient(90deg, #f9fafb, #e2e8f0);
    --header-gradient: linear-gradient(90deg,#f1f5f9,#e2e8f0);
    --hover-gradient: linear-gradient(90deg,#e0f2fe,#c7d2fe);

    --text:#111827;
    --muted:#6b7280;
  }

  body.dark {
    --bg-gradient: linear-gradient(135deg, #1a1a1a, #2d2d2d);
    --card-gradient-odd: linear-gradient(90deg, #2b2b2b, #3a3a3a);
    --card-gradient-even: linear-gradient(90deg, #333333, #444444);
    --header-gradient: linear-gradient(90deg,#2e2e2e,#3f3f3f);
    --hover-gradient: linear-gradient(90deg,#4a4a4a,#555555);

    --text:#f5f5f5;
    --muted:#a3a3a3;
  }

  *{ box-sizing: border-box; }
  body {
    font-family: "Microsoft YaHei", sans-serif;
    background: var(--bg-gradient);
    padding:24px;
    color:var(--text);
    transition: background 0.4s ease, color 0.4s ease;
  }
  .wrap { max-width: 100%; margin: 0 auto; }
  .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:10px; flex-wrap: wrap; }
  h1 { margin:0; font-size:24px; font-weight:900; }
  .topbar-actions{ display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
  .topbar-actions a,
  .topbar-actions button,
  .search-box{
    display:inline-flex; align-items:center; gap:6px;
    text-decoration:none; cursor:pointer;
    padding:8px 12px; border-radius:10px; border:none;
    background:var(--card-gradient-odd); color:var(--text);
    box-shadow:0 3px 6px rgba(0,0,0,.2);
    transition:.2s;
  }
  .topbar-actions a:hover, .topbar-actions button:hover{ transform: translateY(-1px); box-shadow:0 4px 10px rgba(0,0,0,.4);}
  .autorefresh{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px dashed #999; border-radius:10px; background:#fff; color:#444; }

  .scroll-x {
    width:100%;
    overflow-x:auto;
    border-radius:14px;
    background:transparent;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  /* 表格样式 */
  table { border-collapse: collapse; width: 100%; white-space: nowrap; border:none; }
  thead th {
    position: sticky;
    top: 0;
    background: var(--header-gradient);
    font-weight:900;
    font-size:14px;
    text-align:center;
    z-index: 2;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    border: none;
    padding:14px 12px;
    color: var(--text);
  }
  tbody td {
    font-size:15px;
    text-align:center;
    vertical-align: middle;
    border: none;
    padding:14px 12px;
    color: var(--text);
  }

  tbody tr:nth-child(odd){ background: var(--card-gradient-odd); }
  tbody tr:nth-child(even){ background: var(--card-gradient-even); }
  tbody tr:hover{ background: var(--hover-gradient); }

  .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:none; }
  .badge-pending { background:#facc15; color:#111; }
  .badge-approved { background:#16a34a; color:#fff; }
  .badge-rejected { background:#dc2626; color:#fff; }

  .status-block { display:flex; flex-direction:column; align-items:center; gap:4px; }

  /* 审核说明框：无边框 + hover 柔光 */
  .comment-input {
    width: 240px; height:34px;
    font-size:14px; padding:6px 10px;
    border: none;
    border-radius:8px;
    background:#f3f4f6; color:var(--text);
    transition: box-shadow .2s ease, background .2s ease;
  }
  .comment-input:hover {
    background:#e5e7eb;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
  }
  body.dark .comment-input {
    background:#2a2a2a; color:#f5f5f5;
  }
  body.dark .comment-input:hover {
    background:#3a3a3a;
    box-shadow: 0 0 8px rgba(255,255,255,0.15);
  }

  /* 按钮基础样式 */
  .btn{
    appearance:none; cursor:pointer;
    padding:8px 14px; border-radius:8px;
    font-size:14px; line-height:1;
    border: none;
    color:#fff;
    transition:.2s;
    box-shadow: 0 3px 6px rgba(0,0,0,.4), inset 0 1px 2px rgba(255,255,255,0.1);
  }
  .btn:hover{
    transform: translateY(-1px);
    box-shadow:0 4px 12px rgba(0,0,0,.5), inset 0 1px 3px rgba(255,255,255,0.15);
  }
  /* ✅ 新增 active 效果 */
  .btn:active {
   transform: scale(0.95);   /* 点击时缩小 95% */
   box-shadow: 0 2px 6px rgba(0,0,0,0.4) inset;
  }

  /* ✅ 按钮颜色（浅色 + 暗色模式下保持） */
  .btn-approve{ background: linear-gradient(145deg,#22c55e,#15803d); }
  .btn-approve:hover{ background: linear-gradient(145deg,#4ade80,#16a34a); }

  .btn-reject{ background: linear-gradient(145deg,#ef4444,#b91c1c); }
  .btn-reject:hover{ background: linear-gradient(145deg,#f87171,#dc2626); }

  .btn-mail{ background: linear-gradient(145deg,#6366f1,#4338ca); }
  .btn-mail:hover{ background: linear-gradient(145deg,#818cf8,#4f46e5); }

  .btn-delete{ background: linear-gradient(145deg,#f59e0b,#d97706); color:#111; }
  .btn-delete:hover{ background: linear-gradient(145deg,#fbbf24,#ea580c); color:#fff; }

  /* 🌗 切换主题按钮 */
  .toggle-theme {
    border: none;
    background: linear-gradient(145deg,#f3f4f6,#e5e7eb);
    color: #111827;
    font-weight: 600;
    padding: 8px 14px;
    border-radius: 8px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }
  body.dark .toggle-theme {
    background: linear-gradient(145deg,#3a3a3a,#1f1f1f);
    color: #f5f5f5;
    box-shadow: 0 3px 8px rgba(0,0,0,0.5);
  }

  a.link { color:#3b82f6; text-decoration:none; }
  a.link:hover { color:#60a5fa; text-decoration:underline; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>管理审核</h1>
      <div class="topbar-actions">
        <input type="text" id="searchInput" class="search-box" placeholder="搜索姓名或活动名称..." onkeyup="filterTable()">
        <button type="button" onclick="hardReload()">刷新</button>
        <!-- ✅ 新增批量按钮 -->
        <button type="button" onclick="batchUpdateStatus('通过')">批量通过</button>
        <button type="button" onclick="batchUpdateStatus('不通过')">批量不通过</button>
        <label class="autorefresh">
          <input type="checkbox" id="autoRefreshToggle" checked>
          自动刷新（30 秒）
        </label>
        <button type="button" class="toggle-theme" onclick="toggleTheme()">🌗 切换主题</button>
        <a href="/stats">📊 数据统计</a>
        <a href="/">返回首页</a>
        <a href="/logout">退出登录</a>
      </div>
    </div>

    <div class="scroll-x">
      <table id="adminTable">
        <thead>
          <tr>
            <!-- ✅ 新增全选框 -->
            <th><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
            <th>ID</th><th>姓名</th><th>电话</th><th>邮箱</th><th>团体名称</th><th>活动名称</th>
            <th>开始</th><th>结束</th><th>地点</th><th>性质</th><th>人数</th>
            <th>器材</th><th>特别需求</th><th>捐款</th><th>方式</th><th>备注</th>
            <th>紧急联系人</th><th>紧急电话</th>
            <th>状态（含附件）</th><th>审核说明</th><th>操作</th><th>导出</th><th>发送邮件</th><th>删除</th>
          </tr>
        </thead>
        <tbody id="tbody-root">
          {% for s in submissions %}
          <tr id="row-{{ s[0] }}">
            <!-- ✅ 新增行复选框 -->
            <td><input type="checkbox" class="row-check" value="{{ s[0] }}"></td>
            <td>{{ loop.index }}</td>
            <td>{{ s[1] }}</td>
            <td>{{ s[2] }}</td>
            <td>{{ s[3] }}</td>
            <td>{{ s[4] }}</td>
            <td>{{ s[5] }}</td>
            <td>{{ s[6] }} {{ s[7] }}</td>
            <td>{{ s[8] }} {{ s[9] }}</td>
            <td>{{ s[10] }}</td>
            <td>{{ s[11] }}</td>
            <td>{{ s[12] }}</td>
            <td>{{ s[13] }}</td>
            <td>{{ s[14] }}</td>
            <td>{{ s[15] }}</td>
            <td>{{ s[16] }}</td>
            <td>{{ s[17] }}</td>
            <td>{{ s[18] }}</td>
            <td>{{ s[19] }}</td>

            <!-- 状态 + 附件 -->
            <td>
              <div class="status-block">
                {% set st = (s[20] if s|length>20 and s[20] else '待审核') %}
                <span class="badge
                  {% if '待' in st %}badge-pending{% elif '通' in st %}badge-approved{% elif '拒' in st %}badge-rejected{% endif %}
                ">{{ st }}</span>
                {% if s|length > 22 and s[22] %}
                  {% for fname in s[22].split(',') %}
                    <a class="link" href="/uploads/{{ fname }}" target="_blank">{{ fname }}</a><br>
                  {% endfor %}
                {% else %}
                  <span class="muted">无</span>
                {% endif %}
              </div>
            </td>

            <!-- 审核说明 -->
            <td>
              <input type="text" id="comment-{{ s[0] }}" class="comment-input" placeholder="审核说明">
            </td>

            <!-- 操作 -->
            <td>
              <button class="btn btn-approve" onclick="updateStatus({{ s[0] }}, '通过')">通过</button>
              <button class="btn btn-reject" onclick="updateStatus({{ s[0] }}, '不通过')">不通过</button>
            </td>

            <!-- 导出 -->
            <td><a class="link" href="/download/{{ s[0] }}" target="_blank">Word</a></td>

            <!-- 发送邮件 -->
            <td><button id="mailbtn-{{ s[0] }}" class="btn btn-mail" onclick="sendReviewEmail({{ s[0] }})">发送邮件</button></td>

            <!-- 删除 -->
            <td><button class="btn btn-delete" onclick="deleteSubmission({{ s[0] }})">删除</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<script>
function toggleTheme(){
  document.body.classList.toggle("dark");
}
function filterTable(){
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const rows = document.querySelectorAll("#tbody-root tr");
  rows.forEach(row=>{
    const name = row.cells[1]?.textContent.toLowerCase() || "";
    const eventName = row.cells[5]?.textContent.toLowerCase() || "";
    row.style.display = (name.includes(filter) || eventName.includes(filter)) ? "" : "none";
  });
}
async function handleJsonResponse(resp) {
  const text = await resp.text();
  try { return JSON.parse(text); } catch (_) { return { success:false, message: text || '非JSON响应' }; }
}
function setTip(id, msg, isError=false){
  const tip = document.getElementById(`tip-${id}`);
  if (!tip) return;
  tip.textContent = msg;
  tip.classList.toggle('error', !!isError);
  tip.style.display = 'block';
}
function formatNow(){
  const d = new Date();
  const pad = n=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function updateStatus(id, statusText) {
  const comment = document.getElementById(`comment-${id}`).value || "";
  if (!confirm(`确认将编号 ${id} 设置为「${statusText}」吗？`)) return;
  fetch(`/update_status/${id}/${encodeURIComponent(statusText)}`, {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comment: comment })
    })
    .then(async r => {
      const data = await handleJsonResponse(r);
      if (!r.ok || !data.success) {
        setTip(id, data.message || `更新失败（HTTP ${r.status})`, true);
        alert(data.message || `更新失败（HTTP ${r.status})`);
        return;
      }
      alert(`已更新为 ${data.status}`);
    })
    .catch(err => {
      console.error(err);
      alert("网络或服务器异常");
    });
}
function sendReviewEmail(id) {
  if (!confirm(`确认向该申请的邮箱发送当前审核结果和说明吗？`)) return;
  const btn = document.getElementById(`mailbtn-${id}`);
  if (btn) btn.disabled = true;
  fetch(`/send_review_email/${id}`, { method: "POST", credentials: "same-origin" })
    .then(async r => {
      const data = await handleJsonResponse(r);
      if (!r.ok || !data.success) {
        if (btn) btn.disabled = false;
        alert(data.message || `发送失败（HTTP ${r.status})`);
        return;
      }
      alert(`${data.message}`);
    })
    .catch(err => {
      console.error(err);
      if (btn) btn.disabled = false;
      alert("网络或服务器异常");
    });
}
function deleteSubmission(id){
  if (!confirm(`确认删除编号 ${id} 这条记录吗？此操作不可撤销。`)) return;
  fetch(`/delete_submission/${id}`, { method: "POST", credentials: "same-origin" })
    .then(async r => {
      const data = await handleJsonResponse(r);
      if (!r.ok || !data.success) {
        alert(data.message || `删除失败（HTTP ${r.status})`);
        return;
      }
      const row = document.getElementById(`row-${id}`);
      if (row) row.remove();
      alert(`已删除记录 ID: ${id}`);
    })
    .catch(err => {
      console.error(err);
      alert("网络或服务器异常");
    });
}
function hardReload(){
  const url = new URL(window.location.href);
  url.searchParams.set('ts', Date.now().toString());
  window.location.replace(url.toString());
}
let autoTimer = null;
function startAutoRefresh(){ stopAutoRefresh(); autoTimer = setInterval(()=>hardReload(), 30000); }
function stopAutoRefresh(){ if (autoTimer){ clearInterval(autoTimer); autoTimer = null; } }
document.addEventListener('DOMContentLoaded', ()=>{
  const toggle = document.getElementById('autoRefreshToggle');
  if (toggle){
    if (toggle.checked) startAutoRefresh();
    toggle.addEventListener('change', ()=> toggle.checked ? startAutoRefresh() : stopAutoRefresh());
  }
});
window.addEventListener('pageshow', function (e) { if (e.persisted) { hardReload(); } });
function filterTable(){
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const rows = document.querySelectorAll("#tbody-root tr");
  rows.forEach(row=>{
    const name = row.cells[1]?.textContent.toLowerCase() || "";
    const eventName = row.cells[5]?.textContent.toLowerCase() || "";
    row.style.display = (name.includes(filter) || eventName.includes(filter)) ? "" : "none";
  });
}
<!-- ✅ 新增批量操作函数 -->
function batchUpdateStatus(newStatus){
  const ids = [...document.querySelectorAll(".row-check:checked")].map(cb=>cb.value);
  if(ids.length===0){ alert("请先选择记录"); return; }
  if(!confirm(`确认将 ${ids.length} 条记录设为「${newStatus}」吗？`)) return;
  fetch("/batch_update_status", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ ids: ids, status: newStatus })
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.success){ alert("批量更新成功"); location.reload(); }
    else{ alert("更新失败: "+data.message); }
  })
  .catch(()=>alert("网络或服务器错误"));
}
function toggleAll(source){
  document.querySelectorAll(".row-check").forEach(cb=>cb.checked = source.checked);
}
</script>
</body>
</html>
