<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†å®¡æ ¸ - é€šç”¨ç”³è¯·ç³»ç»Ÿ</title>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --line:#e8ecf2; --text:#111827; --muted:#6b7280;
    --primary:#2563eb; --primary-600:#1d4ed8;
    --green:#22c55e; --green-600:#16a34a;
    --red:#ef4444; --red-600:#dc2626;
    --amber:#f59e0b; --amber-600:#d97706;
    --indigo:#6366f1; --indigo-600:#4f46e5;
  }
  *{ box-sizing: border-box; }
  body { font-family: "Microsoft YaHei", sans-serif; background:var(--bg); padding:24px; color:var(--text); }
  .wrap { max-width: 100%; margin: 0 auto; }
  .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:10px; flex-wrap: wrap; }
  h1 { margin:0; font-size:24px; font-weight:900; }
  .topbar-actions{ display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
  .topbar-actions a,
  .topbar-actions button,
  .search-box{
    display:inline-flex; align-items:center; gap:6px;
    text-decoration:none; cursor:pointer;
    padding:8px 12px; border-radius:10px; border:1px solid var(--line);
    background:var(--card); color:var(--text);
    box-shadow:0 3px 0 #d7def0, 0 8px 16px rgba(17,24,39,.06);
    transition:.12s transform ease, .12s box-shadow ease;
  }
  .topbar-actions a:hover, .topbar-actions button:hover{ transform: translateY(-1px); box-shadow:0 4px 0 #cbd6f2, 0 10px 18px rgba(17,24,39,.08);}
  .topbar-actions a:active, .topbar-actions button:active{ transform: translateY(1px); }
  .autorefresh{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px dashed var(--line); border-radius:10px; background:#fff; }
  .scroll-x { width:100%; overflow-x:auto; overflow-y:hidden; border:1px solid var(--line); border-radius:14px; background:var(--card); box-shadow:0 6px 18px rgba(17,24,39,.05); }
  table { border-collapse: separate; border-spacing:0; white-space: nowrap; }
  thead th{ position:sticky; top:0; background:#f3f4f6; z-index:1; font-weight:700; font-size:14px; text-align:left; padding:14px 12px; border-bottom:1px solid var(--line); }
  tbody td{ font-size:15px; padding:14px 12px; border-bottom:1px solid var(--line); vertical-align:top; max-width: 420px; overflow:hidden; text-overflow: ellipsis; }
  tbody tr:nth-child(odd){ background:#fbfdff; }
  tbody tr:hover{ background:#f8fafc; }
  .td-equipment { white-space: normal; max-width: 360px; line-height: 1.45; min-width: 180px; }
  .equip-lines{ display:block; }
  .equip-line{ display:block; white-space: nowrap; word-break: keep-all; }
  .badge { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid transparent; }
  .badge-pending { background:#fff7e6; border-color:#ffcc80; }
  .badge-approved { background:#e8f5e9; border-color:#a5d6a7; }
  .badge-rejected { background:#ffebee; border-color:#ef9a9a; }
  .actions { min-width: 520px; }
  .stack { display:flex; gap:8px; align-items:center; }
  .comment-input { width: 260px; padding:8px 10px; border:1px solid var(--line); border-radius:10px; }
  .btn{ appearance:none; border:none; cursor:pointer; padding:8px 12px; border-radius:10px; color:#fff; font-size:14px; line-height:1; box-shadow:0 2px 8px rgba(17,24,39,.08); transition:.15s transform ease, .15s opacity ease, .15s background ease; }
  .btn:hover{ transform: translateY(-1px); opacity:.95; }
  .btn:active{ transform:none; }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }
  .btn-approve{ background:var(--green); } .btn-approve:hover{ background:var(--green-600); }
  .btn-reject{ background:var(--red); } .btn-reject:hover{ background:var(--red-600); }
  .btn-mail{ background:var(--indigo); } .btn-mail:hover{ background:var(--indigo-600); }
  .btn-delete{ background:var(--amber); color:#111; } .btn-delete:hover{ background:var(--amber-600); color:#fff; }
  .muted { color:var(--muted); font-size:12px; }
  a.link { color:var(--primary); text-decoration:none; }
  a.link:hover { color:var(--primary-600); text-decoration:underline; }
  .inline-tip { margin-top:6px; font-size:12px; color:#065f46; }
  .inline-tip.error { color:#b91c1c; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>ç®¡ç†å®¡æ ¸</h1>
      <div class="topbar-actions">
        <input type="text" id="searchInput" class="search-box" placeholder="æœç´¢å§“åæˆ–æ´»åŠ¨åç§°..." onkeyup="filterTable()">
        <button type="button" onclick="hardReload()">åˆ·æ–°</button>
        <label class="autorefresh">
          <input type="checkbox" id="autoRefreshToggle" checked>
          è‡ªåŠ¨åˆ·æ–°ï¼ˆ30 ç§’ï¼‰
        </label>
        <a href="/stats" target="_self">ğŸ“Š æ•°æ®ç»Ÿè®¡</a>
        <a href="/" target="_self">è¿”å›é¦–é¡µ</a>
        <a href="/logout" target="_self">é€€å‡ºç™»å½•</a>
      </div>
    </div>

    <div class="scroll-x">
      <table id="adminTable">
        <thead>
          <tr>
            <th>ID</th><th>å§“å</th><th>ç”µè¯</th><th>é‚®ç®±</th><th>å›¢ä½“åç§°</th><th>æ´»åŠ¨åç§°</th>
            <th>å¼€å§‹</th><th>ç»“æŸ</th><th>åœ°ç‚¹</th><th>æ€§è´¨</th><th>äººæ•°</th>
            <th>å™¨æ</th><th>ç‰¹åˆ«éœ€æ±‚</th><th>ææ¬¾</th><th>æ–¹å¼</th><th>å¤‡æ³¨</th>
            <th>ç´§æ€¥è”ç³»äºº</th><th>ç´§æ€¥ç”µè¯</th><th>é™„ä»¶</th>
            <th>çŠ¶æ€ï¼ˆå«å®¡æ ¸è¯´æ˜ï¼‰</th>
            <th>æ“ä½œ</th><th>å¯¼å‡º</th><th>å‘é€é‚®ä»¶</th><th>åˆ é™¤</th>
          </tr>
        </thead>
        <tbody id="tbody-root">
          {% for s in submissions %}
          <tr id="row-{{ s[0] }}" data-id="{{ s[0] }}">
            <td>{{ loop.index }}</td>
            <td>{{ s[1] }}</td>
            <td>{{ s[2] }}</td>
            <td>{{ s[3] }}</td>
            <td>{{ s[4] }}</td>
            <td>{{ s[5] }}</td>
            <td>{{ s[6] }} {{ s[7] }}</td>
            <td>{{ s[8] }} {{ s[9] }}</td>
            <td>{{ s[10] }}</td>
            <td>{{ s[11] }}</td>
            <td>{{ s[12] }}</td>
            <td class="td-equipment raw-equip">{{ (s[13] if s|length>13 else '') | default('', true) }}</td>
            <td>{{ s[14] }}</td>
            <td>{{ s[15] }}</td>
            <td>{{ s[16] }}</td>
            <td>{{ s[17] }}</td>
            <td>{{ s[18] }}</td>
            <td>
              {% if s|length > 22 and s[22] %}
                <a class="link" href="/uploads/{{ s[22] }}" target="_blank">{{ s[22] }}</a>
              {% else %}
                <span class="muted">æ— </span>
              {% endif %}
            </td>
            <td class="status-cell" title="å®¡æ ¸è¯´æ˜ï¼š{% if s|length>21 and s[21] %}{{ s[21] }}{% else %}{% endif %}">
              {% set st = (s[20] if s|length>20 and s[20] else 'å¾…å®¡æ ¸') %}
              <span class="badge
                {% if 'å¾…' in st %}badge-pending{% elif 'é€š' in st %}badge-approved{% elif 'æ‹’' in st %}badge-rejected{% endif %}
              ">{{ st }}</span>
              {% if s|length>21 and s[21] %} | <span class="muted">è¯´æ˜ï¼š{{ s[21] }}</span>{% endif %}
              <div id="tip-{{ s[0] }}" class="inline-tip" style="display:none;"></div>
            </td>
            <td class="actions">
              <div class="stack">
                <input type="text" id="comment-{{ s[0] }}" class="comment-input" placeholder="å®¡æ ¸è¯´æ˜">
                <button class="btn btn-approve" onclick="updateStatus({{ s[0] }}, 'é€šè¿‡')">é€šè¿‡</button>
                <button class="btn btn-reject" onclick="updateStatus({{ s[0] }}, 'ä¸é€šè¿‡')">ä¸é€šè¿‡</button>
              </div>
            </td>
            <td><a class="link" href="/download/{{ s[0] }}" target="_blank">Word</a></td>
            <td><button id="mailbtn-{{ s[0] }}" class="btn btn-mail" onclick="sendReviewEmail({{ s[0] }})">å‘é€é‚®ä»¶</button></td>
            <td><button class="btn btn-delete" onclick="deleteSubmission({{ s[0] }})">åˆ é™¤</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

<script>
async function handleJsonResponse(resp) {
  const text = await resp.text();
  try { return JSON.parse(text); } catch (_) { return { success:false, message: text || 'éJSONå“åº”' }; }
}
function setTip(id, msg, isError=false){
  const tip = document.getElementById(`tip-${id}`);
  if (!tip) return;
  tip.textContent = msg;
  tip.classList.toggle('error', !!isError);
  tip.style.display = 'block';
}
function formatNow(){
  const d = new Date();
  const pad = n=> String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function renderStatusCell(cell, id, status, review_comment){
  let cls = 'badge';
  const st = status || 'å¾…å®¡æ ¸';
  if (st.includes('å¾…') || st.toLowerCase() === 'pending') cls += ' badge-pending';
  else if (st.includes('é€š') || st.toLowerCase() === 'approved') cls += ' badge-approved';
  else if (st.includes('æ‹’') || st.toLowerCase() === 'rejected') cls += ' badge-rejected';
  const comment = review_comment ? ` | <span class="muted">è¯´æ˜ï¼š${review_comment}</span>` : '';
  const oldTip = cell.querySelector('.inline-tip');
  const tipHTML = oldTip ? oldTip.outerHTML : `<div id="tip-${id}" class="inline-tip" style="display:none;"></div>`;
  cell.innerHTML = `<span class="${cls}">${st}</span>${comment}${tipHTML}`;
}
function refreshRowStatus(id){
  fetch(`/api/submission/${id}`, { credentials: "same-origin" })
    .then(handleJsonResponse)
    .then(data => {
      if (!data.success) return;
      const row = document.getElementById(`row-${id}`);
      const cell = row && row.querySelector('.status-cell');
      if (!cell) return;
      renderStatusCell(cell, id, data.data.status, data.data.review_comment);
    })
    .catch(()=>{});
}
function hydrateAllRows(){
  const rows = document.querySelectorAll('tr[id^="row-"]');
  rows.forEach(tr => {
    const id = tr.id.replace('row-','');
    refreshRowStatus(id);
  });
}
function beautifyEquipment(){
  const cells = document.querySelectorAll('.raw-equip');
  cells.forEach(td=>{
    const raw = (td.textContent || '').trim();
    if (!raw){ td.innerHTML = ''; return; }
    const parts = raw.split(/[,ï¼Œ\n]+/).map(s=>s.trim()).filter(Boolean);
    const lines = parts.map(p=>{
      const m = p.match(/^(.+?)x\s*(\d+)$/i);
      if (m){
        return `<div class="equip-line">${m[1]} x${m[2]}</div>`;
      }
      return `<div class="equip-line">${p}</div>`;
    }).join('');
    td.classList.remove('raw-equip');
    td.innerHTML = `<div class="equip-lines">${lines}</div>`;
  });
}
function updateStatus(id, statusText) {
  const comment = document.getElementById(`comment-${id}`).value || "";
  if (!confirm(`ç¡®è®¤å°†ç¼–å· ${id} è®¾ç½®ä¸ºã€Œ${statusText}ã€å—ï¼Ÿ`)) return;
  fetch(`/update_status/${id}/${encodeURIComponent(statusText)}`, {
      method: "POST",
      credentials: "same-origin",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comment: comment })
    })
    .then(async r => {
      const data = await handleJsonResponse(r);
      if (!r.ok || !data.success) {
        setTip(id, data.message || `æ›´æ–°å¤±è´¥ï¼ˆHTTP ${r.status})`, true);
        alert(data.message || `æ›´æ–°å¤±è´¥ï¼ˆHTTP ${r.status})`);
        return;
      }
      refreshRowStatus(id);
      setTip(id, `å·²æ›´æ–°ä¸ºã€Œ${data.status}ã€ ${formatNow()}`);
    })
    .catch(err => {
      console.error(err);
      setTip(id, "ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸", true);
      alert("ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸");
    });
}
function sendReviewEmail(id) {
  if (!confirm(`ç¡®è®¤å‘è¯¥ç”³è¯·çš„é‚®ç®±å‘é€å½“å‰å®¡æ ¸ç»“æœå’Œè¯´æ˜å—ï¼Ÿ`)) return;
  const btn = document.getElementById(`mailbtn-${id}`);
  if (btn) btn.disabled = true;
  fetch(`/send_review_email/${id}`, { method: "POST", credentials: "same-origin" })
    .then(async r => {
      const data = await handleJsonResponse(r);
      if (!r.ok || !data.success) {
        setTip(id, data.message || `å‘é€å¤±è´¥ï¼ˆHTTP ${r.status})`, true);
        if (btn) btn.disabled = false;
        alert(data.message || `å‘é€å¤±è´¥ï¼ˆHTTP ${r.status})`);
        return;
      }
      setTip(id, `${data.message}ï¼ˆ${formatNow()}ï¼‰`);
    })
    .catch(err => {
      console.error(err);
      setTip(id, "ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸", true);
      if (btn) btn.disabled = false;
      alert("ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸");
    });
}
function deleteSubmission(id){
  if (!confirm(`ç¡®è®¤åˆ é™¤ç¼–å· ${id} è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
  fetch(`/delete_submission/${id}`, { method: "POST", credentials: "same-origin" })
    .then(async r => {
      const data = await handleJsonResponse(r);
      if (!r.ok || !data.success) {
        setTip(id, data.message || `åˆ é™¤å¤±è´¥ï¼ˆHTTP ${r.status})`, true);
        alert(data.message || `åˆ é™¤å¤±è´¥ï¼ˆHTTP ${r.status})`);
        return;
      }
      const row = document.getElementById(`row-${id}`);
      if (row) row.remove();
      alert(`å·²åˆ é™¤è®°å½• ID: ${id}`);
    })
    .catch(err => {
      console.error(err);
      setTip(id, "ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸", true);
      alert("ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸");
    });
}
function hardReload(){
  const url = new URL(window.location.href);
  url.searchParams.set('ts', Date.now().toString());
  window.location.replace(url.toString());
}
let autoTimer = null;
function startAutoRefresh(){ stopAutoRefresh(); autoTimer = setInterval(()=>hardReload(), 30000); }
function stopAutoRefresh(){ if (autoTimer){ clearInterval(autoTimer); autoTimer = null; } }
document.addEventListener('DOMContentLoaded', ()=>{
  beautifyEquipment();
  hydrateAllRows();
  const toggle = document.getElementById('autoRefreshToggle');
  if (toggle){
    if (toggle.checked) startAutoRefresh();
    toggle.addEventListener('change', ()=> toggle.checked ? startAutoRefresh() : stopAutoRefresh());
  }
});
window.addEventListener('pageshow', function (e) { if (e.persisted) { hardReload(); } });
function filterTable(){
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const rows = document.querySelectorAll("#tbody-root tr");
  rows.forEach(row=>{
    const name = row.cells[1]?.textContent.toLowerCase() || "";
    const eventName = row.cells[5]?.textContent.toLowerCase() || "";
    row.style.display = (name.includes(filter) || eventName.includes(filter)) ? "" : "none";
  });
}
</script>
</body>
</html>
