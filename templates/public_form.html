<!doctype html>
<html lang="zh" class="no-js" data-theme="{{ theme_mode or 'system' }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>{{ form_title or site_name }} · 表单</title>

  <!-- 将 no-js 切换为 js（必修补 #3） -->
  <script>(function(d){d.className=d.className.replace(/\bno-js\b/,'js')})(document.documentElement)</script>

  <!-- 早期开关：首帧决定是否启用 perf-mode -->
  <script>
  (function(){
    try{
      var lowMem = navigator.deviceMemory && navigator.deviceMemory <= 2;
      var reduce = window.matchMedia && (
        window.matchMedia("(prefers-reduced-motion: reduce)").matches ||
        window.matchMedia("(prefers-reduced-transparency: reduce)").matches
      );
      if (lowMem || reduce) document.documentElement.classList.add("perf-mode");
    }catch(e){}
  })();
  </script>

  <style id="perf-style">
  :root.perf-mode .glass, .perf-mode [data-glass],
  :root.perf-mode .blur,  .perf-mode [data-blur]{
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
  }
  :root.perf-mode [data-blur],
  :root.perf-mode [data-blur]::before{
    filter: none !important;
  }
  :root.perf-mode *{
    transition: none !important;
    animation: none !important;
    box-shadow: none !important;
  }
  </style>

  <!-- 主题/基础样式（保持原风格） -->
  <style>
    :root{
      --brand-light:#2563eb;
      --brand-dark:#0ea5e9;
      --brand: var(--brand-light);
      --brand-600: color-mix(in hsl, var(--brand) 85%, #000);
      --brand-500: var(--brand);
      --brand-400: color-mix(in hsl, var(--brand) 85%, #fff);
      --text:#0f172a; --muted:#64748b; --card:rgba(255,255,255,.78);
      --ring: color-mix(in hsl, var(--brand) 55%, #fff);
      --shadow: 0 10px 30px rgba(17,24,39,.18), 0 4px 14px rgba(17,24,39,.10);
      --radius:16px;
      --page-bg-light:#f6f7fb;
      --page-bg-dark:#0b1220;
        --intro-cover: none; /* 封面默认无 */
        --intro-pos: center; /* 位置默认居中 */

      /* 为 IDE 去告警：声明自定义变量 */
      --intro-cover-image: none;
    }
    @media (prefers-color-scheme: dark){
      :root:not([data-theme-fixed]){ --brand: var(--brand-dark); }
    }
    html[data-theme-fixed="dark"]  body{ background: var(--page-bg-dark);  color:#e5e7eb; }
    html[data-theme-fixed="light"] body{ background: var(--page-bg-light); color:var(--text); }

    .field .ctrl,
    .field .drop,
    .field .chips,
    .field select.ctrl,
    .field textarea.ctrl { width: 100%; box-sizing: border-box; }
    .drop { width: 100%; }

    body{
      margin:0;
      font-family: "Inter", ui-sans-serif, -apple-system, "Microsoft YaHei", system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: var(--page-bg-light);
    }

    .shell{min-height:100svh; display:grid; grid-template-rows:auto 1fr auto;}
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(140%) blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55));
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .brandbar{
      max-width: 960px; margin: 0 auto; padding: 14px 20px;
      display:flex; align-items:center; gap:14px;
    }
    .brandbar .spacer{flex:1}
    .logoDot{ width:14px; height:14px; border-radius:999px; background:var(--brand);
      box-shadow: 0 0 0 6px color-mix(in hsl, var(--brand) 25%, transparent);}
    .title{font-weight: 900; font-size: 18px; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:13px}

    .btn-ghost{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color:var(--text);
      border-radius:10px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .btn-ghost:hover{filter:brightness(1.03)}

    main{ display:grid; place-items:start center; padding:32px 16px 40px }
    .card{
      width:min(960px, 100%);
      background: var(--card);
      backdrop-filter: blur(16px) saturate(130%);
      border: 1px solid rgba(15,23,42,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }
    .hero{
      padding: 28px 26px 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.3));
      border-bottom: 1px solid rgba(15,23,42,.06);
    }
    .hero h1{
      margin:0 0 10px 0; font-size: clamp(20px, 2.4vw, 28px); font-weight: 900;
      letter-spacing:.2px;
    }
    .desc{ color: var(--muted); line-height: 1.7; font-size: 14.5px }

    form{ padding: 20px 26px 26px; }

    .grid{ display:grid; gap:18px; }
    .field{ display:block; }

    .qtitle{ font-weight: 800; font-size: 16px; margin: 4px 2px 8px; letter-spacing:.2px; }
    .qtitle .req{ color:#dc2626; margin-left:.25em }

    .ctrl{
      width:100%;
      background:#fff;
      border:1.2px solid rgba(15,23,42,.12);
      padding: 14px;
      border-radius: 12px;
      font-size: 15px;
      outline: none;
      transition: .18s border, .18s box-shadow, .18s transform, .18s background;
    }
    .ctrl:hover{ border-color: rgba(15,23,42,.22); }
    .ctrl:focus{
      border-color: var(--brand-400);
      box-shadow: 0 0 0 6px color-mix(in hsl, var(--brand) 18%, transparent);
    }
    textarea.ctrl{ min-height: 120px; resize: vertical; }

    select.ctrl{ appearance:none; background-image:
      linear-gradient(45deg, transparent 50%, var(--muted) 50%),
      linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 18px) 50%, calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px; background-repeat: no-repeat;
    }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      position:relative; display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff; cursor:pointer; user-select:none;
      transition:.18s transform, .18s border, .18s box-shadow, .18s background;
    }
    .chip:hover{ transform: translateY(-1px); border-color: rgba(15,23,42,.2); }
    .chip input{ position:absolute; inset:0; opacity:0; }
    .chip[data-checked="1"]{
      border-color: var(--brand-400);
      box-shadow: 0 6px 16px color-mix(in hsl, var(--brand) 20%, transparent);
      background: linear-gradient(180deg, #fff, color-mix(in hsl, var(--brand) 9%, #fff));
    }
    .dot{ width:10px; height:10px; border-radius:999px; background: rgba(15,23,42,.16); }
    .chip[data-checked="1"] .dot{ background: var(--brand); }

    .drop{
      border: 1.2px dashed rgba(15,23,42,.22);
      background: #fff;
      border-radius: 12px;
      padding: 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      transition:.18s border, .18s box-shadow, .18s background;
    }
    .drop .meta{ color:var(--muted); font-size: 14px }

    .btn{
      display:inline-flex; align-items:center; gap:8px; justify-content:center;
      border:0; cursor:pointer; user-select:none;
      padding: 12px 18px; border-radius: 12px; font-weight: 800; letter-spacing:.2px;
      background: linear-gradient(180deg, var(--brand-500), color-mix(in hsl, var(--brand) 92%, #000));
      color:#fff; box-shadow: 0 10px 20px color-mix(in hsl, var(--brand) 25%, transparent);
      transition: .18s transform, .18s filter, .18s box-shadow;
    }
    .btn:hover{ filter: brightness(1.02); transform: translateY(-1px); }

    .hint{ font-size: 12.5px; color: var(--muted); padding-top:6px }
    .actions{ display:flex; gap:10px; padding-top: 8px }

    footer{ padding: 24px 16px 30px; text-align:center; color: #6b7280; font-size: 13px; }

    .qimg{ margin:8px 2px 10px; }
    .qimg img{
      max-width:min(640px, 100%);
      border-radius:10px;
      border:1px solid rgba(15,23,42,.08);
      display:block;
    }

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50;padding:16px}
    .modal.show{display:flex}
    .modal .box{background:#fff;width:min(520px,100%);border-radius:14px;box-shadow:var(--shadow);padding:16px;border:1px solid rgba(15,23,42,.10)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px}
    .pill.good{background:#dcfce7;color:#15803d}
    .pill.bad{background:#fee2e2;color:#b91c1c}
    .pill.wait{background:#e5e7eb;color:#111827}
  </style>

  <!-- 亮/暗背景（保持原效果） -->
  <style id="page-bg-override">
    html, body { height: 100%; }
    body:not([data-appearance="dark"]) {
      background:
        radial-gradient(1000px 780px at 8% 85%, rgba(234, 242, 255, .60) 0%, rgba(234, 242, 255, 0) 60%),
        radial-gradient(760px 540px at 96% 0%,  rgba(255, 224, 210, .38) 0%, rgba(255, 224, 210, 0) 58%),
        linear-gradient(180deg, #FFF2EB 0%, #FFFFFF 46%, #F6F8FC 100%) !important;
      background-attachment: fixed, fixed, fixed;
      background-repeat: no-repeat;
      background-color: #FFFFFF;
      color: #0e1726;
    }
  </style>

  <style id="dark-bg-override">
    body[data-appearance="dark"] {
      --bg-1: #0b0b0c;
      --bg-2: color-mix(in srgb, var(--brand) 24%, #0a0a0a);
      background: linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%) !important;
      background-attachment: fixed !important;
      background-repeat: no-repeat !important;
    }
  </style>
    <style id="intro-card">
        .form-intro {
            position: relative;
            margin: 0; /* 让它紧贴容器左侧 */
            padding: 20px 24px 14px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(17, 24, 39, .08), 0 4px 14px rgba(17, 24, 39, .06);
        }

        body[data-appearance="dark"] .form-intro {
            background: rgba(17, 24, 39, .65);
        }

        .form-title {
            margin: 0 0 6px 0;
            font-size: 28px;
            line-height: 1.25;
            font-weight: 800;
            text-align: left;
        }

        .form-desc {
            margin: 0;
            color: #6b7280;
            text-align: left;
        }

        .form-sep {
            height: 1px;
            background: rgba(0, 0, 0, .06);
            border-radius: 999px;
            margin: 14px 0 18px;
        }

        body[data-appearance="dark"] .form-sep {
            background: rgba(255, 255, 255, .10);
        }
    </style>
    <style id="intro-card-override">
        /* 让标题区回到“左对齐 + 白色卡片”样式，并且压过任何旧样式 */
        main .form-intro {
            display: block !important;
            margin: 0 !important; /* 靠左 */
            padding: 20px 24px 14px !important;
            background: #fff !important; /* 白底卡片 */
            border-radius: 16px !important;
            box-shadow: 0 10px 30px rgba(17, 24, 39, .08), 0 4px 14px rgba(17, 24, 39, .06) !important;
        }

        body[data-appearance="dark"] main .form-intro {
            background: rgba(17, 24, 39, .65) !important;
        }

        /* 标题与描述强制左对齐（有旧样式居中时用 !important 压过去） */
        main .form-intro .form-title {
            margin: 0 0 6px 0 !important;
            font-size: 28px !important;
            line-height: 1.25 !important;
            font-weight: 800 !important;
            text-align: left !important;
        }

        main .form-intro .form-desc {
            margin: 0 !important;
            color: #6b7280 !important;
            text-align: left !important;
        }

        /* 标题区与第一题之间的分割线 */
        main .form-sep {
            height: 1px !important;
            background: rgba(0, 0, 0, .06) !important;
            border-radius: 999px !important;
            margin: 14px 0 18px !important;
        }

        body[data-appearance="dark"] main .form-sep {
            background: rgba(255, 255, 255, .10) !important;
        }
    </style>
    <style id="intro-align">
        /* 根据你下面那张表单卡片的宽度来设置。若你下方卡片是 960px，这里保持一致即可 */
        :root {
            --form-width: 960px;
        }

        /* 不一致就把 960 改成你实际的 */

        main .form-intro,
        main .form-sep {
            max-width: var(--form-width);
            margin-left: auto;
            margin-right: auto; /* 居中对齐容器 */
            width: 100%;
        }

        /* 标题卡片保持左对齐、白色卡片风格（与下方一致） */
        main .form-intro {
            display: block !important;
            padding: 20px 24px 14px !important;
            background: #fff !important;
            border-radius: 16px !important;
            box-shadow: 0 10px 30px rgba(17, 24, 39, .08), 0 4px 14px rgba(17, 24, 39, .06) !important;
            text-align: left !important;
        }

        /* 避免被其他样式拉成居中/小块 */
        main .form-intro .form-title,
        main .form-intro .form-desc {
            text-align: left !important;
        }
    </style>
    <style id="equal-form-width">
        :root {
            --form-width: 910px;
        }

        /* 按你要的宽度改数字 */
        .form-intro, .form-sep, .form-intro + .card, .form-sep + .card {
            box-sizing: border-box;
            max-width: var(--form-width) !important;
            width: 100% !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
    </style>
    <style id="card-width-sync">
        /* 让真正装题目的卡片也使用统一宽度变量 */
        .card {
            max-width: var(--form-width) !important;
            margin-left: auto !important;
            margin-right: auto !important;
            width: 100% !important;
        }
    </style>


</head>

<body>
  <div class="shell">
    <header>
      <div class="brandbar">
        <div class="logoDot" aria-hidden="true"></div>
        <div class="title">{{ form_title or site_name }}</div>
        <div class="sub">在线表单</div>
        <div class="spacer"></div>
        <button class="btn-ghost" id="btnCheck" type="button">查看状态</button>
        <button class="btn-ghost" id="btnTheme" type="button" title="切换亮/暗">🌗</button>
        <div class="actions">
          <button class="btn" type="button" id="btnDraft">保存</button>
          <button class="btn" type="submit" form="xForm">提交表单</button>
        </div>
      </div>
    </header>

    <!-- ② 新增：把 标题+描述 放进 <main>，并把表单卡片也放进来 -->
    <main>
        <!-- 封面图样式（只对有封面时生效） -->
        <style>
            .form-intro.has-cover {
                position: relative;
                overflow: hidden;
                border-radius: 18px;
            }

            .form-intro.has-cover::before {
                content: "";
                position: absolute;
                inset: 0;
                background-image: var(--intro-cover);
                background-size: cover;
                background-position: center;
                opacity: .22; /* 亮色下透明度，可按需微调 */
                background-position: var(--intro-pos, center), var(--intro-pos, center);
            }

            body[data-appearance="dark"] .form-intro.has-cover::before {
                opacity: .28;
            }

            .form-intro.has-cover > * {
                position: relative;
                z-index: 1;
            }
        </style>

        <section class="form-intro {% if header_image %}has-cover{% endif %}"
         style="{% if header_image %}--intro-cover:url('{{ header_image }}'); --intro-pos: {{ header_image_pos or 'center' }};{% endif %}">
        <h1 class="form-title">{{ form_title or form_name }}</h1>
            {% if form_desc %}<p class="form-desc">{{ form_desc|safe }}</p>{% endif %}
            <div class="form-sep"></div>
        </section>

        <div class="form-sep"></div>
        <!-- 仅保留“表单卡片”（③ 已删除原“第一张卡片：标题+描述”） -->
      <div class="card">
        <div class="hero">
          <div style="color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:10px;padding:10px 12px;margin:10px 2px 6px;font-size:13px">
            <span style="color:#dc2626">*</span> 表示必填
          </div>
        </div>

        <form method="post" {% if has_file %}enctype="multipart/form-data"{% endif %} id="xForm">
          <div class="grid" id="fieldGrid">
            {% for f in fields %}
            {% set _title  = f.labelHTML or f.label or f.title or f.name or f.question or f.text or f.placeholder or f.key or f.id %}
            {% set L_html  = _title %}
            {% set L_plain = (_title)|striptags %}
            {% set P = f.image or f.img or f.src or f.picture or f.get('图片') or f.get('照片') %}
            {% set input_name = f.key or f.id %}

            <div class="field" data-type="{{ f.type or 'text' }}" data-key="{{ input_name }}">
              <div class="qtitle">
                {{ L_html|safe }}{% if f.required %}<span class="req">*</span>{% endif %}
              </div>

              {% if P %}<figure class="qimg"><img src="{{ P }}" alt=""></figure>{% endif %}

              {% if f.type in ['text','email','number','date','time'] %}
                <input class="ctrl" type="{{ f.type }}" name="{{ input_name }}" aria-label="{{ L_plain }}"
                       placeholder="您的回答" {% if f.required %}required{% endif %}>

              {% elif f.type == 'textarea' %}
                <textarea class="ctrl" name="{{ input_name }}" aria-label="{{ L_plain }}" placeholder="您的回答" {% if f.required %}required{% endif %}></textarea>

              {% elif f.type in ['radio','checkbox'] %}
                <div class="chips" role="group" aria-label="{{ L_plain }}">
                  {% for opt in f.options or [] %}
                  <label class="chip" data-chip>
                    <span class="dot" aria-hidden="true"></span>
                    <span>{{ opt }}</span>
                    <input type="{{ 'radio' if f.type == 'radio' else 'checkbox' }}"
                           name="{{ input_name }}{% if f.type=='checkbox' %}[]{% endif %}"
                           value="{{ opt }}"
                           {% if f.required and loop.first and f.type=='radio' %}required{% endif %}>
                  </label>
                  {% endfor %}
                </div>

              {% elif f.type == 'select' %}
                <select class="ctrl" name="{{ input_name }}" aria-label="{{ L_plain }}" {% if f.required %}required{% endif %}>
                  {% if f.required %}<option value="" disabled selected>请选择</option>{% endif %}
                  {% for opt in f.options or [] %}
                  <option value="{{ opt }}">{{ opt }}</option>
                  {% endfor %}
                </select>

              {% elif f.type == 'file' %}
                <div class="drop" data-dropzone data-max="{{ upload_max_files|default(3) }}" aria-label="{{ L_plain }}">
                  <div class="meta">
                    <div class="hint">拖拽到此处或点击右侧按钮选择文件（最多 {{ upload_max_files|default(3) }} 个）</div>
                  </div>
                  <div>
                    <label class="btn">
                      选择文件
                      <input type="file"
                             name="{{ input_name }}"
                             {% if (upload_max_files|default(3))|int > 1 %}multiple{% endif %}
                             style="display:none"
                             {% if f.required %}required{% endif %}>
                    </label>
                  </div>
                </div>
                <div class="hint" data-file-hint></div>
                <div class="preview" data-file-preview></div>

              {% else %}
                <input class="ctrl" type="text" name="{{ input_name }}" aria-label="{{ L_plain }}" placeholder="您的回答"
                       {% if f.required %}required{% endif %}>
              {% endif %}
            </div>
            {% endfor %}
          </div>

          <div id="uploadedHidden" hidden></div>

          <div class="actions">
            <button class="btn" type="submit">提交表单</button>
          </div>
        </form>
      </div>
    </main>

    <footer>Powered by 通用表单平台</footer>
  </div><!-- /.shell -->

  <!-- 状态弹窗（放在 body 末尾） -->
  <div class="modal" id="statusModal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <strong>查看审核状态</strong>
        <button class="btn-ghost" id="closeStatus">关闭</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <input id="statusName" class="ctrl" placeholder="请输入姓名">
        <button class="btn" id="goQuery" type="button">查看</button>
      </div>
      <div id="statusResult" style="font-size:14px;color:#111"></div>
    </div>
  </div>
  <!-- 逻辑脚本（结构保持，补全花括号/try-catch） -->
  <script>
  // 打开/关闭状态弹窗
  (function(){
    const btnCheck = document.getElementById('btnCheck');
    const modal = document.getElementById('statusModal');
    const closeStatus = document.getElementById('closeStatus');
    const goQuery = document.getElementById('goQuery');
    const statusName = document.getElementById('statusName');
    const statusResult = document.getElementById('statusResult');

    btnCheck?.addEventListener('click', ()=>{ modal.classList.add('show'); statusName.focus(); });
    closeStatus?.addEventListener('click', ()=> modal.classList.remove('show'));
    modal?.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('show'); });

    async function doQuery(){
      const name = (statusName.value||'').trim();
      if(!name){ statusResult.innerHTML='<span style="color:#b91c1c">请输入姓名</span>'; return; }
      statusResult.textContent='查询中…';
      try{
        const res = await fetch('/site/{{ site_name }}/status_query?name='+encodeURIComponent(name));
        const j = await res.json();
        if(!res.ok || !j.ok){ statusResult.innerHTML='查询失败：'+(j.error||res.status); return; }
        if(!j.found){ statusResult.innerHTML='没有找到相关记录'; return; }
        let pill = '<span class="pill wait">待审核</span>';
        if(j.status==='已通过') pill='<span class="pill good">已通过</span>';
        else if(j.status==='未通过') pill='<span class="pill bad">未通过</span>';
        const cmt = j.review_comment ? ('<div style="margin-top:6px;color:#374151">说明：'+j.review_comment+'</div>') : '';
        const when = j.created_at ? ('<div class="hint" style="margin-top:6px">提交时间：'+j.created_at+'</div>') : '';
        statusResult.innerHTML = '<div>最新状态：'+pill+'</div>'+cmt+when;
      }catch(e){
        statusResult.innerHTML='查询失败';
      }
    }
    goQuery?.addEventListener('click', doQuery);
    statusName?.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doQuery(); } });
  })();
  </script>

  <script>
  // 主题与品牌色同步
  (function(){
    const root = document.documentElement;
    const MODE = "{{ theme_mode or 'auto' }}";
    const BRAND_LIGHT = "{{ brand_light }}";
    const BRAND_DARK  = "{{ brand_dark }}";

    if (BRAND_LIGHT) root.style.setProperty('--brand-light', BRAND_LIGHT);
    if (BRAND_DARK)  root.style.setProperty('--brand-dark',  BRAND_DARK);

    if (MODE === 'dark') {
      root.style.setProperty('--brand', 'var(--brand-dark)');
      root.setAttribute('data-theme-fixed', 'dark');
    } else if (MODE === 'light') {
      root.style.setProperty('--brand', 'var(--brand-light)');
      root.setAttribute('data-theme-fixed', 'light');
    } else {
      root.removeAttribute('data-theme-fixed');
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('appearance') === 'dark') {
        document.body.setAttribute('data-appearance','dark');
        return;
      }
      if (localStorage.getItem('appearance') === 'light') {
        document.body.setAttribute('data-appearance','light');
        return;
      }
      if (MODE === 'dark') document.body.setAttribute('data-appearance','dark');
      else if (MODE === 'light') document.body.setAttribute('data-appearance','light');
      else document.body.removeAttribute('data-appearance');
    });
  })();
  </script>

  <script>
  // Chips 选中态
  (function(){
    document.querySelectorAll('[data-chip]').forEach(ch=>{
      const inp = ch.querySelector('input');
      const refresh = ()=>{
        if (inp.type==='radio') {
          document.querySelectorAll('input[name="'+inp.name+'"]').forEach(i=>{
            i.closest('[data-chip]')?.setAttribute('data-checked', i.checked? '1':'0');
          });
        } else {
          ch.setAttribute('data-checked', inp.checked? '1':'0');
        }
      };
      inp.addEventListener('change', refresh);
      refresh();
    });
  })();
  </script>

  <script>
  // IndexedDB 持久化 + 文件选择/预览/合并
  (function () {
    const PF_IDB = (() => {
      const DB = 'pubform_files_v1', STORE = 'files';
      function open() {
        return new Promise((res, rej) => {
          const r = indexedDB.open(DB, 1);
          r.onupgradeneeded = () => {
            const db = r.result;
            if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
          };
          r.onsuccess = () => res(r.result);
          r.onerror = () => rej(r.error);
        });
      }
      async function set(key, value) {
        const db = await open();
        return new Promise((res, rej) => {
          const tx = db.transaction(STORE, 'readwrite');
          tx.objectStore(STORE).put(value, key);
          tx.oncomplete = () => res();
          tx.onerror = () => rej(tx.error);
        });
      }
      async function get(key) {
        const db = await open();
        return new Promise((res, rej) => {
          const tx = db.transaction(STORE, 'readonly');
          const req = tx.objectStore(STORE).get(key);
          req.onsuccess = () => res(req.result);
          req.onerror = () => rej(req.error);
        });
      }
      async function del(key) {
        const db = await open();
        return new Promise((res, rej) => {
          const tx = db.transaction(STORE, 'readwrite');
          tx.objectStore(STORE).delete(key);
          tx.oncomplete = () => res();
          tx.onerror = () => rej(tx.error);
        });
      }
      return {set, get, del};
    })();

    const SITE = "{{ site_name }}";
    const form = document.getElementById('xForm');
    if (!form) return;

    const ZONES = [];
    function uniqKey(f) { return [f.name, f.size, f.lastModified].join('#'); }
    function toFile(meta) {
      return new File([meta.blob], meta.name, {type: meta.type, lastModified: meta.lastModified});
    }
    function toMeta(f) {
      return new Promise(res => {
        const fr = new FileReader();
        fr.onload = () => res({
          name: f.name, type: f.type, lastModified: f.lastModified,
          blob: new Blob([fr.result], {type: f.type}), size: f.size
        });
        fr.readAsArrayBuffer(f);
      });
    }
    async function persist(fieldKey, files) {
      const metas = [];
      for (const f of files) metas.push(await toMeta(f));
      await PF_IDB.set(`F::${SITE}::${fieldKey}`, metas);
    }
    async function restore(fieldKey) {
      const metas = await PF_IDB.get(`F::${SITE}::${fieldKey}`) || [];
      return metas.map(toFile);
    }
    async function clear(fieldKey) { await PF_IDB.del(`F::${SITE}::${fieldKey}`); }

    function renderPreview(zone, files) {
      const field = zone.closest('.field');
      const hint = field?.querySelector('[data-file-hint]');
      const preview = field?.querySelector('[data-file-preview]');
      if (hint) {
        hint.textContent = files.length ? `已选择 ${files.length}/${zone.MAX}：` + files.map(f => f.name).join('、') : '';
      }
      if (!preview) return;
      preview.innerHTML = '';
      if (!files.length) { preview.classList.remove('show'); return; }
      preview.classList.add('show');

      files.forEach((f, idx) => {
        const item = document.createElement('div');
        item.className = 'item';
        const title = document.createElement('div');
        title.className = 'name';
        title.textContent = `${f.name}${f.size ? '（' + (f.size / 1024 / 1024).toFixed(2) + ' MB）' : ''}`;
        const rm = document.createElement('button');
        rm.className = 'rm';
        rm.type = 'button';
        rm.textContent = '×';
        rm.title = '移除该文件';
        rm.addEventListener('click', async () => {
          zone.VFILES.splice(idx, 1);
          await persist(zone.fieldKey, zone.VFILES);
          applyToInput(zone);
          renderPreview(zone, zone.VFILES);
        });

        item.appendChild(title);
        item.appendChild(rm);

        const url = URL.createObjectURL(f);
        const ext = (f.name.split('.').pop() || '').toLowerCase();
        if (f.type.startsWith('image/') || ['png','jpg','jpeg','gif','webp','bmp','svg'].includes(ext)) {
          const img = new Image();
          img.src = url;
          img.onload = () => URL.revokeObjectURL(url);
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          img.style.borderRadius = '8px';
          item.appendChild(img);
        } else if (f.type === 'application/pdf' || f.type.startsWith('text/')) {
          const ifr = document.createElement('iframe');
          ifr.src = url;
          ifr.onload = () => URL.revokeObjectURL(url);
          ifr.style.width = '100%';
          ifr.style.height = '360px';
          item.appendChild(ifr);
        } else if (f.type.startsWith('video/')) {
          const v = document.createElement('video');
          v.src = url;
          v.controls = true;
          v.style.width = '100%';
          v.onloadeddata = () => URL.revokeObjectURL(url);
          item.appendChild(v);
        } else if (f.type.startsWith('audio/')) {
          const a = document.createElement('audio');
          a.src = url;
          a.controls = true;
          a.onloadeddata = () => URL.revokeObjectURL(url);
          item.appendChild(a);
        } else {
          const tip = document.createElement('div');
          tip.className = 'hint';
          tip.textContent = '此文件类型暂不支持在线预览';
          item.appendChild(tip);
        }
        preview.appendChild(item);
      });
    }

    function applyToInput(zone) {
      const dt = new DataTransfer();
      zone.VFILES.slice(0, zone.MAX).forEach(f => dt.items.add(f));
      zone.fileInput.files = dt.files;
    }
    function mergeAdd(zone, incoming) {
      const map = new Map(zone.VFILES.map(f => [uniqKey(f), f]));
      incoming.forEach(f => {
        if (!map.has(uniqKey(f)) && map.size < zone.MAX) map.set(uniqKey(f), f);
      });
      zone.VFILES = Array.from(map.values()).slice(0, zone.MAX);
    }

    document.querySelectorAll('[data-dropzone]').forEach(zone => {
      const fieldEl = zone.closest('.field');
      const fieldKey = fieldEl?.dataset.key || zone.querySelector('input[type=file]')?.name || '';
      const fileInput = zone.querySelector('input[type=file]');
      const MAX = parseInt(zone.getAttribute('data-max') || '3', 10) || 3;

      zone.fieldKey = fieldKey;
      zone.fileInput = fileInput;
      zone.MAX = MAX;
      zone.VFILES = [];

      zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('drag'));
      zone.addEventListener('drop', async e => {
        e.preventDefault();
        zone.classList.remove('drag');
        const incoming = Array.from(e.dataTransfer.files || []);
        if (!incoming.length) return;
        mergeAdd(zone, incoming);
        applyToInput(zone);
        renderPreview(zone, zone.VFILES);
        await persist(fieldKey, zone.VFILES);
      });

      fileInput.addEventListener('change', async e => {
        const incoming = Array.from(e.target.files || []);
        if (!incoming.length) { renderPreview(zone, zone.VFILES); return; }
        mergeAdd(zone, incoming);
        applyToInput(zone);
        renderPreview(zone, zone.VFILES);
        await persist(fieldKey, zone.VFILES);
      });
    });

    (async function restoreAll() {
      const zones = document.querySelectorAll('[data-dropzone]');
      for (const zone of zones) {
        const fieldEl = zone.closest('.field');
        const key = fieldEl?.dataset.key || zone.querySelector('input[type=file]')?.name || '';
        try {
          const files = await restore(key);
          if (files && files.length) {
            const dt = new DataTransfer();
            files.forEach(f => dt.items.add(f));
            const inp = zone.querySelector('input[type=file]');
            inp.files = dt.files;
          }
        } catch (_) {}
      }
    })();
  })();
  </script>

  <script>
  // 草稿保存 & 提交时附带上传 URL 与 token
  (function () {
    const SITE = "{{ site_name }}";
    const form = document.getElementById('xForm');
    const btnDraft = document.getElementById('btnDraft');
    const hiddenBox = document.getElementById('uploadedHidden');
    const DRAFT_TOKEN_LS = `draft_token:${SITE}`;
    let UPLOADED = JSON.parse(localStorage.getItem(`uploaded_urls:${SITE}`) || "{}");
    let DRAFT_TOKEN = localStorage.getItem(DRAFT_TOKEN_LS) || "";

    function setUploadedHidden() {
      if (!hiddenBox) return;
      hiddenBox.innerHTML = "";
      Object.entries(UPLOADED).forEach(([field, urls]) => {
        (urls || []).forEach(u => {
          const inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = `__uploaded__${field}[]`;
          inp.value = u;
          hiddenBox.appendChild(inp);
        });
      });
      if (DRAFT_TOKEN) {
        const t = document.createElement('input');
        t.type = 'hidden';
        t.name = '__draft_token';
        t.value = DRAFT_TOKEN;
        hiddenBox.appendChild(t);
      }
    }
    setUploadedHidden();

    if (btnDraft) {
      btnDraft.addEventListener('click', async () => {
        try{
          // 触发表单当前文件写回
          const zones = document.querySelectorAll('[data-dropzone]');
          zones.forEach(z=>{
            const inp = z.querySelector('input[type=file]');
            inp.dispatchEvent(new Event('change'));
          });

          const fd = new FormData(form);
          Object.entries(UPLOADED).forEach(([field, urls]) => {
            (urls || []).forEach(u => fd.append(`__uploaded__${field}[]`, u));
          });
          if (DRAFT_TOKEN) fd.append('__draft_token', DRAFT_TOKEN);

          const res = await fetch(`/site/${encodeURIComponent(SITE)}/draft/save`, { method: 'POST', body: fd, credentials: 'same-origin' });
          const j = await res.json();
          if (!res.ok || j.ok === false) throw new Error(j.error || res.statusText);

          DRAFT_TOKEN = j.token || DRAFT_TOKEN || "";
          localStorage.setItem(DRAFT_TOKEN_LS, DRAFT_TOKEN);

          const sv = j.files || {};
          Object.keys(sv).forEach(k => {
            const prev = new Set(UPLOADED[k] || []);
            (sv[k] || []).forEach(u => prev.add(u));
            UPLOADED[k] = Array.from(prev);
          });
          localStorage.setItem(`uploaded_urls:${SITE}`, JSON.stringify(UPLOADED));

          alert('草稿已保存（文件已上传到服务器）');
        }catch(e){
          alert('保存失败：' + e.message);
        }
      });
    }

    form?.addEventListener('submit', () => {
      setUploadedHidden();
      localStorage.removeItem(DRAFT_TOKEN_LS);
      localStorage.removeItem(`uploaded_urls:${SITE}`);
    });
  })();
  </script>

  <script>
  // 轻量自动保存/恢复（文本控件）
  (function(){
    const KEY  = "draft:public:" + ("{{ site_name }}"||"__default__");
    const form = document.getElementById('xForm');
    if(!form) return;

    const debounce=(fn,d=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),d);}};
    function serialize(){
      const data={};
      const fd = new FormData(form);
      for (const [k,v] of fd.entries()){
        if (data[k] === undefined) data[k] = v;
        else if (Array.isArray(data[k])) data[k].push(v);
        else data[k] = [data[k], v];
      }
      return data;
    }
    function restore(data){
      if(!data) return;
      for (const [k,v] of Object.entries(data)){
        const els = form.querySelectorAll(`[name="${CSS.escape(k)}"]`);
        if (!els.length) continue;
        const values = Array.isArray(v)? v : [v];
        els.forEach(el=>{
          if (el.type==='checkbox' || el.type==='radio'){
            el.checked = values.includes(el.value);
          }else{
            el.value = values[0];
          }
        });
      }
      toast('已从本地草稿恢复');
    }

    const saveNow = ()=> localStorage.setItem(KEY, JSON.stringify(serialize()));
    const saveDebounced = debounce(saveNow, 250);

    document.addEventListener('input', saveDebounced, true);
    document.addEventListener('change', saveDebounced, true);

    try{
      const raw = localStorage.getItem(KEY);
      if (raw) restore(JSON.parse(raw));
    }catch(e){}

    form.addEventListener('submit', ()=>{ localStorage.removeItem(KEY); }, {once:true});

    function toast(msg){
      let t=document.getElementById('draft-toast');
      if(!t){
        t=document.createElement('div'); t.id='draft-toast';
        t.style.cssText='position:fixed;z-index:2147483647;top:12px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.2)';
        document.body.appendChild(t);
      }
      t.textContent=msg; t.style.opacity='1';
      setTimeout(()=>{ t.style.transition='opacity .6s'; t.style.opacity='0'; }, 1600);
    }
  })();
  </script>

  <!-- 杂项优化 -->
  <script>
  (function(){
    try{
      document.addEventListener("DOMContentLoaded", function(){
        document.querySelectorAll('img:not([loading])')
          .forEach(function(img){ img.setAttribute('loading','lazy'); });
      }, {passive:true});
      document.querySelectorAll('script[src]:not([type="module"]):not([defer])')
        .forEach(function(s){ s.setAttribute('defer',''); });
    }catch(e){}
  })();
  </script>

  <style id="kill-transitions-public">
    html.no-anim *, html.no-anim *::before, html.no-anim *::after {
      transition: none !important;
      animation: none !important;
      scroll-behavior: auto !important;
    }
  </style>
  {% if schema_json %}
  <script id="schemaJSON" type="application/json+jinja">{{ schema_json|safe }}</script>
  {% endif %}



  <style>
      /* 标题区 = 纯文本，不要中间那块“白色小卡” */
      /* 只有“没有封面”时才清掉背景/阴影 */
      .form-intro:not(.has-cover) {
          padding: 16px 0 8px;
          background: none;
          box-shadow: none;
          border-radius: 0;
      }


      .form-intro:not(.has-cover)::before,
      .form-intro:not(.has-cover)::after { content: none !important; }


      /* 左对齐的标题和描述 */
      .form-title {
          margin: 0 0 4px 0;
          font-size: 28px;
          line-height: 1.25;
          font-weight: 800;
      }

      .form-desc {
          margin: 0;
          color: #6b7280; /* 灰色描述 */
      }

      /* 细分割线 */
      .form-sep {
          height: 1px;
          background: rgba(0, 0, 0, .06);
          border-radius: 999px;
          margin: 14px 0 18px;
      }

      /* 暗色模式下的分割线微调，可选 */
      body[data-appearance="dark"] .form-sep {
          background: rgba(255, 255, 255, .10);
      }
  </style>

  <style id="public-intro-cover">
      .form-intro.has-cover {
          position: relative;
          overflow: hidden;
          border-radius: 16px;
      }

      .form-intro.has-cover::before {
          background-image: linear-gradient(180deg, rgba(255, 255, 255, .78), rgba(255, 255, 255, .70)),
          var(--intro-cover, none);
          background-size: cover, cover;
          background-position: var(--intro-pos, center), var(--intro-pos, center);
      }

      body[data-appearance="dark"] .form-intro.has-cover::before {
          background-image: linear-gradient(180deg, rgba(11, 18, 32, .46), rgba(11, 18, 32, .46)),
          var(--intro-cover, none);
          background-size: cover, cover;
          background-position: var(--intro-pos, center), var(--intro-pos, center);
      }


      .form-intro.has-cover > * {
          position: relative;
          z-index: 1;
      }
  </style>
<script>
(function () {
  let j = null;
  try {
    j = window.__SCHEMA__ || JSON.parse(document.getElementById('schemaJSON')?.textContent || 'null');
  } catch(_) {}

  // 更健壮的取图路径（多处兜底）
  const cover =
    j?.header?.title_image ||
    j?.display?.title_image ||
    j?.display?.cover_image ||
    j?.title_image ||
    j?.cover_image ||
    '';

  const pos = j?.header?.title_image_pos || j?.display?.title_image_pos || 'center';

  const intro = document.querySelector('.form-intro');
  if (!intro) return;

  if (cover) {
    // ✅ 关键：给 CSS 变量赋值，而不是 backgroundImage
    intro.style.setProperty('--intro-cover', `url("${cover.replace(/"/g, '\\"')}")`);
    intro.style.setProperty('--intro-pos', pos);
    intro.classList.add('has-cover');
  } else {
    intro.style.removeProperty('--intro-cover');
    intro.classList.remove('has-cover');
  }
})();
</script>

<input type="hidden" id="schema_json" value='{{ schema_json|tojson }}'>
<style id="pub-cover">
  :root{ --title-pos-x:50%; --title-pos-y:50%; --title-cover-opacity:.72; --title-cover-img:none; }

  /* 你公开页标题容器的类名，如果是别的（比如 .form-header），把 .form-intro 改成你的 */
  .form-intro.has-cover{
    position:relative;
    background-image: var(--title-cover-img);
    background-size: cover;
    background-position: var(--title-pos-x) var(--title-pos-y);
  }
  .form-intro.has-cover::before{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: linear-gradient(180deg,
      rgba(255,255,255,var(--title-cover-opacity)),
      rgba(255,255,255,var(--title-cover-opacity)));
  }
  body[data-appearance="dark"] .form-intro.has-cover::before{
    background: linear-gradient(180deg,
      rgba(11,18,32,calc(var(--title-cover-opacity)*.9)),
      rgba(11,18,32,calc(var(--title-cover-opacity)*1)));
  }
</style>

<script id="pub-cover-init">
(function(){
  function readSchema(){
    try{
      const el=document.getElementById('schema_json');
      const raw=el?.value||el?.getAttribute('value')||'';
      return JSON.parse(raw||'{}')||{};
    }catch{ return {}; }
  }
  const j=readSchema();
  const img=j?.header?.title_image;
  const pos=(j?.header?.title_image_pos||'').split(/\s+/);
  const op = j?.header?.title_image_opacity;

  if(img){
    document.documentElement.style.setProperty('--title-cover-img', `url("${String(img).replace(/"/g,'\\"')}")`);
    document.querySelector('.form-intro')?.classList.add('has-cover');
  }
  if(pos.length===2){
    const [x,y]=pos.map(s=>parseFloat(String(s).replace('%',''))||50);
    document.documentElement.style.setProperty('--title-pos-x', x+'%');
    document.documentElement.style.setProperty('--title-pos-y', y+'%');
  }
  if(typeof op==='number'){
    document.documentElement.style.setProperty('--title-cover-opacity', String(op));
  }
})();
</script>

</body>
</html>
