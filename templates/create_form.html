<!DOCTYPE html>
<html lang="zh">
<head>
    <style id="kill-greet-bg">
        .greet-card:not(.has-cover) {
            background-image: none;
        }

        .greet-card:not(.has-cover)::before,
        .greet-card:not(.has-cover)::after {
            content: none;
        }
    </style>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
    <title>åˆ›å»ºæ–°è¡¨å•</title>

    <!-- æ—©æœŸå¼€å…³ï¼šé¦–å¸§å†³å®šæ˜¯å¦å¯ç”¨ perf-mode -->
    <script>
        (function () {
            try {
                var lowMem = navigator.deviceMemory && navigator.deviceMemory <= 2;
                var reduce = window.matchMedia && (
                    window.matchMedia("(prefers-reduced-motion: reduce)").matches ||
                    window.matchMedia("(prefers-reduced-transparency: reduce)").matches
                );
                if (lowMem || reduce) document.documentElement.classList.add("perf-mode");
            } catch (e) {
            }
        })();
    </script>

    <style id="perf-style">
        :root.perf-mode .glass, .perf-mode [data-glass],
        :root.perf-mode .blur, .perf-mode [data-blur] {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        /* åŒæ—¶å…³æ‰å…ƒç´ æœ¬èº«ä»¥åŠå®ƒçš„ ::before çš„ filterï¼ˆå¦‚ .bg-glow::beforeï¼‰ */
        :root.perf-mode [data-blur],
        :root.perf-mode [data-blur]::before {
            filter: none !important;
        }

        :root.perf-mode * {
            transition: none !important;
            animation: none !important;
            box-shadow: none !important;
        }

        :root.perf-mode header,
        :root.perf-mode .nav-rail,
        :root.perf-mode .greet-card,
        :root.perf-mode .card,
        :root.perf-mode .modal .box {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        :root.perf-mode .nav-rail::before {
            filter: none !important;
        }

    </style>
    <style>
        /* =====================
           ä¸»é¢˜ä¸ç»ç’ƒé£æ ¼ Token
           ===================== */
        :root {
            /* ç®¡ç†å‘˜åœ¨è®¾ç½®é‡Œé€‰çš„é¢œè‰²ä¼šè¢«è„šæœ¬å†™è¿›è¿™ä¸¤ä¸ªå˜é‡ */
            --brand-light: #2563eb;
            --brand-dark: #0ea5e9;
            /* é¡µé¢å®é™…ä½¿ç”¨çš„ä¸»è‰²ï¼ˆç”±å¤–è§‚æ¨¡å¼å†³å®šï¼‰ */
            --brand: var(--brand-light);

            --text: #e6eef8;
            --muted: #c8d3e0;
            --bg-1: #7b8aa5;
            --bg-2: #8ea3c2;
            --glass: #ffffff30;
            --glass-rail: #ffffff26;
            --glass-solid: #ffffff18;
            --glass-border: #ffffff44;
            --shadow-strong: 0 18px 36px rgba(0, 0, 0, .24), 0 8px 16px rgba(0, 0, 0, .12);
            --shadow-soft: 0 12px 28px rgba(0, 0, 0, .16), 0 6px 12px rgba(0, 0, 0, .08);
            --radius-xl: 22px;
            --radius-lg: 18px;
            --radius-md: 14px;
            --greet-cover-image: none;
            --cover: none;
        }

        body[data-appearance="dark"] {
            color-scheme: dark;
            --text: #e6eef8;
            --muted: #c8d3e0;
            --glass: #0b122040;
            --glass-rail: #0b122033;
            --glass-solid: #0b122028;
            --glass-border: #b8c4d055;
            --bg-1: #2a3a58;
            --bg-2: #1d2a44;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: "Inter", "SF Pro Display", "Microsoft YaHei", ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
            color: var(--text);
            /* åŸæš—è‰²èƒŒæ™¯ï¼ˆä¼šè¢«ä¸‹é¢çš„è¦†ç›–æ®µåœ¨æš—è‰²æ¨¡å¼ä¸‹è¦†ç›–ï¼‰ */
            background: radial-gradient(1200px 800px at 18% -12%, color-mix(in hsl, var(--brand) 28%, #fff) 0%, transparent 60%),
            radial-gradient(900px 600px at 105% -8%, color-mix(in hsl, var(--brand) 18%, #000) 0%, transparent 58%),
            linear-gradient(180deg, var(--bg-1), var(--bg-2));
        }

        /* é¡¶æ ï¼ˆåŠŸèƒ½ä¸å˜ï¼‰ */
        header {
            position: sticky;
            top: 0;
            z-index: 30;
            backdrop-filter: saturate(160%) blur(18px);
            background: linear-gradient(180deg, #00000030, #00000010);
            border-bottom: 1px solid var(--glass-border);
        }

        .bar {
            max-width: 1280px;
            margin: 0 auto;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap
        }

        .brandDot {
            width: 14px;
            height: 14px;
            border-radius: 999px;
            background: var(--brand);
            box-shadow: 0 0 0 8px color-mix(in hsl, var(--brand) 32%, transparent)
        }

        .title {
            font-weight: 900;
            font-size: 18px;
            letter-spacing: .2px
        }

        .grow {
            flex: 1
        }

        .btn {
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 10px 14px;
            cursor: pointer;
            font-weight: 800;
            letter-spacing: .2px;
            background: var(--glass-solid);
            color: var(--text);
            display: inline-flex;
            gap: 8px;
            align-items: center;
            transition: .15s transform, .2s filter;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-soft)
        }

        .btn.icon {
            padding: 10px;
            min-width: 40px;
            justify-content: center
        }

        /* äº®è‰²ä¸»æŒ‰é’®ï¼ˆæ›¿æ¢æ•´æ®µï¼‰ */
        body[data-appearance="light"] .btn.primary {
            background: linear-gradient(180deg,
            color-mix(in hsl, var(--brand) 85%, #000),
            color-mix(in hsl, var(--brand) 65%, #000));
            color: #fff;
            border-color: transparent;
            box-shadow: 0 14px 26px color-mix(in hsl, var(--brand) 22%, transparent);
        }

        /* æš—è‰²ä¸»æŒ‰é’®ï¼ˆæ›¿æ¢æ•´æ®µï¼‰ */
        body[data-appearance="dark"] .btn.primary {
            background: linear-gradient(180deg,
            color-mix(in hsl, var(--brand) 75%, #000),
            color-mix(in hsl, var(--brand) 55%, #000));
            color: #fff;
            border-color: transparent;
            box-shadow: 0 14px 26px color-mix(in hsl, var(--brand) 22%, transparent);
        }


        .btn.gray {
            background: var(--glass);
            color: #fff
        }

        .btn.danger {
            background: #ef4444;
            border-color: #ef4444;
            color: #fff
        }

        .btn:hover {
            filter: brightness(1.05)
        }

        .btn:active {
            transform: translateY(1px)
        }

        .btn input[type=file], .btn input[type=color] {
            display: none
        }

        /* ä¸‰åˆ—å¸ƒå±€ï¼ˆå·¦è½¨ / ä¸­å¿ƒ / å³ä¾§å¿«æ·æ ï¼‰ */
        main {
            max-width: 1280px;
            margin: 24px auto 40px;
            padding: 0 16px;
            display: grid;
            grid-template-columns:92px 1fr 64px;
            gap: 16px;
            align-items: start;
        }

        .canvas {
            min-width: 0
        }

        /* å·¦ä¾§å¼§å½¢å›¾æ ‡è½¨ */
        .nav-rail {
            position: sticky;
            top: 92px;
            height: calc(100dvh - 110px);
            align-self: start;
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 14px 10px;
            background: var(--glass-rail);
            backdrop-filter: blur(18px) saturate(160%);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            box-shadow: var(--shadow-strong);
            overflow: hidden;
        }

        .nav-rail::before {
            content: "";
            position: absolute;
            left: -30px;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, transparent, var(--glass-rail));
            filter: blur(12px);
        }

        .tabs.vertical {
            display: flex;
            flex-direction: column;
            gap: 14px
        }

        .tabs.vertical button {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 18px;
            border: 1px solid var(--glass-border);
            background: linear-gradient(180deg, #ffffff30, #00000012);
            backdrop-filter: blur(16px) saturate(160%);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .55), 0 12px 26px rgba(0, 0, 0, .20);
            color: #fff;
            font-weight: 900;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: .18s;
            /* â˜… æ–°å¢ï¼šè®©æ–‡å­—åœ¨å›¾æ ‡ä¸‹æ–¹ */
            flex-direction: column;
            gap: 6px;
        }

        .tabs.vertical button::after {
            content: "";
            position: absolute;
            inset: 7px;
            border-radius: 14px;
            border: 2px solid color-mix(in hsl, var(--brand) 42%, #ffffff20);
            opacity: .85;
            pointer-events: none;
        }

        .tabs.vertical button.active {
            outline: 2px solid color-mix(in hsl, var(--brand) 50%, transparent);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, .7), 0 18px 36px rgba(0, 0, 0, .26);
            transform: translateY(-1px);
        }

        /* â˜… æ”¹ä¸ºæ˜¾ç¤ºæ ‡ç­¾æ–‡å­—ï¼ˆåŸæ¥æ˜¯ display:noneï¼‰ */
        .tabs.vertical button .lbl {
            display: block;
            font-size: 12px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: .2px;
            opacity: .95;
            user-select: none;
        }

        /* é—®å€™åŒº + èŠ¯ç‰‡è¡Œï¼ˆä¿ç•™ï¼‰ */
        .greet-card {
            background: var(--glass);
            backdrop-filter: blur(18px) saturate(160%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-strong);
            padding: 22px 22px 16px;
            margin-bottom: 14px
        }

        .status-bar {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 10px
        }

        .status-pill {
            font-size: 12px;
            font-weight: 800;
            color: #e9f1ff;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--glass-solid);
            border: 1px solid var(--glass-border)
        }

        .greet-title {
            font-size: 34px;
            line-height: 1.15;
            font-weight: 900;
            margin: 2px 0 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, .15)
        }

        .chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .chip {
            padding: 9px 14px;
            border-radius: 999px;
            border: 1px solid var(--glass-border);
            background: var(--glass);
            font-weight: 800;
            font-size: 13px;
            color: #f5f8ff;
            box-shadow: var(--shadow-soft)
        }

        .chip.add {
            background: var(--glass-solid)
        }

        /* ç½‘æ ¼ï¼ˆé»˜è®¤åŒåˆ—ï¼Œç”¨äºå…¶å®ƒé¡µï¼‰ */
        .dash-grid {
            display: grid;
            grid-template-columns:repeat(2, minmax(0, 1fr));
            gap: 14px
        }

        /* å¡ç‰‡ï¼ˆç»ç’ƒï¼‰ */
        .card {
            background: var(--glass);
            backdrop-filter: blur(18px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-strong);
            overflow: hidden;
            margin: 0
        }

        .card .hd {
            padding: 16px 18px 10px;
            border-bottom: 1px solid var(--glass-border);
            background: linear-gradient(180deg, #ffffff10, #00000000);
        }

        .card .hd h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 900;
            letter-spacing: .2px
        }

        .card .bd {
            padding: 16px 18px
        }

        /* è¾“å…¥ï¼ˆæŸ”å’Œç™½ç»ç’ƒï¼‰ */
        .tiny, .select, textarea {
            width: 100%;
            background: #ffffffe0;
            border: 1px solid #ffffffcc;
            border-radius: 14px;
            padding: 12px 12px;
            font-size: 15px;
            outline: none;
            color: #0e1726;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, .06)
        }

        .tiny:focus, .select:focus, textarea:focus {
            border-color: color-mix(in hsl, var(--brand) 55%, #fff);
            box-shadow: 0 0 0 8px color-mix(in hsl, var(--brand) 18%, transparent)
        }

        /* é—®é¢˜å¡ç‰‡ï¼ˆå¤–è§‚ï¼‰ */
        .qcard {
            border-left: 6px solid var(--brand);
            background: #ffffffee;
            border-radius: 16px;
            padding: 14px;
            margin: 12px 0;
            position: relative;
            border: 1px solid #ffffffcc;
            box-shadow: 0 10px 24px rgba(0, 0, 0, .12)
        }

        .q-row {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .q-title {
            flex: 1;
            background: #ffffff;
            border: 1px solid #e8eef6;
            border-radius: 10px;
            padding: 10px;
            min-height: 42px;
            outline: none
        }

        .q-title[contenteditable="true"]:empty:before {
            content: "é—®é¢˜æ ‡é¢˜";
            color: #8ea3c2
        }

        .q-tools {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .format {
            display: flex;
            gap: 6px;
            margin: 8px 0
        }

        .format .icon {
            border: 1px solid #e8eef6;
            background: #fff;
            border-radius: 10px;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer
        }

        .preview {
            margin: 10px 0;
            color: #6b7f99
        }

        .q-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            border-top: 1px solid #e8eef6;
            margin-top: 10px;
            padding-top: 8px
        }

        .icon-btn {
            border: 1px solid var(--glass-border);
            background: var(--glass-solid);
            color: #fff;
            border-radius: 12px;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-soft)
        }

        .q-image-wrap {
            position: relative;
            display: inline-block;
            margin: 8px 0
        }

        .q-image {
            max-width: 260px;
            border: 1px solid #e8eef6;
            border-radius: 12px;
            display: block
        }

        .q-image-del {
            position: absolute;
            top: 6px;
            right: 6px;
            border: 0;
            border-radius: 999px;
            width: 28px;
            height: 28px;
            line-height: 28px;
            background: rgba(0, 0, 0, .68);
            color: #fff;
            cursor: pointer
        }

        /* è¡¨æ ¼ */
        .table-wrap {
            width: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fffffff0;
            min-width: 1100px;
            border-radius: 14px;
            overflow: hidden
        }

        th, td {
            border: 1px solid #e8eef6;
            padding: 10px;
            text-align: center;
            font-size: 14px;
            white-space: nowrap;
            color: #0e1726
        }

        th {
            background: #f3f6fb
        }

        .pill {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 12px
        }

        .pill.good {
            background: #dcfce7;
            color: #15803d
        }

        .pill.bad {
            background: #fee2e2;
            color: #b91c1c
        }

        .pill.wait {
            background: #e5e7eb;
            color: #111827
        }

        /* å³ä¾§å¿«æ·æ  */
        .rail {
            position: sticky;
            top: 92px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            height: fit-content
        }

        .rail .icon-btn {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft)
        }

        /* æ¨¡æ€ä¸ Toastï¼ˆä¿æŒé€»è¾‘ï¼‰ */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 60
        }

        .modal.show {
            display: flex;
        }

        .modal .box {
            background: #fffffffa;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow: auto;
            border-radius: 20px;
            box-shadow: var(--shadow-strong);
            padding: 18px;
            border: 1px solid #e8eef6;
            color: #0e1726
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        /* æ”¾åˆ°ä½ çš„å…¨å±€æ ·å¼é‡Œï¼Œæˆ–ç”¨ <style id="toast-style"> æ³¨å…¥ */
        #toast {
            position: fixed;
            top: 14px;
            left: 50%;
            transform: translateX(-50%) translateY(-6px);
            z-index: 100000; /* â¬… æ¯” #linkModal(9999) é«˜ */
            pointer-events: none; /* ä¸å½±å“é¡µé¢ç‚¹å‡» */
            background: rgba(17, 24, 39, .92);
            color: #fff;
            padding: 10px 14px;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
            opacity: 0;
            transition: opacity .18s ease, transform .18s ease;
            font-weight: 600;
        }

        #toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* è®¾ç½®é¢æ¿ï¼ˆå®¹å™¨ï¼‰ */
        .grid {
            display: grid;
            gap: 12px
        }

        @media (min-width: 960px) {
            .grid.cols-2 {
                grid-template-columns:1fr 1fr
            }
        }

        .gcard {
            background: #ffffffee;
            border: 1px solid #e8eef6;
            border-radius: 16px;
            padding: 14px;
            color: #0e1726
        }

        .gcard h3 {
            margin: 0 0 8px 0;
            font-size: 15px
        }

        .row2 {
            display: grid;
            grid-template-columns:1fr 1fr;
            gap: 10px
        }

        .switch {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #0e1726
        }

        .switch input {
            appearance: none;
            width: 48px;
            height: 28px;
            border-radius: 999px;
            background: #e5e7eb;
            position: relative;
            outline: none;
            cursor: pointer;
            transition: .2s
        }

        .switch input:checked {
            background: var(--brand)
        }

        .switch input::after {
            content: "";
            position: absolute;
            left: 3px;
            top: 3px;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: #fff;
            transition: .2s
        }

        .switch input:checked::after {
            left: 23px
        }

        .hint {
            font-size: 12px;
            color: #6b7f99
        }

        /* Tab æ˜¾éšï¼ˆåªæ˜¾ç¤ºå½“å‰ï¼‰ */
        .tab {
            display: none
        }

        .tab.active {
            display: block
        }

        /* å“åº”å¼ï¼šå°å±å›è½å•åˆ— */
        @media (max-width: 1024px) {
            main {
                grid-template-columns:1fr
            }

            .nav-rail {
                position: static;
                height: auto
            }

            .greet-title {
                font-size: 28px
            }
        }
    </style>

    <style id="basic-card-glass">
        /* åˆ›å»ºé¡µï¼šè®©â€œè¡¨å•åŸºæœ¬ä¿¡æ¯â€å¡ç‰‡æœ‰åŠé€æ˜ç»ç’ƒæ„Ÿ */
        .form-basic {
            position: relative;
            overflow: hidden;
        }

        .form-basic.has-cover::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, .68), rgba(255, 255, 255, .72));
            pointer-events: none;
        }

        body[data-appearance="dark"] .form-basic.has-cover::after {
            background: linear-gradient(180deg, rgba(17, 24, 39, .42), rgba(17, 24, 39, .56));
        }

        .form-basic > * {
            position: relative;
            z-index: 1;
        }
    </style>

    <!-- åªè¦†ç›–â€œé—®é¢˜â€é¡µä¸ºå•åˆ—é€šæ çš„æœ€å°æ”¹åŠ¨ -->
    <style id="layout-override">
        #tab-questions .dash-grid {
            grid-template-columns: 1fr !important; /* å•åˆ— */
            gap: 14px;
        }

        #tab-questions .dash-grid > .card {
            grid-column: 1 / -1 !important; /* é€šæ  */
            width: 100% !important;
            max-width: none !important;
        }
    </style>

    <!-- â˜… äº®è‰²å¤–è§‚çš„æµ…æš–èƒŒæ™¯ -->
    <style id="page-bg-override">
        html, body {
            height: 100%;
        }

        body:not([data-appearance="dark"]) {
            background: radial-gradient(1000px 780px at 8% 85%, rgba(234, 242, 255, .60) 0%, rgba(234, 242, 255, 0) 60%),
            radial-gradient(760px 540px at 96% 0%, rgba(255, 224, 210, .38) 0%, rgba(255, 224, 210, 0) 58%),
            linear-gradient(180deg, #FFF2EB 0%, #FFFFFF 46%, #F6F8FC 100%) !important;
            background-attachment: fixed, fixed, fixed;
            background-repeat: no-repeat;
            background-color: #FFFFFF;
            color: #0e1726;
        }
    </style>

    <style id="dark-melo-palette">
        body[data-appearance="dark"] {
            --text-dark: #F2F5F7;
            --muted-dark: #B9C2CF;
            --brand: #FF6A2A;
            --accent-red: #E63B3B;
            --bg-1: #151515;
            --bg-2: #0F0F0F;
            --glass: rgba(255, 255, 255, .06);
            --glass-rail: rgba(255, 255, 255, .05);
            --glass-solid: rgba(255, 255, 255, .08);
            --glass-border: rgba(255, 255, 255, .12);
        }

        .accent-red {
            color: var(--accent-red) !important;
        }

        @media (prefers-reduced-motion: no-preference) {
            html.theme-anim body[data-appearance="dark"],
            html.theme-anim body[data-appearance="dark"] .btn.primary,
            html.theme-anim body[data-appearance="dark"] .nav-rail,
            html.theme-anim body[data-appearance="dark"] .card,
            html.theme-anim body[data-appearance="dark"] .gcard {
                transition: background-color .28s ease, box-shadow .28s ease, border-color .28s ease, color .28s ease;
            }
        }
    </style>

    <!-- â˜…â˜…â˜… æš—è‰²èƒŒæ™¯ï¼šé»‘è‰² â†’ æš—æ©™ æ¸å˜ â˜…â˜…â˜… -->
    <style id="dark-bg-override">
        body[data-appearance="dark"] {
            --bg-1: #0b0b0c;
            --bg-2: color-mix(in srgb, var(--brand) 24%, #0a0a0a);
            background: linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%) !important;
            background-attachment: fixed !important;
            background-repeat: no-repeat !important;
        }
    </style>
    <!-- â˜…â˜…â˜… ç»“æŸ â˜…â˜…â˜… -->

    <style id="theme-button-text-fix">
        body[data-appearance="light"] .btn,
        body[data-appearance="light"] .btn.gray,
        body[data-appearance="light"] .btn.icon,
        body[data-appearance="light"] .icon-btn,
        body[data-appearance="light"] .tabs.vertical button,
        body[data-appearance="light"] .tabs.vertical button .lbl,
        body[data-appearance="light"] .switch span,
        body[data-appearance="light"] .status-pill,
        body[data-appearance="light"] .chip {
            color: var(--text-light) !important; /* #0e1726 */
        }

        :root {
            --text-light: #0e1726;
        }

        body[data-appearance="dark"] .btn,
        body[data-appearance="dark"] .btn.gray,
        body[data-appearance="dark"] .btn.icon,
        body[data-appearance="dark"] .icon-btn,
        body[data-appearance="dark"] .tabs.vertical button,
        body[data-appearance="dark"] .tabs.vertical button .lbl,
        body[data-appearance="dark"] .switch span,
        body[data-appearance="dark"] .status-pill,
        body[data-appearance="dark"] .chip {
            color: #F2F5F7 !important; /* #F2F5F7 */
        }

        .btn.primary {
            color: #fff !important;
        }

        @media (prefers-reduced-motion: no-preference) {
            html.theme-anim body .btn,
            html.theme-anim body .icon-btn,
            html.theme-anim body .tabs.vertical button,
            html.theme-anim body .tabs.vertical button .lbl,
            html.theme-anim body .switch span,
            html.theme-anim body .status-pill,
            html.theme-anim body .chip {
                transition: color .28s ease;
            }
        }
    </style>

    <style id="dark-readable-outline">
        :root {
            --edge-dark: rgba(0, 0, 0, .75);
        }

        body[data-appearance="dark"] header .title,
        body[data-appearance="dark"] .bar .btn,
        body[data-appearance="dark"] .btn,
        body[data-appearance="dark"] .btn.gray,
        body[data-appearance="dark"] .btn.icon,
        body[data-appearance="dark"] .icon-btn,
        body[data-appearance="dark"] .tabs.vertical button,
        body[data-appearance="dark"] .tabs.vertical button .lbl,
        body[data-appearance="dark"] .status-pill,
        body[data-appearance="dark"] .chip,
        body[data-appearance="dark"] .pill,
        body[data-appearance="dark"] .card .hd h2,
        body[data-appearance="dark"] #tab-questions .hd h2,
        body[data-appearance="dark"] #tab-questions .bd .row > *:not(input):not(select):not(textarea),
        body[data-appearance="dark"] .switch span,
        body[data-appearance="dark"] .toast {
            -webkit-text-stroke-width: .15px;
            -webkit-text-stroke-color: var(--edge-dark);
            text-shadow: 0 0 .5px var(--edge-dark),
            0 1px .5px var(--edge-dark),
            0 -1px .5px var(--edge-dark),
            1px 0 .5px var(--edge-dark),
            -1px 0 .5px var(--edge-dark);
        }

        body[data-appearance="dark"] .gcard *,
        body[data-appearance="dark"] .qcard *,
        body[data-appearance="dark"] input,
        body[data-appearance="dark"] textarea,
        body[data-appearance="dark"] select,
        body[data-appearance="dark"] table,
        body[data-appearance="dark"] .modal .box * {
            -webkit-text-stroke-width: 0 !important;
            text-shadow: none !important;
        }

        .btn.primary {
            color: #fff !important;
        }

        @media (prefers-reduced-motion: no-preference) {
            html.theme-anim body[data-appearance="dark"] header .title,
            html.theme-anim body[data-appearance="dark"] .btn,
            html.theme-anim body[data-appearance="dark"] .icon-btn,
            html.theme-anim body[data-appearance="dark"] .tabs.vertical button,
            html.theme-anim body[data-appearance="dark"] .tabs.vertical button .lbl,
            html.theme-anim body[data-appearance="dark"] .status-pill,
            html.theme-anim body[data-appearance="dark"] .chip,
            html.theme-anim body[data-appearance="dark"] .pill,
            html.theme-anim body[data-appearance="dark"] .card .hd h2,
            html.theme-anim body[data-appearance="dark"] #tab-questions .hd h2,
            html.theme-anim body[data-appearance="dark"] .switch span,
            html.theme-anim body[data-appearance="dark"] .toast {
                transition: text-shadow .28s ease, -webkit-text-stroke-width .28s ease, color .28s ease;
            }
        }
    </style>

    <style id="qa-dark-text-fix">
        #tab-questions .qcard,
        #tab-questions .qcard * {
            color: #0e1726 !important;
        }

        #tab-questions .qcard input::placeholder,
        #tab-questions .qcard textarea::placeholder {
            color: #6b7f99 !important;
        }

        #tab-questions .qcard select,
        #tab-questions .qcard select:disabled {
            color: #0e1726 !important;
        }

        body[data-appearance="dark"] header .btn,
        body[data-appearance="dark"] .nav-rail .tabs button,
        body[data-appearance="dark"] .toast,
        body[data-appearance="dark"] .status-pill,
        body[data-appearance="dark"] .chip,
        body[data-appearance="dark"] .pill {
            color: #f5f7fa !important;
        }

        * {
            -webkit-text-stroke-width: 0 !important;
        }
    </style>


    <!-- â˜…â˜…â˜… åˆå¹¶åçš„ responses-guardï¼šä»…åœ¨â€œæ•°æ®â€Tabæ—¶æ”¾è¡Œ /admin/api/responses â˜…â˜…â˜… -->
    <script id="responses-guard">
    (function () {
      if (window.__RESPONSES_GUARD_INSTALLED__) return;
      window.__RESPONSES_GUARD_INSTALLED__ = true;

      const PATH = /\/admin\/api\/responses(?:[/?]|$)/i;
        const inAllowedTab = () => {
            const resp = document.getElementById('tab-responses')?.classList.contains('active');
            const chart = document.getElementById('tab-charts')?.classList.contains('active');
            return !!(resp || chart);
        };
      const urlOf = (input) => {
        try { return typeof input === 'string' ? input : (input && input.url) || ''; } catch { return ''; }
      };
      const isBlocked = (u) => PATH.test(String(u)) && !inAllowedTab();

      // fetch
      const _fetch = window.fetch;
      window.fetch = function (input, init) {
        const u = urlOf(input);
        if (isBlocked(u)) {
          try { console.debug('[responses-guard] fetch blocked', u); } catch {}
          return Promise.resolve(new Response(
            JSON.stringify({ ok: true, items: [] }),
            { status: 200, headers: { 'Content-Type': 'application/json' } }
          ));
        }
        return _fetch.apply(this, arguments);
      };

      // XHR
      const _open = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function (method, url) {
        this.__rg_block = isBlocked(url);
        return _open.apply(this, arguments);
      };
      const _send = XMLHttpRequest.prototype.send;
      XMLHttpRequest.prototype.send = function (body) {
        if (this.__rg_block) {
          try {
            this.abort();
            // è§¦å‘å¸¸è§å›è°ƒï¼Œé¿å…ä¸Šå±‚â€œæŒ‚ä½â€
            this.onabort && this.onabort(new ProgressEvent('abort'));
            this.onerror && this.onerror(new ProgressEvent('error'));
          } catch {}
          return;
        }
        return _send.apply(this, arguments);
      };

      // sendBeacon
      if (navigator.sendBeacon) {
        const _beacon = navigator.sendBeacon.bind(navigator);
        navigator.sendBeacon = function (url, data) {
          if (isBlocked(url)) {
            try { console.debug('[responses-guard] beacon blocked', url); } catch {}
            return true;
          }
          return _beacon(url, data);
        };
      }

      // EventSource (SSE) â€”â€” åŸå‹æ­£ç¡®çš„å“‘å®ä¾‹
      if (window.EventSource) {
        const _ES = window.EventSource;
        window.EventSource = function (url, conf) {
          if (isBlocked(url)) {
            try { console.debug('[responses-guard] EventSource blocked', url); } catch {}
            const dummy = Object.create(_ES.prototype);
            dummy.readyState = 2; // CLOSED
            dummy.close = function () {};
            return dummy;
          }
          return new _ES(url, conf);
        };
        window.EventSource.prototype = _ES.prototype;
      }

      // WebSocket â€”â€” åŸå‹æ­£ç¡®çš„å“‘å®ä¾‹
      if (window.WebSocket) {
        const _WS = window.WebSocket;
        window.WebSocket = new Proxy(_WS, {
          construct(target, args) {
            const u = String(args?.[0] || '');
            if (isBlocked(u)) {
              try { console.debug('[responses-guard] WebSocket blocked', u); } catch {}
              const dummy = Object.create(_WS.prototype);
              dummy.readyState = 3; // CLOSED
              dummy.close = function () {};
              dummy.send  = function () {};
              dummy.addEventListener = function () {};
              dummy.removeEventListener = function () {};
              dummy.dispatchEvent = function () { return false; };
              return dummy;
            }
            return new target(...args);
          }
        });
      }

      // å…ƒç´  src/hrefï¼ˆimg/script/link/iframe/audio/video/source/embed/objectï¼‰
      function guardURLSetter(Ctor, prop) {
        const desc = Object.getOwnPropertyDescriptor(Ctor.prototype, prop);
        if (!desc || !desc.set) return;
        Object.defineProperty(Ctor.prototype, prop, {
          set(v) {
            if (isBlocked(v)) { try { this.setAttribute('data-blocked-'+prop, v); } catch {} return; }
            return desc.set.call(this, v);
          },
          get: desc.get
        });
        const _setAttr = Ctor.prototype.setAttribute;
        Ctor.prototype.setAttribute = function (name, value) {
          if (String(name).toLowerCase() === prop && isBlocked(value)) {
            try { this.setAttribute('data-blocked-'+prop, value); } catch {}
            return;
          }
          return _setAttr.call(this, name, value);
        };
      }
      [HTMLImageElement, HTMLScriptElement, HTMLIFrameElement, HTMLAudioElement, HTMLVideoElement,
       HTMLEmbedElement, HTMLObjectElement, HTMLSourceElement].forEach(C => guardURLSetter(C, 'src'));

      // link.href ä¹ŸæŒ¡ä¸€ä¸‹
      if (window.HTMLLinkElement) {
        const d = Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype, 'href');
        if (d && d.set) {
          Object.defineProperty(HTMLLinkElement.prototype, 'href', {
            set(v) { if (isBlocked(v)) { try { this.setAttribute('data-blocked-href', v); } catch {} return; } return d.set.call(this, v); },
            get: d.get
          });
        }
      }

      // Workersï¼ˆé˜²åœ¨ worker é‡Œç»•è¿‡æ‹¦æˆªï¼‰
      ['Worker', 'SharedWorker'].forEach(k => {
        const C = window[k];
        if (!C) return;
        window[k] = new Proxy(C, {
          construct(target, args) {
            const url = String(args?.[0] || '');
            if (isBlocked(url)) {
              try { console.debug('[responses-guard] worker blocked', url); } catch {}
              // ç®€å•å“‘å®ä¾‹
              const dummy = { postMessage() {}, terminate() {}, addEventListener() {}, removeEventListener() {}, dispatchEvent() { return false; } };
              return dummy;
            }
            return new target(...args);
          }
        });
      });
    })();
    </script>
    <style id="width-preview">
        :root {
            --form-width: 910px;
        }

        /* ä¸ public_form ä¿æŒä¸€è‡´ */

        /* ä½ çš„å¼¹çª—ç›’å­ç›®å‰æ˜¯ .modal .boxï¼Œé»˜è®¤ max-width:1000pxï¼Œè¿™é‡Œæ”¹æˆå˜é‡ */
        .modal .box {
            max-width: var(--form-width) !important;
            width: 100%;
        }
    </style>
</head>

<body data-appearance="light" data-site="{{ site_name or '' }}" data-tpl="{{ tpl or '' }}">

<header>
    <div class="bar">
        <div class="brandDot" aria-hidden="true"></div>
        <div class="title">ğŸ“ åˆ›å»ºæ–°è¡¨å•</div>
        <div class="grow"></div>
        <button class="btn icon" id="btnPreview" type="button" title="é¢„è§ˆ">ğŸ‘ï¸</button>
        <button class="btn gray" id="clearDraftBtn">ğŸ§¹ æ¸…ç©ºè‰ç¨¿</button>
        <script>
            document.getElementById('clearDraftBtn')?.addEventListener('click', () => {
                const k = localStorage.getItem('builder:currentKey');
                if (k) localStorage.removeItem(k);          // åˆ å®é™…è‰ç¨¿å†…å®¹
                localStorage.removeItem('builder:currentKey'); // å†æŠŠæŒ‡é’ˆé”®ä¹Ÿåˆ æ‰
                alert('å·²æ¸…ç©ºæœ¬åœ°è‰ç¨¿');
                location.reload();
            });
        </script>
        <button class="btn icon" id="btnRedo" type="button" title="é‡åš">â†·</button>
        <button class="btn" id="btnTheme" type="button" title="åˆ‡æ¢äº®/æš—">ğŸŒ—</button>
        <a href="{{ url_for('create_form') }}?new=1" class="btn">ğŸ†• æ–°å»ºè¡¨å•</a>
        <a href="/" class="btn">ğŸ  é¦–é¡µ</a>
        <a href="/logout" class="btn danger">é€€å‡º</a>
    </div>
</header>

<main>
    <!-- å·¦ï¼šå›¾æ ‡è½¨ -->
    <aside class="nav-rail">
        <nav class="tabs vertical" aria-label="ä¸»å¯¼èˆª">
            <button class="active" data-tab="questions" title="è¡¨å•ï¼ˆç¼–è¾‘é—®é¢˜ï¼‰">ğŸ“<span class="lbl">è¡¨å•</span></button>
            <button data-tab="responses" title="æ•°æ®ï¼ˆæŸ¥çœ‹å›å¤ï¼‰">ğŸ“‹<span class="lbl">æ•°æ®</span></button>
            <button data-tab="settings" title="è®¾ç½®ï¼ˆè¡¨å•é…ç½®ï¼‰">âš™ï¸<span class="lbl">è®¾ç½®</span></button>
            <button data-tab="charts" title="å›¾è¡¨ï¼ˆå¯è§†åŒ–ï¼‰">ğŸ“ˆ<span class="lbl">å›¾è¡¨</span></button>
        </nav>
    </aside>

    <!-- ä¸­ï¼šå†…å®¹åŒº -->
    <div class="canvas">
        <section class="greet-card">
            <h1 class="greet-title">æ¬¢è¿æ¥åˆ°è®¾è®¡è¡¨å•å¹³å°<br>è®¾è®¡å±äºæ‚¨çš„è¡¨å•</h1>
            <div class="chips" aria-hidden="true">
                <span class="chip">å¿«é€Ÿè®¾è®¡</span>
                <span class="chip">é«˜æ•ˆæ”¶é›†</span>
                <span class="chip">ç®€å•ä¸Šæ‰‹</span>
            </div>
        </section>

        <!-- è¡¨å• -->
        <form method="post"
              action="{{ url_for('create_form') }}{% if site_name %}?site={{ site_name }}{% endif %}"
              id="builder">
            <!-- Tab 1ï¼šé—®é¢˜ -->
            <div class="tab active" id="tab-questions">
                <div class="dash-grid">
                    <div class="card form-basic"
                         style="background-size:cover;background-position:var(--title-pos-x,50%) var(--title-pos-y,50%);background-repeat:no-repeat; position:relative; overflow:hidden;">
                        <div class="hd"><h2>è¡¨å•åŸºæœ¬ä¿¡æ¯</h2></div>
                        <!-- èƒŒæ™¯å›¾å·¥å…·æ¡ï¼šæ¸…é™¤ -->
                        <div class="bg-tools" id="bgTools" hidden>
                            <button type="button" class="bg-clear" id="bgClear" aria-label="ç§»é™¤èƒŒæ™¯">âœ–</button>
                        </div>
                        <!-- æ ‡é¢˜å°é¢å›¾ï¼ˆå¯é€‰ï¼‰ -->
                        <div class="row" style="align-items:flex-start; gap:10px; margin-top:10px; position:relative; z-index:2">
                            <div style="flex:1; min-width:280px">
                                <input id="headerImageUrl" class="tiny"
                                       placeholder="è¡¨å•åŸºæœ¬ä¿¡æ¯çš„èƒŒæ™¯å›¾ URLï¼ˆæˆ–ç”¨å³ä¾§ä¸Šä¼ ï¼‰">
                            </div>
                            <label class="btn icon" for="headerImagePicker" style="height:42px">ğŸ“·</label>
                            <input id="headerImagePicker" type="file" accept="image/*" hidden>
                        </div>
                        <div class="bd">
                            <div class="row2">
                                <input name="form_name" placeholder="è¡¨å•åç§° *" required value="{{ form_name or '' }}"
                                       class="tiny">
                                <input name="site_name" placeholder="ç½‘ç«™å *" required value="{{ site_name or '' }}"
                                       class="tiny">
                            </div>
                            <textarea name="form_desc" rows="3" placeholder="è¡¨å•æè¿°ï¼ˆå¯é€‰ï¼‰" class="tiny"
                                      style="margin-top:10px;">{{ form_desc or '' }}</textarea>
                        </div>
                    </div>

                    <!-- åˆ†éš” -->
                    <div style="height:20px;"></div>

                    <div class="card form-basic">
                        <div class="hd"><h2>é—®é¢˜è®¾ç½®</h2></div>
                        <div class="bd">
                            <div id="list"></div>
                            <div style="text-align:center;margin-top:12px;">
                                <button type="button" class="btn primary" id="addBtn">â• æ·»åŠ é—®é¢˜</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2ï¼šæ•°æ® -->
            <div class="tab" id="tab-responses">
                <div class="dash-grid">
                    <div class="card" style="grid-column:1/-1">
                        <div class="hd"><h2>å›å¤æ•°æ®</h2></div>
                        <div class="bd">
                            <div class="row" style="flex-wrap:wrap;gap:10px;margin-bottom:10px;color:#0e1726">
                                <input id="q" class="tiny" style="min-width:260px;flex:1" type="text"
                                       placeholder="æœç´¢å§“åã€æ´»åŠ¨åã€é‚®ç®±ã€ç”µè¯â€¦"/>
                                <button type="button" id="btnSearch" class="btn">ğŸ” æœç´¢</button>
                                <button type="button" id="btnRefresh" class="btn gray">åˆ·æ–°</button>
                                <label class="switch">
                                    <input id="autoTick" type="checkbox"><span>è‡ªåŠ¨åˆ·æ–°ï¼ˆ30ç§’ï¼‰</span>
                                </label>
                                <button type="button" id="btnExportAll" class="btn">ğŸ“Š å¯¼å‡º Excel</button>
                                <button type="button" id="btnGallery" class="btn">ğŸ–¼ï¸ å…¨é‡å›¾ç‰‡</button>
                            </div>

                            <div class="table-wrap">
                                <table id="respTable">
                                    <thead id="respThead"></thead>
                                    <tbody id="respTbody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3ï¼šè®¾ç½® -->
            <div class="tab" id="tab-settings">
                <div class="dash-grid">
                    <div class="card" style="grid-column:1/-1">
                        <div class="hd"><h2>å¤–è§‚ä¸ä¸»é¢˜</h2></div>
                        <div class="bd">
                            <div class="grid cols-2">
                                <div class="gcard">
                                    <h3>ä¸»é¢˜è‰²</h3>
                                    <div class="row" style="gap:10px;align-items:center">
                                        <input id="colorPicker" type="color" value="#FF6A2A" data-skey="theme.brand"
                                               style="width:48px;height:48px;border:0;border-radius:12px;cursor:pointer">
                                        <input class="tiny" placeholder="#2563eb" data-skey="theme.brand"
                                               style="max-width:180px">
                                    </div>
                                    <div class="hint">å®æ—¶å†™å…¥ <code>schema.theme.brand</code></div>
                                </div>

                                <div class="gcard">
                                    <h3>å¤–è§‚æ¨¡å¼</h3>
                                    <select class="tiny" data-skey="theme.appearance">
                                        <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
                                        <option value="light">äº®è‰²</option>
                                        <option value="dark">æš—è‰²</option>
                                    </select>
                                </div>

                                <div class="gcard">
                                    <h3>å‘å¸ƒè®¾ç½®</h3>
                                    <label class="switch"><input type="checkbox" data-skey="publish.is_published"><span>å…¬å¼€å‘å¸ƒ</span></label>
                                    <div class="row2" style="margin-top:8px">
                                        <input class="tiny" placeholder="å¼€å§‹æ—¶é—´ï¼ˆå¯é€‰ï¼‰" data-skey="publish.start_at">
                                        <input class="tiny" placeholder="ç»“æŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰" data-skey="publish.end_at">
                                    </div>
                                </div>

                                <div class="gcard">
                                    <h3>æäº¤é™åˆ¶</h3>
                                    <div class="row2">
                                        <input class="tiny" type="number" min="0" placeholder="æ¯äººé™æ¬¡"
                                               data-skey="submission.per_user_limit">
                                        <input class="tiny" type="number" min="0" placeholder="æ¯IPæ¯æ—¥é™æ¬¡"
                                               data-skey="submission.per_ip_daily_limit">
                                    </div>
                                    <div class="row2" style="margin-top:8px">
                                        <input class="tiny" type="number" min="0" placeholder="æ€»é‡ä¸Šé™"
                                               data-skey="submission.max_total">
                                        <input class="tiny" placeholder="å»é‡å…³é”®å­—ï¼ˆé€—å·åˆ†éš”ï¼‰"
                                               data-skey="submission.duplicate_keys">
                                    </div>
                                    <label class="switch" style="margin-top:8px"><input type="checkbox"
                                                                                        data-skey="submission.require_review"><span>å¼€å¯å®¡æ ¸æµç¨‹</span></label>
                                </div>

                                <div class="gcard">
                                    <h3>ä¸Šä¼ è®¾ç½®</h3>
                                    <div class="row2">
                                        <input class="tiny" placeholder="å…è®¸ç±»å‹ï¼ˆå¦‚ï¼šjpg,png,pdfï¼‰"
                                               data-skey="upload.allowed_file_types">
                                        <input class="tiny" type="number" min="1" max="10"
                                               placeholder="æœ€å¤§æ–‡ä»¶æ•°ï¼ˆé»˜è®¤3ï¼‰"
                                               data-skey="upload.max_files">
                                    </div>
                                    <div class="row2" style="margin-top:8px">
                                        <input class="tiny" type="number" min="100" placeholder="å›¾ç‰‡æœ€å¤§å®½ï¼ˆpxï¼‰"
                                               data-skey="upload.image_max_w">
                                        <input class="tiny" type="number" step="0.05" min="0.1" max="1"
                                               placeholder="å›¾ç‰‡è´¨é‡ï¼ˆ0~1ï¼‰" data-skey="upload.image_quality">
                                    </div>
                                </div>

                                <div class="gcard">
                                    <h3>éšç§åŒæ„</h3>
                                    <label class="switch"><input type="checkbox"
                                                                 data-skey="privacy.require_consent"><span>æäº¤å‰éœ€åŒæ„éšç§æ¡æ¬¾</span></label>
                                    <input class="tiny" placeholder="éšç§æ¡æ¬¾é“¾æ¥ï¼ˆå¯ç•™ç©ºï¼‰"
                                           data-skey="privacy.consent_url" style="margin-top:8px">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4ï¼šå›¾è¡¨ -->
            <div class="tab" id="tab-charts">
                <div class="dash-grid">
                    <!-- â‘  å›¾è¡¨è®¾ç½®ï¼ˆåªåœ¨ç¬¬4å±‚å‡ºç°ï¼‰ -->
                    <div class="card" style="grid-column:1/-1">
                        <div class="hd"><h2>å›¾è¡¨è®¾ç½®</h2></div>
                        <div class="bd">
                            <div class="hint" style="margin-bottom:8px">
                                åªéœ€è¾“å…¥<strong>é¢˜ç›®æ ‡é¢˜</strong>å¹¶é€‰æ‹©<strong>ç±»å‹</strong>ï¼Œç‚¹â€œä¿å­˜å›¾è¡¨é…ç½®â€ï¼›ç‚¹å³ä¾§â€œåˆ·æ–°å›¾è¡¨â€å³å¯æ›´æ–°ä¸‹æ–¹å›¾è¡¨ã€‚
                            </div>
                            <div id="chart-settings-list"></div>
                            <div class="row" style="margin-top:8px;gap:8px">
                                <button type="button" class="btn" id="btnAddChart">+ å¢åŠ å›¾è¡¨</button>
                                <button type="button" class="btn primary" id="btnSaveCharts">ä¿å­˜å›¾è¡¨é…ç½®</button>
                                <button type="button" class="btn gray" id="btnRefreshCharts">ğŸ”„ åˆ·æ–°å›¾è¡¨</button>
                            </div>
                            <!-- é¢˜ç›®æ ‡é¢˜è‡ªåŠ¨è¡¥å…¨ -->
                            <datalist id="chart-title-list"></datalist>
                        </div>
                    </div>
                    <div class="card" style="grid-column:1/-1" hidden>
                        <div class="hd"><h2>è¡¨å•æ•°æ®å›¾è¡¨</h2></div>
                        <div class="bd">
                            <div id="chartsRoot"
                                 style="min-height:280px;display:grid;grid-template-columns:320px 1fr;gap:14px">
                                <!-- é€šè¿‡ç‡ï¼ˆåœ†è¡¨ï¼‰ -->
                                <div style="background:#ffffff;border:1px solid #e8eef6;border-radius:14px;padding:16px">
                                    <h3 style="margin:0 0 12px;font-weight:800">é€šè¿‡ç‡</h3>
                                    <div style="display:flex;align-items:center;gap:16px">
                                        <div id="passDonut" style="--p:.0;width:160px;height:160px;border-radius:50%;
                                                background:conic-gradient(var(--brand,#6366f1) calc(var(--p)*1turn), #e9eef5 0);position:relative">
                                            <div style="position:absolute;inset:18px;border-radius:50%;background:#fff9;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)"></div>
                                            <div id="passText"
                                                 style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px">
                                                0%
                                            </div>
                                        </div>
                                        <div style="color:#556;font-size:12px;line-height:1.6">
                                            <div><b>é€šè¿‡</b>ï¼š<span id="okCnt">0</span></div>
                                            <div><b>æœªé€šè¿‡</b>ï¼š<span id="ngCnt">0</span></div>
                                            <div><b>æ€»è®¡</b>ï¼š<span id="allCnt">0</span></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- æäº¤çš„æ—¶é—´ï¼ˆæŠ˜çº¿å›¾ï¼‰ -->
                                <div style="background:#ffffff;border:1px solid #e8eef6;border-radius:14px;padding:16px">
                                    <h3 style="margin:0 0 12px;font-weight:800">æäº¤çš„æ—¶é—´</h3>
                                    <canvas id="lineChart" width="960" height="280"
                                            style="width:100%;height:260px;display:block"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <input type="hidden" name="schema_json" id="schema_json"
                   value='{{ schema_json|tojson if schema_json else "" }}'>
            <div class="form-footer">
                <button type="submit" id="saveFormBtn" class="btn">âœ… ä¿å­˜è¡¨å•</button>
            </div>
        </form>
    </div>

    <!-- å³ï¼šå¿«æ·æŒ‰é’®æ  -->
    <div class="rail">
        <div id="bgOpacityBox"
             style="background:var(--glass);border:1px solid var(--glass-border);border-radius:12px;padding:8px 10px;">
            <label for="bgOpacity" style="display:block;font-size:12px;margin-bottom:6px;">èƒŒæ™¯æ˜æ˜¾åº¦</label>
            <input id="bgOpacity" type="range" min="0" max="100" value="72" style="width:160px;">
        </div>
        <button class="icon-btn" id="railAdd" title="æ·»åŠ é—®é¢˜">â•</button>
        <button class="icon-btn" id="railTitle" title="æ·»åŠ æ ‡é¢˜/æè¿°">Tt</button>
        <label class="icon-btn" title="æ’å…¥å›¾ç‰‡"
               style="display:inline-flex;align-items:center;gap:6px;white-space:nowrap">ğŸ–¼ï¸ å›¾ç‰‡
            <input id="railImage" type="file" accept="image/*" style="display:none">
        </label>
    </div>
</main>

<!-- é¢„è§ˆ Modal -->
<div class="modal" id="previewModal" aria-hidden="true">
    <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <strong>è¡¨å•é¢„è§ˆ</strong>
            <button class="btn icon" id="closePreview">âœ–</button>
        </div>
        <div id="previewRoot"></div>
    </div>
</div>

<!-- åˆ›å»ºæˆåŠŸå¼¹çª—ï¼ˆä¸­é—´ä¸æ»‘å‡ºç°ï¼‰ -->
<div class="modal" id="successModal" aria-hidden="true"
     style="display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:120">
  <div class="box" id="successBox" style="
    width:min(920px,92vw); max-height:86vh; border-radius:20px; overflow:hidden;
    background:var(--glass,#ffffffee); border:1px solid var(--glass-border,#e5e7eb);
    backdrop-filter: blur(18px) saturate(160%); box-shadow: 0 18px 36px rgba(0,0,0,.22);
    opacity:0; transform: scale(.92) translateY(8px);">
    <iframe id="successFrame" title="åˆ›å»ºæˆåŠŸ" style="width:100%;height:70vh;border:0;background:#fff"></iframe>
  </div>
</div>

<style>
  /* ä¸æ»‘å‡ºç°åŠ¨ç”» */
  #successModal.show #successBox {
    animation: popIn .22s cubic-bezier(.2, .9, .2, 1) forwards;
  }
  @keyframes popIn {
    from { opacity: 0; transform: scale(.92) translateY(8px) }
    to   { opacity: 1; transform: scale(1) translateY(0) }
  }
  @media (prefers-reduced-motion: reduce) {
    #successModal.show #successBox { animation: none; opacity: 1; transform: none; }
  }
</style>

<!-- å›¾é›† Modal -->
<div class="modal" id="galleryModal" aria-hidden="true">
    <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <strong>å…¨é‡æ•°æ®ï¼ˆå›¾ç‰‡ï¼‰</strong>
            <button class="btn icon" id="closeGallery">âœ–</button>
        </div>
        <div id="galleryRoot" class="row" style="flex-wrap:wrap"></div>
    </div>
</div>

<!-- æ–‡ä»¶é¢„è§ˆ Modalï¼ˆæ–°å¢ï¼‰ -->
<div class="modal" id="filePreview" aria-hidden="true">
    <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <strong>æ–‡ä»¶é¢„è§ˆ</strong>
            <button class="btn icon" id="closeFilePreview">âœ–</button>
        </div>
        <div id="filePreviewBody"></div>
    </div>
</div>


<!-- é¡¶éƒ¨æç¤º -->
<div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>
<!-- ä½ çš„é€»è¾‘è„šæœ¬ï¼ˆä¸å˜ï¼‰ -->
<script src="{{ asset('builder.js') }}" defer></script>

<style id="anti-garble">
  /* æ°¸è¿œéšè—æ•°æ®é¡µé‡Œçš„å ä½è¡Œï¼Œé¿å…â€œä¹±ç â€é—ªä¸€ä¸‹ */
  #tab-responses .muted { display: none !important; }
</style>

<style id="no-review-columns">
  /* å…³é—­å®¡æ ¸æµç¨‹æ—¶ï¼Œéšè—ï¼šçŠ¶æ€ / å®¡æ ¸è¯´æ˜ / æ“ä½œ(é€šè¿‡/ä¸é€šè¿‡) ä¸‰åˆ— */
  body.no-review #respTable th:nth-last-child(5),
  body.no-review #respTable td:nth-last-child(5), /* çŠ¶æ€ */
  body.no-review #respTable th:nth-last-child(4),
  body.no-review #respTable td:nth-last-child(4), /* å®¡æ ¸è¯´æ˜ */
  body.no-review #respTable th:nth-last-child(2),
  body.no-review #respTable td:nth-last-child(2)  /* æ“ä½œ(é€šè¿‡/ä¸é€šè¿‡) */ {
    display: none !important;
  }
</style>

<style id="bg-tools-style">
  :root{ --title-pos-x:50%; --title-pos-y:50%; --title-cover-opacity:.72; }

  .form-basic{ cursor: var(--bg-move, default); }
  .form-basic.dragging{ cursor: grabbing; }

  .form-basic .bg-tools{
    position:absolute; top:8px; right:8px; z-index:3; display:flex; gap:8px;
  }
  .form-basic .bg-clear{
    width:28px; height:28px; border-radius:999px; border:0;
    background:rgba(0,0,0,.6); color:#fff; font-weight:900; line-height:28px;
    text-align:center; cursor:pointer;
  }

  /* ç”¨å˜é‡æ§åˆ¶é®ç½©é€æ˜åº¦ï¼ˆä¸æ”¹ä½ çš„é…è‰²ï¼ŒåªæŠŠ alpha æŠ½æˆå˜é‡ï¼‰ */
  .form-basic.has-cover::after{
    background: linear-gradient(180deg,
      rgba(255,255,255,var(--title-cover-opacity)),
      rgba(255,255,255,var(--title-cover-opacity))) !important;
  }
  body[data-appearance="dark"] .form-basic.has-cover::after{
    background: linear-gradient(180deg,
      rgba(17,24,39,calc(var(--title-cover-opacity)*.9)),
      rgba(17,24,39,calc(var(--title-cover-opacity)*1))) !important;
  }
</style>

<script>
(function(){
  const urlInp   = document.getElementById('headerImageUrl');
  const picker   = document.getElementById('headerImagePicker');
  const basicCard= document.querySelector('.form-basic');
  const schemaInput = document.getElementById('schema_json');
  const form = document.getElementById('builder');

  function applyBg(url){
    if (!basicCard) return;
    if (url) {
      basicCard.style.backgroundImage = `url("${url.replace(/"/g,'\\"')}")`;
      basicCard.classList.add('has-cover');
    }else{
      basicCard.style.removeProperty('background-image');
      basicCard.classList.remove('has-cover');
    }
  }

  // åˆå§‹åŒ–ï¼šä» schema_json æ¢å¤
  try{
    const j = JSON.parse(schemaInput.value || '{}') || {};
    applyBg(j?.header?.title_image || '');
    if (urlInp) urlInp.value = j?.header?.title_image || '';
  }catch(_){}

  urlInp?.addEventListener('input', ()=>{
    const v = urlInp.value.trim();
    applyBg(v);
    // å†™å› schemaï¼ˆä¸‹é¢ç¬¬â‘¡æ¡ä¼šæŠŠå®ƒè‡ªåŠ¨ä¿å­˜åˆ°åç«¯ï¼‰
    try{
      const j = JSON.parse(schemaInput.value||'{}')||{};
      (j.header ||= {}).title_image = v;
      schemaInput.value = JSON.stringify(j);
      schemaInput.dispatchEvent(new Event('input',{bubbles:true}));
      schemaInput.dispatchEvent(new Event('change',{bubbles:true}));
    }catch(_){}
  });

  // é€‰æ‹©æ–‡ä»¶æ—¶å…ˆç”¨ blobURL é¢„è§ˆï¼ˆçœŸæ­£ URL ç”±ä½ å·²æœ‰çš„ä¸Šä¼ é€»è¾‘äº§ç”Ÿï¼‰
  picker?.addEventListener('change', e=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const blobURL = URL.createObjectURL(f);
    applyBg(blobURL);
  });
})();
</script>

<style id="greet-cover-style">
  /* é—®å€™å¡èƒŒæ™¯å›¾ */
  .greet-card.has-cover{ position:relative; overflow:hidden; }
  .greet-card.has-cover::before{
      content: "";
      position: absolute;
      inset: 0;
      border-radius: var(--radius-xl);
      background-image: linear-gradient(180deg, rgba(255, 255, 255, .92), rgba(255, 255, 255, .86)),
      var(--greet-cover-image, none); /* âœ… fallback */
      background-size: cover, cover;
      background-position: center, center; /* âœ… ä¸¤å±‚éƒ½å±…ä¸­ï¼Œæ¶ˆé™¤â€œæ•°é‡ä¸åŒ¹é…â€å‘Šè­¦ */
      z-index: 0;
      pointer-events: none;
  }

  body[data-appearance="dark"] .greet-card.has-cover::before {
      background-image: linear-gradient(180deg, rgba(11, 18, 32, .64), rgba(11, 18, 32, .64)),
      var(--greet-cover-image, none); /* âœ… fallback */
  }
  .greet-card.has-cover > * { position:relative; z-index:1; }

  /* é¢„è§ˆåŒºåŒ…è£…ï¼ˆåªä¸ºæ”¾å³ä¸Šè§’ Ã—ï¼‰ */
  #greetCoverWrap{ position:relative; display:none; margin:8px 0 0 0 }
  #greetCoverWrap.show{ display:inline-block; }
  #greetCoverWrap .q-image{ max-width:180px; border-radius:12px; display:block }
</style>

<style>
  /* ä¸è¦ç¼©ç•¥å›¾ï¼Œåªç”¨ä½œèƒŒæ™¯ */
  #greetCoverWrap,
  #greetCover { display: none !important; }
</style>


<style>
    .nav-rail::before {
        pointer-events: none;
    }

    .canvas {
        position: relative;
        z-index: 10;
    }

    .nav-rail {
        position: sticky;
        z-index: 5;
    }
</style>

<script>
    window.queueServerSave = function () {
    };
    window.ensureServerSaved = async function () {
        return !!(document.body.dataset.site || '').trim();
    };
</script>

<script id="smooth-theme-toggle">
    (function () {
        const html = document.documentElement;
        const body = document.body;
        const btn = document.getElementById('btnTheme');

        const saved = localStorage.getItem('appearance');
        if (saved === 'dark' || saved === 'light') {
            body.setAttribute('data-appearance', saved);
        }

        function flip(next) {
            html.classList.add('no-anim');
            body.setAttribute('data-appearance', next);
            localStorage.setItem('appearance', next);
            void body.offsetWidth;
            requestAnimationFrame(() => html.classList.remove('no-anim'));
        }

        btn && btn.addEventListener('click', () => {
            const next = body.getAttribute('data-appearance') === 'dark' ? 'light' : 'dark';
            flip(next);
        });
    })();
</script>

<style id="kill-transitions">
    html.no-anim *, html.no-anim *::before, html.no-anim *::after {
        transition: none !important;
        animation: none !important;
        scroll-behavior: auto !important;
    }

    .form-footer {
        display: flex;
        justify-content: flex-end;
        margin: 16px 0;
    }

    #saveFormBtn {
        width: auto;
        min-width: 132px;
        padding: 10px 16px;
        border-radius: 12px;
        box-shadow: var(--shadow-soft);
    }

    body:not([data-appearance="dark"]) #saveFormBtn {
        background: #ffffffe6;
        color: #0e1726;
        border: 1px solid #e8eef6;
    }

    body:not([data-appearance="dark"]) #saveFormBtn:hover {
        filter: brightness(.98);
    }

    body[data-appearance="dark"] #saveFormBtn {
        background: var(--glass-solid);
        color: #F2F5F7;
        border: 1px solid var(--glass-border);
    }

    body[data-appearance="dark"] #saveFormBtn:hover {
        filter: brightness(1.05);
    }

    #addBtn {
        background: #ffffffe6;
        color: #0e1726;
        border: 1px solid #e8eef6;
        box-shadow: var(--shadow-soft);
        padding: 10px 16px;
        border-radius: 12px;
    }

    body[data-appearance="dark"] #addBtn {
        background: var(--glass-solid);
        color: #F2F5F7;
        border: 1px solid var(--glass-border);
    }

    #addBtn:hover {
        filter: brightness(.98);
    }

    body[data-appearance="dark"] #addBtn:hover {
        filter: brightness(1.05);
    }
</style>

<script>
    /** â€”â€” å›å¤æ•°æ®è¡¨ï¼šæŒ‰ schema çš„â€œé¢˜ç›®åç§°â€æ¸²æŸ“åˆ— + æ–‡ä»¶é¢„è§ˆ + åˆ—åâ€œæ“ä½œâ€ â€”â€” */
    (function () {
        const SITE = document.body.dataset.site || "";

        function safeParse(txt) {
            try {
                let j = JSON.parse(txt);
                if (typeof j === "string") {
                    try {
                        j = JSON.parse(j);
                    } catch {
                    }
                }
                return j && typeof j === "object" ? j : null;
            } catch {
                return null;
            }
        }

        function loadSchemaCandidates() {
            const out = [];
            const el = document.getElementById('schemaJSON');
            if (el) {
                const j = safeParse((el.textContent || '').trim());
                if (j) out.push(j);
            }
            const inp = document.getElementById('schema_json');
            if (inp) {
                const j = safeParse((inp.value || inp.getAttribute('value') || '').trim());
                if (j) out.push(j);
            }
            ['schema', 'formSchema', 'FORM_SCHEMA', 'builderSchema', '__schema__'].forEach(k => {
                if (window[k]) out.push(window[k]);
            });
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                const v = localStorage.getItem(k);
                if (!v || v.length > 200000) continue;
                const j = safeParse(v);
                if (j && (j.fields || j.questions || j.items || j.titleMap || j.labels || j.fieldLabels)) out.push(j);
            }
            const cards = [...document.querySelectorAll('#list .qcard')];
            if (cards.length) {
                const guess = {
                    fields: cards.map(c => ({
                        key: c.dataset.key || c.getAttribute('data-key') || c.querySelector('[name]')?.name || '',
                        label: (c.querySelector('.q-title')?.textContent || '').trim()
                    })).filter(x => x.key)
                };
                out.push(guess);
            }
            return out;
        }

        function getI18nString(v) {
            if (v == null) return "";
            if (typeof v === "string") return v.trim();
            if (typeof v === "object") {
                const order = ["zh-CN", "zh_CN", "zh-cn", "zh", "cn", "text", "title", "label", "value", "en"];
                for (const k of order) {
                    if (typeof v[k] === "string" && v[k].trim()) return v[k].trim();
                }
                for (const k in v) {
                    if (typeof v[k] === "string" && v[k].trim()) return v[k].trim();
                }
            }
            return "";
        }

        function extractLabel(f) {
            const cands = [
                f.label, f.title, f.text, f.name, f.placeholder, f.question, f.desc, f.description,
                f?.ui?.label, f?.ui?.title, f?.props?.label, f?.props?.title, f?.meta?.label, f?.meta?.title,
                f?.i18n, f?.displayName
            ];
            for (const c of cands) {
                const s = getI18nString(c);
                if (s) return s;
            }
            return "";
        }

        function mergeSchemas(cands) {
            const titleMap = {};
            const tmp = [];

            cands.forEach(s => {
                const map = s?.titleMap || s?.labels || s?.fieldLabels || {};
                Object.keys(map || {}).forEach(k => {
                    if (map[k]) titleMap[k] = getI18nString(map[k]) || map[k];
                });

                const raw = s?.fields || s?.questions || s?.items || [];
                const arr = Array.isArray(raw) ? raw : Object.values(raw || {});

                arr.forEach(f => {
                    const key = f.key || f.id || f.name || f.field || f.valueKey || f.code || f.slug;
                    if (!key) return;
                    const label = extractLabel(f) || titleMap[key] || key;
                    const type = String(f.type || f.kind || f.widget || f.input || "").toLowerCase();
                    tmp.push({key, label, type});
                });
            });

            const byKey = {};
            const looksRandom = s => typeof s === 'string' && /^q[a-z0-9]{5,}$/i.test(s);
            tmp.forEach(f => {
                if (!byKey[f.key]) byKey[f.key] = f;
                else if (looksRandom(byKey[f.key].label) && !looksRandom(f.label)) byKey[f.key] = f;
            });
            Object.keys(titleMap).forEach(k => {
                if (!byKey[k]) byKey[k] = {key: k, label: titleMap[k], type: ''};
                else if (!byKey[k].label || looksRandom(byKey[k].label)) byKey[k].label = titleMap[k];
            });

            return Object.values(byKey);
        }

        const SCHEMA_CANDIDATES = loadSchemaCandidates();
        let FIELDS = []; // ç­‰ /admin/api/responses è¿”å› columns/titleMap å†ç”»è¡¨å¤´
        // â€”â€” ä»…å½“â€œè¿˜æœ‰ééšæœºå­—æ®µå¯ç”¨â€æ—¶æ‰è¿‡æ»¤ï¼Œå¦åˆ™ä¿ç•™æ‰€æœ‰å­—æ®µï¼ˆé¿å…æŠŠå†…å®¹å…¨åˆ ç©ºï¼‰
        const looksRandom = s => typeof s === 'string' && /^q[a-z0-9]{5,}$/i.test(s);
        const nonRandom = FIELDS.filter(f => !looksRandom(f.key));
        if (nonRandom.length) FIELDS = nonRandom;


        const onlyRandom = FIELDS.length && FIELDS.every(f => f.label === f.key || /^q[a-z0-9]{5,}$/i.test(f.label || ''));
        if (onlyRandom) {
            FIELDS = FIELDS.map(f => {
                const lbl = f.label && f.label !== f.key ? f.label : f.key;
                return {...f, label: f.label === f.key ? f.key : `${f.label}ï¼ˆ${f.key}ï¼‰`};
            });
        }

        const thead = document.getElementById("respThead");
        const tbody = document.getElementById("respTbody");
        const qInput = document.getElementById("q");
        const btnSearch = document.getElementById("btnSearch");
        const btnRefresh = document.getElementById("btnRefresh");
        const autoTick = document.getElementById("autoTick");
        const btnExportAll = document.getElementById("btnExportAll");
        const btnGallery = document.getElementById("btnGallery");

        // æœ¬åœ°è½¬ä¹‰ï¼Œä¸“ä¾›è¡¨å¤´/å±æ€§ä½¿ç”¨ï¼ˆé¿å…ä¸ä¸‹æ–¹çš„ escHtml/escAttr é¡ºåºå†²çªï¼‰
        function __escHtml(s) {
            return String(s == null ? '' : s).replace(/[&<>]/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;'}[m]));
        }

        function __escAttr(s) {
            return String(s == null ? '' : s).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        function buildHeader() {
            thead.innerHTML = `<tr>
      <th>ID</th>
      ${FIELDS.map(f => `<th title="${__escAttr(f.key)}">${__escHtml(f.label)}</th>`).join("")}
      <th>çŠ¶æ€</th>
      <th>å®¡æ ¸è¯´æ˜</th>
      <th>å¯¼å‡º</th>
      <th>æ“ä½œ</th>
      <th>åˆ é™¤</th>
    </tr>`;
        }

        async function jget(url, opt) {
            const r = await fetch(url, opt);
            const data = await r.json().catch(() => ({ok: false, error: "éJSONå“åº”"}));
            if (!r.ok || data.ok === false) throw new Error(data.error || r.statusText);
            return data;
        }

        function fileUrl(s) {
            if (!s) return '';
            if (/^(https?:|blob:|data:)/i.test(s) || s.startsWith('/')) return s;
            return `/site/${encodeURIComponent(SITE)}/uploads/${encodeURI(s)}`;
        }


        function fileCell(href, text) {
            const u = fileUrl(href);
            const attr = (s) => String(s == null ? '' : s).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
            const t = escHtml(text || href);
            return `<a href="${attr(u)}" data-preview title="é¢„è§ˆ">${t}</a> <a href="${attr(u)}" download title="ä¸‹è½½">â¬‡</a>`;
        }

        function renderValueByType(v, type) {
            const fileLike = /file|image|upload|picture|photo/;
            if (v == null) return "";
            if (Array.isArray(v)) return v.map(x => renderValueByType(x, type)).join("<br>");
            if (typeof v === "object") {
                const name = v.filename || v.name || v.file || "";
                const url = v.url || v.path || name || "";
                if (url && (fileLike.test(type) || /\.(png|jpe?g|gif|webp|pdf|docx?|xlsx?|mp4|webm|ogg|bmp|svg)$/i.test(url))) {
                    return fileCell(url, name || url);
                }
                return Object.entries(v).map(([k, val]) =>
                    `<div><span class="muted">${escHtml(k)}ï¼š</span>${renderValueByType(val, type)}</div>`
                ).join("");
            }
            const s = String(v);
            if (fileLike.test(type) || /\.(png|jpe?g|gif|webp|pdf|docx?|xlsx?|mp4|webm|ogg|bmp|svg)$/i.test(s)) return fileCell(s);
            return s.replace(/[<>&]/g, m => ({'<': '&lt;', '>': '&gt;', '&': '&amp;'}[m]));
        }

        function pillCls(status) {
            return status === "å·²é€šè¿‡" ? "good" : (status === "æœªé€šè¿‡" ? "bad" : "wait");
        }

        function renderRows(items) {
            tbody.innerHTML = (items || []).map(it => {
                const d = it.data || {};
                const cells = FIELDS.map(f => `<td>${renderValueByType(d[f.key], f.type)}</td>`).join("");
                const status = it.status || "å¾…å®¡æ ¸";
                const cmt = escAttr(it.review_comment || '');
                return `<tr data-id="${it.id}">
        <td>${it.id}</td>
        ${cells}
        <td><span class="pill ${pillCls(status)}">${status}</span></td>
        <td><input class="cmt" placeholder="å®¡æ ¸è¯´æ˜" value="${cmt}" /></td>
        <td>
          <a class="btn mini" href="/site/${encodeURIComponent(SITE)}/admin/export_word/${it.id}" target="_blank" rel="noopener">Word</a>
          <a class="btn mini" href="/site/${encodeURIComponent(SITE)}/admin/export_excel/${it.id}" target="_blank" rel="noopener">Excel</a>
        </td>
        <td>
          <button class="btn mini good" data-approve>é€šè¿‡</button>
          <button class="btn mini danger" data-reject>ä¸é€šè¿‡</button>
        </td>
        <td><button class="btn mini gray" data-del>åˆ é™¤</button></td>
      </tr>`;
            }).join("");
        }

        function escHtml(s) {
            return String(s).replace(/[&<>]/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;'}[m]));
        }

        function escAttr(s) {
            return String(s).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        function looksAllRandom(fields) {
            return fields.length && fields.every(f => f.label === f.key || /^q[a-z0-9]{5,}$/i.test(f.label || ''));
        }

        async function load() {
            const url = `/site/${encodeURIComponent(SITE)}/admin/api/responses?q=${encodeURIComponent(qInput?.value || "")}`;
            const data = await jget(url);

            // å¦‚æœåç«¯ç»™äº†åˆ—å®šä¹‰/æ ‡é¢˜æ˜ å°„ï¼Œä¼˜å…ˆä½¿ç”¨å®ƒæ¥ç”Ÿæˆä¸­æ–‡è¡¨å¤´
            if (data && (data.columns || data.headers || data.titleMap || data.labels)) {
                const cols = data.columns || data.headers || [];
                const map = data.titleMap || data.labels || {};
                if (cols.length) {
                    FIELDS = cols.map(c => ({
                        key: c.key || c.id || c.name,
                        label: (c.title || c.label || c.text || c.name || c.key),
                        type: (c.type || '')
                    }));
                } else if (Object.keys(map).length) {
                    FIELDS = Object.keys(map).map(k => ({key: k, label: String(map[k] || k), type: ''}));
                }
            }
            // â€”â€” å¦‚æœä»ç„¶æ²¡æœ‰åˆ—å®šä¹‰ï¼Œç”¨ç¬¬ä¸€æ¡æ•°æ®çš„å­—æ®µåå…œåº•ç”Ÿæˆåˆ—
            if ((!FIELDS || !FIELDS.length) && Array.isArray(data.items) && data.items.length) {
                const first = data.items.find(x => x && x.data) || {data: {}};
                FIELDS = Object.keys(first.data || {}).map(k => ({key: k, label: k, type: ''}));
                // è¿˜æ˜¯â€œæœ‰å¯è¯»å°±è¿‡æ»¤â€ï¼Œå¦åˆ™ä¿ç•™å…¨éƒ¨
                const nonRandom2 = FIELDS.filter(f => !looksRandom(f.key));
                if (nonRandom2.length) FIELDS = nonRandom2;
            }

            buildHeader(); // å…ˆ/é‡æ–°æŒ‰ FIELDS åˆ·æ–°è¡¨å¤´
            renderRows(data.items || data.rows || []);
            document.dispatchEvent(new CustomEvent('responses:updated'));
        }
        window.loadResponses = load;


        // â€”â€” ç‚¹å‡»äº‹ä»¶ï¼šæ–‡ä»¶é¢„è§ˆ / å®¡æ ¸ / å‘ä¿¡ / åˆ é™¤
        document.addEventListener("click", async (e) => {
            const a = e.target.closest('a[data-preview]');
            if (a) {
                e.preventDefault();
                e.stopPropagation();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
                openPreviewInModal && openPreviewInModal(a.getAttribute('href'));
                return;
            }

            const tr = e.target.closest("tr[data-id]");
            if (!tr) return;
            const id = Number(tr.dataset.id);
            const cmt = tr.querySelector(".cmt")?.value?.trim() || "";

            if (e.target.matches("[data-approve],[data-reject]")) {
                const status = e.target.hasAttribute("data-approve") ? "å·²é€šè¿‡" : "æœªé€šè¿‡";
                try {
                    await jget(`/site/${encodeURIComponent(SITE)}/admin/api/review`, {
                        method: "POST", headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({id, status, review_comment: cmt})
                    });
                    const pill = tr.querySelector(".pill");
                    pill.textContent = status;
                    pill.className = `pill ${status === "å·²é€šè¿‡" ? "good" : "bad"}`;
                } catch (err) {
                    alert("ä¿å­˜å¤±è´¥ï¼š" + err.message);
                }
                document.dispatchEvent(new CustomEvent('responses:updated'));
            }

            if (e.target.matches("[data-del]")) {
                if (!confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
                try {
                    await jget(`/site/${encodeURIComponent(SITE)}/admin/api/delete`, {
                        method: "POST", headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({id})
                    });
                    tr.remove();
                } catch (err) {
                    alert("åˆ é™¤å¤±è´¥ï¼š" + err.message);
                }
            }
            document.dispatchEvent(new CustomEvent('responses:updated'));
        });

        window.rebuildRespHeader = buildHeader;
        window.rebuildRespHeader && window.rebuildRespHeader();
        if (document.getElementById('tab-responses')?.classList.contains('active')) {
            window.loadResponses && window.loadResponses();
        }

    })();
</script>

<!-- æ¥ç®¡â€œå›å¤â€é¡µæ—§é¢„è§ˆï¼ˆéšè—æ—§å®ç°ï¼‰ -->
<style>
    #respPreviewMask, .resp-preview-mask {
        display: none !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  function rewire(id, type, handler) {
    const old = document.getElementById(id);
    if (!old || !old.parentNode) return null;
    const clone = old.cloneNode(true);
    old.parentNode.replaceChild(clone, old);
    clone.addEventListener(type, function (e) {
      e.preventDefault(); e.stopPropagation();
      if (e.stopImmediatePropagation) e.stopImmediatePropagation();
      handler(e);
    }, { capture: true });
    return clone;
  }

  const SITE = document.body.dataset.site || "";

  rewire('btnRefresh', 'click', () => window.loadResponses && window.loadResponses());
  rewire('btnSearch',  'click', () => window.loadResponses && window.loadResponses());
  rewire('btnExportAll', 'click', () => {
    location.href = `/site/${encodeURIComponent(SITE)}/admin/api/export_all_excel`;
  });
  rewire('btnGallery', 'click', async () => {
    try {
      const r = await fetch(`/site/${encodeURIComponent(SITE)}/admin/api/gallery`);
      const data = await r.json().catch(() => ({ items: [] }));
      alert(`æ‰¾åˆ°å›¾ç‰‡ ${(data.items || []).length} å¼ `);
    } catch { alert('åŠ è½½å¤±è´¥'); }
  });

  // â€”â€” è‡ªåŠ¨åˆ·æ–°ï¼šä»…â€œæ•°æ®â€Tab ä¸”é¡µé¢å¯è§æ—¶æ‰è·‘ â€”â€” //
  let autoTimer = null;
  function stopAuto() { if (autoTimer) { clearInterval(autoTimer); autoTimer = null; } }
  function onResponsesTab() { return document.getElementById('tab-responses')?.classList.contains('active'); }
  function tickOnceIfVisible() {
    if (document.visibilityState === 'visible' && onResponsesTab()) {
      window.loadResponses && window.loadResponses();
    }
  }

  rewire('autoTick', 'change', (e) => {
    stopAuto();
    if (e.currentTarget.checked) {
      autoTimer = setInterval(tickOnceIfVisible, 30000);
      tickOnceIfVisible(); // ç«‹å³è·‘ä¸€æ¬¡ï¼ˆä»…å‰å°&åœ¨æ•°æ®é¡µæ—¶ï¼‰
    }
  });

  // åˆ‡åˆ°å…¶ä»– Tab å°±åœ
  document.querySelectorAll('.tabs button').forEach(b => {
    b.addEventListener('click', () => { if (b.dataset.tab !== 'responses') stopAuto(); });
  });

  // é¡µé¢é‡æ–°å¯è§æ—¶è¡¥ä¸€æ¬¡
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') tickOnceIfVisible();
  });

  // å…³é—­é¡µé¢å‰æ¸…ç†
  window.addEventListener('beforeunload', stopAuto);

  // é»˜è®¤ä¸å¯ç”¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæœ‰è€HTMLæŠŠ checked å¸¦ä¸Šæ—¶ï¼Œå¼ºåˆ¶å…³æ‰ï¼‰
  const autoTick = document.getElementById('autoTick');
  if (autoTick) autoTick.checked = false;

  // é¦–æ¬¡ï¼šé‡å»ºè¡¨å¤´ï¼›å¦‚æœå½“å‰å°±åœ¨â€œæ•°æ®â€é¡µï¼Œæ‰‹åŠ¨æ‹‰ä¸€æ¬¡
  window.rebuildRespHeader && window.rebuildRespHeader();
  if (onResponsesTab()) window.loadResponses && window.loadResponses();
});
</script>


<!-- è®©é¡¶æ å§‹ç»ˆå›ºå®šåœ¨é¡¶éƒ¨ï¼ˆè¦†ç›–åŸæ¥çš„ stickyï¼‰ -->
<style id="header-follow">
    header {
        position: fixed !important;
        top: 0;
        left: 0;
        right: 0;
        z-index: 999;
        width: 100%;
    }
</style>

<!-- æ ¹æ®å®é™…é«˜åº¦ç»™ body å¢åŠ  padding-topï¼Œé¿å…å†…å®¹è¢«é¡¶æ é®ä½ -->
<script id="header-padding-fix">
    (function () {
        const header = document.querySelector('header');
        if (!header) return;

        function applyOffset() {
            document.body.style.paddingTop = header.offsetHeight + 'px';
        }

        window.addEventListener('load', applyOffset);
        window.addEventListener('resize', applyOffset);

        try {
            new ResizeObserver(applyOffset).observe(header);
        } catch (_) {
        }
    })();
</script>

<script>
    /* å…¨å±€æ–‡ä»¶é¢„è§ˆï¼ˆå›¾ç‰‡/è§†é¢‘/éŸ³é¢‘/å…¶ä»–ç”¨ iframeï¼‰ */
    window.openPreviewInModal = function (url) {
        const modal = document.getElementById('filePreview');
        const body = document.getElementById('filePreviewBody');
        if (!modal || !body) {
            window.open(url, '_blank');
            return;
        }

        const clean = (u) => {
            if (!u) return '';
            if (u.startsWith('/')) return location.origin + u;
            return /^(https?:|blob:|data:)/i.test(u) ? u : '';
        };
        const safe = clean(url);

        // è§£æ data: çš„ MIMEï¼ˆç”¨äºå…è®¸ img/video/audioï¼Œæ‹’ç» iframeï¼‰
        const isData = /^data:/i.test(safe);
        const dataMime = isData ? ((safe.match(/^data:([^;,]+)/i) || [,''])[1] || '').toLowerCase() : '';
        const isSVGData = isData && dataMime === 'image/svg+xml';
        const ext = (safe.split('?')[0].split('#')[0].match(/\.([a-z0-9]+)$/i) || [])[1]?.toLowerCase() || '';

        body.innerHTML = '';

        // ç¦æ­¢ï¼šdata:image/svg+xmlï¼ˆæ›´å®‰å…¨ï¼‰
        if (isSVGData) {
            body.innerHTML = `<div style="padding:12px;color:#6b7f99">ä¸æ”¯æŒé¢„è§ˆæ­¤ç±»å‹çš„ data: é“¾æ¥</div>`;
        }
        else if ((['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp', 'svg'].includes(ext)) || (isData && dataMime.startsWith('image/'))) {
            body.innerHTML = `<img src="${safe}" style="max-width:100%;height:auto;border-radius:12px">`;
        }
        // å…è®¸ï¼šè§†é¢‘
        else if ((['mp4','webm','ogg'].includes(ext)) || (isData && dataMime.startsWith('video/'))) {
            body.innerHTML = `<video src="${safe}" controls style="width:100%;max-height:70vh;border-radius:12px"></video>`;
        }
        // å…è®¸ï¼šéŸ³é¢‘
        else if ((['mp3','wav','aac','flac','m4a','oga'].includes(ext)) || (isData && dataMime.startsWith('audio/'))) {
            body.innerHTML = `<audio src="${safe}" controls style="width:100%"></audio>`;
        }
        // ç¦æ­¢ï¼šå…¶å®ƒ data: åœ¨ iframe ä¸­æ‰“å¼€ï¼ˆé˜² XSSï¼‰
        else if (isData) {
            body.innerHTML = `<div style="padding:12px;color:#6b7f99">ä¸æ”¯æŒé¢„è§ˆæ­¤ç±»å‹çš„ data: é“¾æ¥</div>`;
        }
        // å…¶å®ƒï¼šiframe é¢„è§ˆ
        else {
            const sandbox = 'allow-forms allow-downloads allow-popups-to-escape-sandbox';
            body.innerHTML = `<iframe src="${safe}" sandbox="${sandbox}" referrerpolicy="no-referrer"
    style="width:100%;height:70vh;border:0;border-radius:12px;background:#fff"></iframe>`;
        }


        modal.classList.add('show');
        modal.style.display = 'flex';
    };

    document.getElementById('closeFilePreview')?.addEventListener('click', () => {
        const m = document.getElementById('filePreview');
        if (m) {
            m.classList.remove('show');
            m.style.display = 'none';
        }
    });
    document.getElementById('filePreview')?.addEventListener('click', (e) => {
        if (e.target.id === 'filePreview') {
            e.currentTarget.classList.remove('show');
            e.currentTarget.style.display = 'none';
        }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script id="charts-client">
(function () {
  if (window.__CHARTS_CLIENT_INITED__) return;
  window.__CHARTS_CLIENT_INITED__ = true;

  const SITE = document.body.dataset.site || '';
  let chartsInited = false;
  let chartObjs = [];

  // åˆå§‹å°±åœ¨â€œå›¾è¡¨â€Tabæ—¶ï¼Œç«‹å³ç»˜åˆ¶ä¸€æ¬¡
  if (document.querySelector('.tabs button.active')?.dataset.tab === 'charts') {
    refreshCharts(true);
  }

  // ä¿å­˜/åˆ·æ–°æŒ‰é’®ï¼ˆå”¯ä¸€ç»‘å®šç‚¹ï¼‰
  document.getElementById('btnSaveCharts')?.addEventListener('click', async () => {
    try { await (window.saveChartsConfig?.()); } finally { refreshCharts(true); }
  });
  document.getElementById('btnRefreshCharts')?.addEventListener('click', () => refreshCharts(true));

  async function fetchJSON(url) {
    const r = await fetch(url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(), {
      credentials: 'same-origin',
      headers: {'Accept': 'application/json', 'Cache-Control': 'no-cache'}
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok || j.ok === false) throw new Error(j.error || ('HTTP ' + r.status));
    return j;
  }

  async function getChartsConfig() {
    const list = document.getElementById('chart-settings-list');
    const rows = list ? Array.from(list.querySelectorAll(':scope > div')) : [];
    const cfg = rows.map(w => {
      const title = (w.querySelector('.chart-title')?.value || '').trim();
      const type  = (w.querySelector('.chart-type')?.value || 'pie').trim();
      return title ? { field: title, label: title, type } : null;
    }).filter(Boolean);
    if (cfg.length) return cfg;
    if (!SITE) return [];
    try {
      const j = await fetchJSON(`/site/${encodeURIComponent(SITE)}/admin/api/charts_config`);
      const arr = j?.config?.charts;
      if (Array.isArray(arr) && arr.length) {
        return arr.map(x => ({ field: x.field || x.label || '', label: x.label || x.field || '', type: x.type || 'pie' }))
                 .filter(x => x.field);
      }
    } catch {}
    return [];
  }

  async function getColumns() {
    if (!SITE) return {cols: [], titleToKey: {}};
    const j = await fetchJSON(`/site/${encodeURIComponent(SITE)}/admin/api/submissions`);
    const cols = Array.isArray(j.columns) ? j.columns : [];
    const titleToKey = {};
    cols.forEach(c => {
      const title = (c.title || c.label || c.text || c.name || c.key || '').trim();
      const key   = (c.key   || c.id    || c.name || '').trim();
      if (title && key) titleToKey[title] = key;
    });
    return {cols, titleToKey};
  }

  async function getResponses() {
    if (!SITE) return [];
    const j = await fetchJSON(`/site/${encodeURIComponent(SITE)}/admin/api/responses`);
    return Array.isArray(j.items) ? j.items : (Array.isArray(j.rows) ? j.rows : []);
  }

  function toArray(val) {
    if (val == null) return [];
    if (Array.isArray(val)) return val.flatMap(toArray);
    if (typeof val === 'object') {
      const p = val.label || val.name || val.title || val.value || val.filename || val.file;
      return p ? [String(p)] : Object.values(val).flatMap(toArray);
    }
    const s = String(val).trim();
    if (!s) return [];
    if (s.includes(',') || /\r?\n/.test(s)) return s.split(/,|\r?\n/).map(x => x.trim()).filter(Boolean);
    return [s];
  }

  function countByValue(items, key) {
    const map = new Map();
    for (const it of items) {
      const v = it?.data ? it.data[key] : undefined;
      const arr = toArray(v);
      for (const one of arr) map.set(one, (map.get(one) || 0) + 1);
    }
    return Array.from(map.entries()).map(([value, count]) => ({value, count})).sort((a,b)=>b.count-a.count);
  }

  function countDaily(items, key) {
    const map = new Map();
    for (const it of items) {
      const raw = it.created_at || it.created || it.date;
      if (!raw) continue;
      const d = new Date(raw);
      if (isNaN(d)) continue;
      const has = it?.data && it.data[key] != null && String(it.data[key]).trim() !== '';
      if (!has) continue;
      const ymd = d.toISOString().slice(0,10);
      map.set(ymd, (map.get(ymd) || 0) + 1);
    }
    return Array.from(map.entries()).map(([date,count])=>({date,count})).sort((a,b)=>a.date.localeCompare(b.date));
  }

  function clearCharts(){
    chartObjs.forEach(c=>{ try{ c.destroy(); }catch{} });
    chartObjs = [];
    const root = document.getElementById('chartsRoot');
    if (root) root.innerHTML = '';
  }

  function addCard(root, title, id, full = false){
    const card = document.createElement('div');
    card.className = 'chart-card';
    if (full) card.style.gridColumn = '1/-1';
    card.style.background = '#fff';
    card.style.border = '1px solid #e8eef6';
    card.style.borderRadius = '14px';
    card.innerHTML = `<div style="padding:12px 14px;font-weight:800;color:#0e1726">${title}</div>
                      <div style="padding:0 14px 14px"><canvas id="${id}" height="120"></canvas></div>`;
    root.appendChild(card);
    return document.getElementById(id).getContext('2d');
  }

  function showEmpty(ctx, msg){
    const wrap = ctx.canvas.parentElement;
    wrap.innerHTML = `<div style="min-height:200px;display:flex;align-items:center;justify-content:center;color:#6b7f99">${msg}</div>`;
  }

  async function ensureCharts(){
    if (chartsInited) return;
    const root = document.getElementById('chartsRoot');
    if (!root) return;

    if (!SITE) {
      root.innerHTML = `<div style="grid-column:1/-1;color:#6b7f99;background:#fff;border:1px solid #e8eef6;border-radius:14px;padding:16px;text-align:center">ä¿å­˜è¡¨å•å¹¶ç”Ÿæˆç«™ç‚¹åï¼Œæ‰èƒ½æŸ¥çœ‹å›¾è¡¨ã€‚</div>`;
      return;
    }

    chartsInited = true;
    clearCharts();

    try{
      const charts = await getChartsConfig();
      const [{cols, titleToKey}, items] = await Promise.all([getColumns(), getResponses()]);

      let plan = charts;
      if (!plan.length && cols.length) {
        plan = cols.slice(0,2).map(c=>{
          const t = (c.title || c.label || c.text || c.name || c.key || '').trim();
          return { field: t, label: t, type: 'pie' };
        });
      }

      if (!plan.length){
        root.innerHTML = `<div style="grid-column:1/-1;color:#6b7f99;background:#fff;border:1px solid #e8eef6;border-radius:14px;padding:16px;text-align:center">è¯·åœ¨ä¸Šæ–¹â€œå›¾è¡¨è®¾ç½®â€é‡Œè‡³å°‘è¾“å…¥ä¸€ä¸ªé¢˜ç›®æ ‡é¢˜å¹¶ä¿å­˜ï¼Œç„¶åç‚¹å‡»â€œåˆ·æ–°å›¾è¡¨â€ã€‚</div>`;
        chartsInited = false;
        return;
      }

      plan.forEach((ch, idx)=>{
        const title = ch.label || ch.field;
        const key = titleToKey[title] || title;
        const ctx = addCard(root, `${title}ï¼ˆ${ch.type === 'pie' ? 'é¥¼å›¾' : ch.type === 'line' ? 'çº¿è¡¨' : 'æµç¨‹è¡¨'}ï¼‰`, `chart_${idx}`, ch.type === 'flow');

        let cfg = null;
        if (ch.type === 'line'){
          const daily = countDaily(items, key);
          if (daily.length){
            cfg = { type:'line', data:{ labels: daily.map(x=>x.date), datasets:[{ label:title, data: daily.map(x=>x.count), tension:.3 }]}, options:{ responsive:true, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, ticks:{precision:0} } } } };
          }
        } else if (ch.type === 'pie'){
          const rows = countByValue(items, key);
          if (rows.length){
            cfg = { type:'doughnut', data:{ labels: rows.map(x=>x.value), datasets:[{ data: rows.map(x=>x.count)}] }, options:{ responsive:true } };
          }
        } else { // flow -> æ¨ªå‘æŸ±çŠ¶
          const rows = countByValue(items, key);
          if (rows.length){
            cfg = { type:'bar', data:{ labels: rows.map(x=>x.value), datasets:[{ label:title, data: rows.map(x=>x.count)}] }, options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{ x:{ beginAtZero:true, ticks:{precision:0} } } } };
          }
        }

        if (cfg) chartObjs.push(new Chart(ctx, cfg)); else showEmpty(ctx, 'æš‚æ— æ•°æ®');
      });

    }catch(e){
      root.innerHTML = `<div style="grid-column:1/-1;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:14px;padding:12px">å›¾è¡¨æ•°æ®åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
      chartsInited = false;
    }
  }

  window.refreshCharts = function(force=false){
    if (force) chartsInited = false;
    ensureCharts();
  };

  // æ•°æ®æ›´æ–° â†’ è‹¥å½“å‰åœ¨â€œå›¾è¡¨â€é¡µï¼Œè‡ªåŠ¨é‡ç»˜ï¼ˆè¡¥é½ç¼ºå¤±çš„æ”¶å£ï¼‰
    let __chartRaf;
    document.addEventListener('responses:updated', () => {
        if (!document.getElementById('tab-charts')?.classList.contains('active')) return;
        cancelAnimationFrame(__chartRaf);
        __chartRaf = requestAnimationFrame(() => refreshCharts(true));
    });
})();
</script>

<style>
    /* ä¸æ»‘å‡ºç°åŠ¨ç”» */
    #successModal.show #successBox {
        animation: popIn .22s cubic-bezier(.2, .9, .2, 1) forwards;
    }

    @keyframes popIn {
        from {
            opacity: 0;
            transform: scale(.92) translateY(8px)
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0)
        }
    }

    @media (prefers-reduced-motion: reduce) {
        #successModal.show #successBox {
            animation: none;
            opacity: 1;
            transform: none;
        }
    }
</style>

<script id="success-modal-api">
(function(){
  if (window.openModal) return;

  function close(){
    const m = document.getElementById('successModal');
    const f = document.getElementById('successFrame');
    if (m){ m.classList.remove('show'); m.style.display='none'; }
    if (f){ f.src='about:blank'; }
  }

  // æ‰“å¼€ä¸­é—´å¼¹çª—å¹¶åŠ è½½æˆåŠŸé¡µ
  window.openModal = function(url){
    const m = document.getElementById('successModal');
    const f = document.getElementById('successFrame');
    if (!m || !f) { location.href = url; return; }
    f.src = url;
    m.classList.add('show');
    m.style.display = 'flex';
  };

  // ç‚¹å‡»è’™å±‚å…³é—­
  document.getElementById('successModal')?.addEventListener('click', e => {
    if (e.target.id === 'successModal') close();
  });
  // ESC å…³é—­
  document.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });
})();
</script>

<script id="submit-save">
    document.getElementById('builder')?.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const form = ev.currentTarget;

        // åªå‘å¿…è¦å­—æ®µï¼Œé¿å…æŠŠ file å¸¦ä¸Š
        const fd = new FormData();
        const nameEl = form.querySelector('[name="form_name"]');
        const siteEl = form.querySelector('[name="site_name"]');
        const descEl = form.querySelector('[name="form_desc"]');
        const schemaEl = document.getElementById('schema_json');

        fd.append('form_name', nameEl?.value || '');
        fd.append('site_name', siteEl?.value || '');
        fd.append('form_desc', descEl?.value || '');
        fd.append('schema_json', schemaEl?.value || '{}');

        try {
            const raw = fd.get('schema_json') || '{}';
            const schema = JSON.parse(raw);

            // æŒ‰ä½ ç°æœ‰é€»è¾‘æŠŠèƒŒæ™¯å›¾/é¢˜ç›®é¢œè‰²/å®¡æ ¸å¼€å…³å†™å› schema
            const cover = document.getElementById('headerImageUrl')?.value?.trim();
            if (cover && !cover.startsWith('data:') && !cover.startsWith('blob:')) {
                (schema.header ||= {}).title_image = cover;
            }
            const sw = document.querySelector('[data-skey="submission.require_review"]');
            (schema.submission ||= {}).require_review = !!sw?.checked;

            fd.set('schema_json', JSON.stringify(schema));
        } catch (e) {
            console.warn(e);
        }
        const u = new URL(form.action, location.origin);
        u.searchParams.set('ajax', '1');
        try {
            const res = await fetch(u, {
                method: 'POST',
                body: fd,
                headers: {'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest'}
            });
            const j = await readJSONSafely(res);
            if (!res.ok || j.ok === false) return alert(j.error || ('ä¿å­˜å¤±è´¥ï¼šHTTP ' + res.status));

            const site = j.site_name || new URLSearchParams(location.search).get('site') || '';
            const pub = j.public_url || (site ? (location.origin + '/f/' + encodeURIComponent(site)) : '');
            if (!pub) return alert('ä¿å­˜æˆåŠŸï¼Œä½†ç¼ºå°‘ç«™ç‚¹å');

// æ—§çš„å°å¼¹å±‚ï¼ˆå¤åˆ¶é“¾æ¥ç”¨ï¼‰â€”â€”ç•™ç€
            const $modal = document.getElementById('linkModal');
            const $inp = document.getElementById('pubUrl');
            if ($inp) {
                $inp.value = pub;
                $inp.setAttribute('value', pub);
            }
            if ($modal) $modal.classList.add('show');

// ä¸­é—´å¤§å¼¹å±‚ï¼ˆæ¢å¤çš„è¿™ä¸ªï¼‰â€”â€”å…³é”®ä¸€è¡Œ
            const successURL = j.success_url || (site ? (`/site/${encodeURIComponent(site)}/create_success`) : '');
            if (successURL) {
                (typeof openModal === 'function') ? openModal(successURL) : (location.href = successURL);
            }

            document.getElementById('pubUrl')?.focus();
            // è¿™é‡Œæ²¿ç”¨ä½ åŸæ¥çš„æˆåŠŸå¼¹çª—é€»è¾‘ï¼ˆå¦‚æœä½ æœ‰ openModal å°±ç”¨å®ƒï¼‰
        } catch (e) {
            alert('ä¿å­˜å¤±è´¥ï¼š' + e.message);
        }
    }, true);
</script>


<script id="live-theme-sync">
    (function () {
        const root = document.documentElement;
        const body = document.body;

        // è®¾ç½®é¢æ¿é‡Œçš„æ§ä»¶
        const lightPicker = document.querySelector('[data-skey="theme.brand"][type="color"]');
        const lightText = document.querySelector('.tiny[data-skey="theme.brand"]:not([type="color"])');
        const darkText = document.querySelector('[data-skey="theme.brand_dark"]'); // ä½ æš‚æ—¶æ²¡è¿™ä¸ªè¾“å…¥ï¼Œæœ‰å°±ä¼šç”Ÿæ•ˆ
        const appearance = document.querySelector('[data-skey="theme.appearance"]');

        // ä» schema_json / æœ¬åœ°å·²å¡«å€¼ä¸­æ¢å¤
        function readSchemaTheme() {
            // 1) schema_jsonï¼ˆéšè—åŸŸæˆ– <script id="schemaJSON">ï¼‰é‡Œ
            const raw = document.getElementById('schema_json')?.value
                || document.getElementById('schemaJSON')?.textContent
                || '';
            let j = null;
            try {
                j = JSON.parse(raw || 'null');
            } catch {
            }
            const t = (j && j.theme) || {};
            // 2) è¡¨å•å½“å‰è¾“å…¥å€¼å…œåº•
            const light = (lightPicker?.value || lightText?.value || t.brand || '#2563eb').trim();
            const dark = (darkText?.value || t.brand_dark || '').trim() || light;
            const mode = (appearance?.value || t.appearance || 'auto').toLowerCase();
            return {light, dark, mode};
        }

        function setCSS(light, dark) {
            root.style.setProperty('--brand-light', light);
            root.style.setProperty('--brand-dark', dark);
            const cur = body.getAttribute('data-appearance') === 'dark' ? dark : light;
            root.style.setProperty('--brand', cur);
        }

        function apply() {
            const {light, dark, mode} = readSchemaTheme();
            // å†™å…¥ CSS å˜é‡
            setCSS(light, dark);
            // åŒæ­¥ä¸¤ä¸ªâ€œä¸»é¢˜è‰²â€è¾“å…¥
            if (lightPicker && lightText) {
                if (lightPicker.value !== light) lightPicker.value = light;
                if (lightText.value !== light) lightText.value = light;
            }
            // å¦‚æœè®¾ç½®é‡Œåˆ‡äº†å¤–è§‚ï¼Œä¹ŸåŒæ­¥åˆ°é¡µé¢
            if (appearance && (mode === 'light' || mode === 'dark' || mode === 'auto')) {
                if (mode === 'auto') {
                    // ä¿æŒ data-appearance ä¸å˜ï¼›æŒ‰é’®åˆ‡æ¢é€»è¾‘æ§åˆ¶
                } else {
                    body.setAttribute('data-appearance', mode);
                }
            }
        }

        // ç›‘å¬è®¾ç½®å˜åŒ–ï¼šé¢œè‰² & å¤–è§‚
        ['input', 'change'].forEach(ev => {
            lightPicker?.addEventListener(ev, apply);
            lightText?.addEventListener(ev, apply);
            darkText?.addEventListener(ev, apply);
            appearance?.addEventListener('change', apply);
        });

        // ç›‘å¬å³ä¸Šè§’â€œğŸŒ—â€æŒ‰é’®ï¼Œåˆ‡æ¢æ—¶åŒæ—¶åˆ‡æ¢ --brand
        document.getElementById('btnTheme')?.addEventListener('click', () => {
            const next = body.getAttribute('data-appearance') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-appearance', next);
            const l = getComputedStyle(root).getPropertyValue('--brand-light').trim() || '#2563eb';
            const d = getComputedStyle(root).getPropertyValue('--brand-dark').trim() || l;
            root.style.setProperty('--brand', next === 'dark' ? d : l);
        });

        // é¦–æ¬¡åº”ç”¨
        apply();
    })();
</script>

<script>
    (function () {
        // 1) åˆ¤å®šæ˜¯å¦å¸¦ new=1
        var params = new URLSearchParams(location.search);
        var hasNewFlag = params.get('new') === '1' || /\/create_form\/new$/.test(location.pathname);

        // 2) åˆ¤å®šå¯¼èˆªç±»å‹ï¼šåªåœ¨çœŸæ­£çš„ navigate æ—¶æ¸…ï¼›reload / back_forward ä¸æ¸…
        var nav = (performance.getEntriesByType && performance.getEntriesByType('navigation')[0]) || null;
        var navType = nav ? nav.type
            : (performance.navigation ? (['navigate', 'reload', 'back_forward', 'prerender'][performance.navigation.type] || 'navigate') : 'navigate');
        var isReload = navType === 'reload';
        var isBackFwd = navType === 'back_forward';

        if (hasNewFlag && !isReload && !isBackFwd) {
            try {
                sessionStorage.removeItem('builder:draft_id');
            } catch (e) {
            }
            // åŒæ—¶æŠŠ window.name æ¸…æ‰ï¼Œç¡®ä¿â€œæ–°å»ºâ€å¾—åˆ°ä¸€ä¸ªå…¨æ–°çš„ tab id
            try {
                window.name = '';
            } catch (e) {
            }
            // æŠŠ ?new=1 ä»åœ°å€æ ç§»é™¤ï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
            try {
                if (params.has('new')) {
                    params.delete('new');
                    var newURL = location.pathname + (params.toString() ? '?' + params.toString() : '');
                    history.replaceState(null, '', newURL);
                }
            } catch (e) {
            }
        }

        // 3) ç”Ÿæˆè‰ç¨¿é”®ï¼šæœ‰ç«™ç‚¹å=ç¼–è¾‘å·²æœ‰ï¼Œç”¨ site é”å®šï¼›å¦åˆ™ç”¨â€œæœ¬æ ‡ç­¾é¡µ idâ€
        var SITE = "{{ site_name or '' }}";
        var TPL = "{{ tpl or '' }}";
        var draftId;

        if (SITE) {
            draftId = 'site:' + SITE;        // ç¼–è¾‘å·²æœ‰ï¼šç«™ç‚¹å”¯ä¸€
        } else if (TPL) {
            draftId = 'tpl:' + TPL;          // æ¨¡æ¿æ–°å»ºï¼šæŒ‰æ¨¡æ¿å›ºå®šï¼ˆåˆ·æ–°ä¸æ–°å¼€ï¼‰
        } else {
            // é€€å›ä½ åŸæ¥çš„ window.name é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
            try {
                draftId = sessionStorage.getItem('builder:draft_id') || '';
            } catch (e) {
                draftId = '';
            }
            if (!draftId) {
                if (!window.name || !/^tab:/.test(window.name)) {
                    var gen = (crypto && crypto.randomUUID) ? crypto.randomUUID()
                        : (Date.now().toString(36) + Math.random().toString(36).slice(2, 8));
                    try {
                        window.name = 'tab:' + gen;
                    } catch (e) {
                    }
                }
                draftId = window.name;
                try {
                    sessionStorage.setItem('builder:draft_id', draftId);
                } catch (e) {
                }
            }
        }


        var KEY = 'draft:builder:' + draftId;
        try {
            localStorage.setItem('builder:currentKey', KEY);
        } catch (e) {
        }

        // 4) ç»‘å®šä¿å­˜/æ¢å¤
        var form = document.getElementById('builder') || document.querySelector('form');
        if (!form) return;

        function serialize() {
            var data = {};
            try {
                var fd = new FormData(form);
                fd.forEach(function (v, k) {
                    if (data[k] === undefined) data[k] = v;
                    else if (Array.isArray(data[k])) data[k].push(v);
                    else data[k] = [data[k], v];
                });
            } catch (e) {
            }
            // contenteditable
            var ces = Array.from(document.querySelectorAll('[contenteditable="true"]'));
            data.__ce = ces.map(function (el) {
                return {path: pathOf(el), html: el.innerHTML};
            });
            // å¤–è§‚å¿«ç…§
            data.__appearance = document.body.getAttribute('data-appearance') || '';
            var brand = getComputedStyle(document.documentElement).getPropertyValue('--brand').trim();
            if (brand) data.__brand = brand;
            return data;
        }

        function restore(data) {
            if (!data) return;
            Object.keys(data).forEach(function (k) {
                if (k.startsWith('__')) return;
                var els = form.querySelectorAll('[name="' + CSS.escape(k) + '"]');
                if (!els.length) return;
                var val = data[k], values = Array.isArray(val) ? val : [val];
                els.forEach(function (el) {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = values.indexOf(el.value) >= 0;
                    } else {
                        el.value = values[0];
                    }
                });
            });
            if (Array.isArray(data.__ce)) {
                data.__ce.forEach(function (item) {
                    var el = queryPath(item.path);
                    if (el) el.innerHTML = item.html;
                });
            }
            if (data.__appearance) document.body.setAttribute('data-appearance', data.__appearance);
            if (data.__brand) document.documentElement.style.setProperty('--brand', data.__brand);
            tip('å·²ä»è‰ç¨¿æ¢å¤');
        }

        function save() {
            try {
                localStorage.setItem(KEY, JSON.stringify(serialize()));
            } catch (e) {
            }
        }

        function load() {
            try {
                var raw = localStorage.getItem(KEY);
                if (raw) restore(JSON.parse(raw));
            } catch (e) {
            }
        }

        document.addEventListener('input', save, true);
        document.addEventListener('change', save, true);
        document.addEventListener('blur', save, true);
        load();

        // ========== å·¥å…· ==========
        function pathOf(el) {
            var path = [], cur = el;
            while (cur && cur.nodeType === 1 && cur !== document.body) {
                var i = 0, s = cur;
                while (s = s.previousElementSibling) i++;
                path.unshift(cur.tagName.toLowerCase() + ':' + i);
                cur = cur.parentElement;
            }
            return path.join('/');
        }

        function queryPath(path) {
            var parts = (path || '').split('/'), ctx = document.body;
            for (var i = 0; i < parts.length; i++) {
                var p = parts[i];
                if (!p) continue;
                var a = p.split(':'), tag = a[0], idx = +a[1];
                var kids = [].filter.call(ctx.children, function (x) {
                    return x.tagName.toLowerCase() === tag;
                });
                ctx = kids[idx] || null;
                if (!ctx) break;
            }
            return ctx;
        }

        function tip(msg) {
            var t = document.getElementById('draft-toast');
            if (!t) {
                t = document.createElement('div');
                t.id = 'draft-toast';
                t.style.cssText = 'position:fixed;z-index:2147483647;top:12px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:999px;font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.2)';
                document.body.appendChild(t);
            }
            t.textContent = msg;
            t.style.opacity = '1';
            setTimeout(function () {
                t.style.transition = 'opacity .6s';
                t.style.opacity = '0';
            }, 1600);
        }
    })();
</script>

<script id="charts-settings-inline">
(function () {
  const SITE = document.body.dataset.site || '';

  function $(id){ return document.getElementById(id); }
  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  // ä¸€è¡Œè®¾ç½®ï¼šé¢˜ç›®æ ‡é¢˜ + ç±»å‹ + åˆ é™¤
  function row(title = '', type = 'pie') {
    const wrap = document.createElement('div');
    wrap.style.cssText = 'display:flex;gap:8px;align-items:center;margin:6px 0';
    wrap.innerHTML = `
      <input class="chart-title tiny" placeholder="é¢˜ç›®æ ‡é¢˜(å¿…å¡«)" value="${esc(title)}" list="chart-title-list" style="max-width:260px">
      <select class="chart-type tiny" style="max-width:140px">
        <option value="pie"  ${type==='pie' ? 'selected':''}>åœ†å½¢è¡¨</option>
        <option value="line" ${type==='line'? 'selected':''}>çº¿è¡¨</option>
        <option value="flow" ${type==='flow'? 'selected':''}>æµç¨‹è¡¨</option>
      </select>
      <button type="button" class="btn gray" data-del>åˆ é™¤</button>
    `;
    wrap.querySelector('[data-del]').onclick = () => wrap.remove();
    return wrap;
  }

  // è‡ªåŠ¨è¡¥å…¨ï¼šä»åç«¯ columns å–â€œæ ‡é¢˜/æ ‡ç­¾/åç§°â€
  async function loadCandidateTitles(){
    const dl = $('chart-title-list'); if (!dl) return;
    dl.innerHTML = '';
    if (!SITE) return;
    try{
      const r = await fetch(`/site/${encodeURIComponent(SITE)}/admin/api/submissions`, {credentials:'same-origin'});
      const j = await r.json();
      const cols = Array.isArray(j.columns) ? j.columns : [];
      const names = cols.map(c => c.title || c.label || c.text || c.name || c.key).filter(Boolean);
      const uniq = [...new Set(names)];
      dl.innerHTML = uniq.map(t => `<option value="${esc(t)}"></option>`).join('');
    }catch(_){}
  }

  // è¯»å–å·²å­˜é…ç½®
  async function loadConfig(){
    const list = $('chart-settings-list'); if (!list) return;
    list.innerHTML = '';
    if (!SITE) { list.appendChild(row()); return; }
    try{
      const r = await fetch(`/site/${encodeURIComponent(SITE)}/admin/api/charts_config`, {credentials:'same-origin'});
      const j = await r.json();
      const charts = j && j.ok && j.config && Array.isArray(j.config.charts) ? j.config.charts : [];
      (charts.length ? charts : [{}, {}]).forEach(ch => {
        list.appendChild(row(ch.field || ch.label || '', ch.type || 'pie'));
      });
    }catch(_){ list.appendChild(row()); }
  }

  // ä¿å­˜é…ç½®ï¼šåªå‘ [{ field, type, label }]
  async function save(){
    const list = $('chart-settings-list');
    if (!SITE) return alert('è¯·å…ˆä¿å­˜è¡¨å•ç”Ÿæˆç«™ç‚¹');
    const payload = [];
    list.querySelectorAll(':scope > div').forEach(w=>{
      const title = w.querySelector('.chart-title')?.value.trim();
      if (!title) return;
      payload.push({ field: title, type: w.querySelector('.chart-type')?.value || 'pie', label: title });
    });

    try{
      const r = await fetch(`/site/${encodeURIComponent(SITE)}/admin/api/charts_config`, {
        method:'POST', credentials:'same-origin',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ charts: payload })
      });
      const j = await r.json();
      if (j && j.ok) {
        alert('å·²ä¿å­˜å›¾è¡¨é…ç½®');
        if (typeof window.refreshCharts === 'function') window.refreshCharts(true);
      } else {
        alert('ä¿å­˜å¤±è´¥ï¼š' + (j.error || ''));
      }
    }catch(e){ alert('ä¿å­˜å¤±è´¥ï¼š' + e.message); }
  }

  // åªç»‘å®šâ€œå¢åŠ å›¾è¡¨â€æŒ‰é’®ï¼›ä¿å­˜ä¸åˆ·æ–°äº¤ç”± charts-client ç»Ÿä¸€å¤„ç†
  document.getElementById('btnAddChart')?.addEventListener('click', () => $('chart-settings-list').appendChild(row()));

  // æš´éœ²ç»™å¤–éƒ¨ï¼ˆcharts-client/Tab åˆ‡æ¢æ—¶ä¼šè°ƒç”¨ï¼‰
  window.saveChartsConfig = save;
  window.initChartsUI = function(){
    loadCandidateTitles();
    loadConfig();
  };
})();
</script>


<script>
    (function () {
        const btn = document.getElementById('btnPreview');
        const modal = document.getElementById('previewModal');
        const root = document.getElementById('previewRoot');
        const form = document.getElementById('builder');
        const schemaInput = document.getElementById('schema_json');
        if (!btn || !modal || !root || !form || !schemaInput) return;

        btn.addEventListener('click', async () => {
            // åªå‘å¿…è¦å­—æ®µï¼šä¸ä½¿ç”¨ new FormData(form)ï¼Œé¿å…æŠŠ file ä¸€èµ·å¸¦ä¸Š
            const fd = new FormData();
            fd.append('form_name', form.querySelector('[name="form_name"]')?.value || '');
            fd.append('form_desc', form.querySelector('[name="form_desc"]')?.value || '');
            fd.append('schema_json', schemaInput.value || '{}');

            // ä½ é¡¹ç›®ç°æœ‰çš„é¢„è§ˆè·¯ç”±æ˜¯ /previewï¼ˆapp.py é‡Œï¼‰ï¼Œç”¨è¿™ä¸ªå³å¯
            const res = await fetch('/preview', {method: 'POST', body: fd});
            const html = await res.text();

            // ä»ç„¶æ”¾åˆ°ä½ åŸæ¥çš„å¼¹çª—é‡Œæ˜¾ç¤º
            root.innerHTML = '<iframe id="previewFrame" title="é¢„è§ˆ" style="width:100%;height:70vh;border:0;border-radius:12px;display:block;"></iframe>';
            root.querySelector('#previewFrame').srcdoc = html;
            modal.classList.add('show');
        });
    })();
</script>

<script id="review-toggle">
(function(){
  const sw = document.querySelector('[data-skey="submission.require_review"]');

  function apply(){
    const on = !!sw?.checked;
    document.body.classList.toggle('no-review', !on);
    // åˆ·æ–°è¡¨å¤´/åˆ—å®½ï¼ˆå­˜åœ¨åˆ™è°ƒç”¨ï¼‰
    if (typeof window.rebuildRespHeader === 'function') window.rebuildRespHeader();
  }

  // ç›‘å¬åˆ‡æ¢
  sw?.addEventListener('change', apply);

  // åˆæ¬¡ä» schema_json æ¢å¤åˆ°å¼€å…³
  try{
    const raw = document.getElementById('schemaJSON')?.textContent
             || document.getElementById('schema_json')?.value
             || '';
    const j = JSON.parse(raw || 'null');
    const v = !!(j?.submission?.require_review);
    if (sw) sw.checked = v; // é»˜è®¤ false
  }catch(_){}

  apply();
})();
</script>

<script id="charts-tab-hook">
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.tabs button').forEach(function (b) {
    b.addEventListener('click', function () {
      if (b.dataset.tab === 'charts') {
        window.initChartsUI && window.initChartsUI();
        window.refreshCharts && window.refreshCharts(true);
      }
    });
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const list = document.querySelector('.tabs.vertical');
  if (!list) return;
  list.setAttribute('role','tablist');
  list.querySelectorAll('button').forEach(btn=>{
    const key = btn.dataset.tab;
    const panel = document.getElementById('tab-'+key);
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected', btn.classList.contains('active')?'true':'false');
    if (panel){
      panel.setAttribute('role','tabpanel');
      btn.setAttribute('aria-controls','tab-'+key);
    }
    btn.addEventListener('click', ()=>{
      list.querySelectorAll('button').forEach(b=>b.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
    });
  });
});
</script>

<script>
(function(){
  const picker = document.getElementById('headerImagePicker');
  const urlInp = document.getElementById('headerImageUrl');

  async function uploadAsset(file){
    const fd = new FormData();
    fd.append('file', file);
    const base = new URL('{{ url_for("create_form") }}', location.origin).pathname.replace(/\/create_form.*/,'');
    const res  = await fetch(base + '/admin/api/upload_asset', { method:'POST', body: fd });
    const j = await readJSONSafely(res);
    if(!j.ok) throw new Error(j.error||'ä¸Šä¼ å¤±è´¥');
    return j.url; // <- æœåŠ¡ç«¯è¿”å›çš„é™æ€URL
  }

  picker?.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      // 1) ä¸Šä¼ åˆ°æœåŠ¡å™¨
      const url = await uploadAsset(f);

      // 2) æŠŠè¿”å›çš„ URL å†™å›è¾“å…¥æ¡†ï¼ˆè€Œä¸æ˜¯ data: æˆ– blob:ï¼‰
      urlInp.value = url;
      urlInp.dispatchEvent(new Event('input', {bubbles:true}));

      // 3) ç«‹å³é¢„è§ˆï¼ˆä½¿ç”¨ URLï¼‰
      const basicCard = document.querySelector('.form-basic');
      if (basicCard){
        basicCard.style.backgroundImage = `url("${url.replace(/"/g,'\\"')}")`;
        basicCard.classList.add('has-cover');
      }
    }catch(err){
      alert(err.message||'ä¸Šä¼ å¤±è´¥');
      console.error(err);
    }finally{
      e.target.value = '';
    }
  });
})();
</script>

<script>
async function readJSONSafely(res){
  const ct = (res.headers.get('content-type') || '').toLowerCase();
  const txt = await res.text(); // å…ˆè¯»æ–‡æœ¬ï¼Œå†å†³å®š
  if (ct.includes('application/json')){
    try { return JSON.parse(txt); } catch(_) {}
  }
  // é JSONï¼ˆå¤šåŠæ˜¯ 413 æˆ–ä»£ç†/æœåŠ¡å™¨çš„ HTML æŠ¥é”™é¡µï¼‰
  const brief = txt.replace(/\s+/g,' ').slice(0,300);
  throw new Error(brief || ('HTTP ' + res.status));
}
</script>

<script id="autosave-unified">
(function(){
  const form = document.getElementById('builder');
  const schemaEl = document.getElementById('schema_json');
  if (!form || !schemaEl) return;

  let timer;
  const schedule = ()=>{ clearTimeout(timer); timer = setTimeout(save, 800); };

  async function save(){
    // åªå‘å¿…è¦å­—æ®µ
    const fd = new FormData();
    fd.append('form_name', form.querySelector('[name="form_name"]')?.value || '');
    fd.append('site_name', form.querySelector('[name="site_name"]')?.value || '');
    fd.append('form_desc', form.querySelector('[name="form_desc"]')?.value || '');

    // åˆå¹¶ schemaï¼šå°é¢å›¾/é¢˜ç›®é¢œè‰²/å®¡æ ¸å¼€å…³
    let schema = {};
    try { schema = JSON.parse(schemaEl.value || '{}') || {}; } catch {}
    const cover = document.getElementById('headerImageUrl')?.value?.trim();
    if (cover && !/^data:|^blob:/i.test(cover)) (schema.header ||= {}).title_image = cover;
    const sw = document.querySelector('[data-skey="submission.require_review"]');
    (schema.submission ||= {}).require_review = !!sw?.checked;

    fd.append('schema_json', JSON.stringify(schema));

    const u = new URL(form.action, location.origin);
    u.searchParams.set('ajax','1');
    try {
      await fetch(u, { method:'POST', body:fd, headers:{'Accept':'application/json','X-Requested-With':'XMLHttpRequest'} });
    } catch {}
  }

  // è§¦å‘è‡ªåŠ¨ä¿å­˜
    document.addEventListener('input', (e) => {
        if (e.target?.id === 'headerImageUrl' || e.target?.id === 'schema_json') schedule();
    });
})();
</script>

<script id="bg-tools-script">
(function(){
  const card    = document.querySelector('.form-basic');
  const urlInp  = document.getElementById('headerImageUrl');
  const schemaEl= document.getElementById('schema_json');
  const tools   = document.getElementById('bgTools');
  const btnClr  = document.getElementById('bgClear');
  if(!card || !schemaEl) return;

  function readSchema(){ try{ return JSON.parse(schemaEl.value||'{}')||{} }catch{ return {} } }
  function writeSchema(j){ try{ schemaEl.value=JSON.stringify(j); schemaEl.dispatchEvent(new Event('input',{bubbles:true})); }catch{} }

  function setPos(x,y){
    x=Math.max(0,Math.min(100,x)); y=Math.max(0,Math.min(100,y));
    document.documentElement.style.setProperty('--title-pos-x', x+'%');
    document.documentElement.style.setProperty('--title-pos-y', y+'%');
    const j=readSchema(); (j.header||={}).title_image_pos=`${x}% ${y}%`; writeSchema(j);
  }
  function setOpacity(p){ // 0~100
    const a=Math.max(0,Math.min(100,p))/100;
    document.documentElement.style.setProperty('--title-cover-opacity', String(a));
    const j=readSchema(); (j.header||={}).title_image_opacity=a; writeSchema(j);
  }
  function refreshTools(){
    const bg = getComputedStyle(card).backgroundImage;
    const has = bg && !/none/i.test(bg);
    tools.hidden=!has; card.classList.toggle('has-cover',has);
  }

  // ä» schema æ¢å¤ä½ç½®/é€æ˜åº¦
  try{
    const j=readSchema();
    const pos=(j?.header?.title_image_pos||'').split(/\s+/);
    const op = j?.header?.title_image_opacity;
    if(pos.length===2){
      const [px,py]=pos.map(s=>parseFloat(String(s).replace('%',''))||50);
      document.documentElement.style.setProperty('--title-pos-x', px+'%');
      document.documentElement.style.setProperty('--title-pos-y', py+'%');
    }
    if(typeof op==='number'){
      document.documentElement.style.setProperty('--title-cover-opacity', String(op));
    }
  }catch{}

  // æ¸…é™¤èƒŒæ™¯
  btnClr?.addEventListener('click', ()=>{
    if(urlInp) urlInp.value='';
    card.style.removeProperty('background-image');
    card.classList.remove('has-cover');
    const j=readSchema(); if(j.header){ delete j.header.title_image; delete j.header.title_image_pos; }
    writeSchema(j); refreshTools();
  });

  // ç›‘å¬å¡ç‰‡ style/classï¼Œè‡ªåŠ¨æ˜¾ç¤º/éšè— Ã—
  new MutationObserver(refreshTools).observe(card,{attributes:true,attributeFilter:['style','class']});
  refreshTools();

// æ‹–åŠ¨å®šä½ï¼ˆæ–°ï¼šç»å¯¹åæ ‡ç®—æ³•ï¼ŒæŒ‰ä¸‹ç«‹å³å®šä½ï¼ŒXY éƒ½å¯è°ƒï¼‰
    (function () {
        const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
        const toPercent = (val) => Math.round(val * 100) + '%';

        function setFromEvent(e) {
            const box = card.getBoundingClientRect();
            if (box.width <= 0 || box.height <= 0) return;
            const x = clamp((e.clientX - box.left) / box.width, 0, 1);
            const y = clamp((e.clientY - box.top) / box.height, 0, 1);
            document.documentElement.style.setProperty('--title-pos-x', toPercent(x));
            document.documentElement.style.setProperty('--title-pos-y', toPercent(y));
        }

        let dragging = false;

        card.addEventListener('pointerdown', (e) => {
            if (!card.classList.contains('has-cover')) return;
            dragging = true;             // â˜… æ–°å¢ï¼šå¼€å¯æ‹–åŠ¨
            card.setPointerCapture(e.pointerId);
            card.classList.add('dragging');
            document.documentElement.style.setProperty('--bg-move', 'grabbing');
            setFromEvent(e);             // æŒ‰ä¸‹ç«‹åˆ»å®šä½åˆ°ç‚¹å‡»å¤„
            // â¬… æŒ‰ä¸‹ç«‹åˆ»å®šä½åˆ°ç‚¹å‡»å¤„
        });

        card.addEventListener('pointermove', (e) => {
            if (!dragging) return;
            setFromEvent(e);             // â¬… æ‹–åŠ¨è¿‡ç¨‹ä¸­å®æ—¶å®šä½
        });

        const end = (e) => {
            if (!dragging) return;
            dragging = false;
            card.classList.remove('dragging');
            document.documentElement.style.removeProperty('--bg-move');
            // æŒä¹…åŒ–å½“å‰ä½ç½®åˆ° schemaï¼ˆæ²¿ç”¨ä½ åŸæ¥çš„ setPosï¼‰
            const cs = getComputedStyle(document.documentElement);
            const px = parseFloat(cs.getPropertyValue('--title-pos-x')) || 50;
            const py = parseFloat(cs.getPropertyValue('--title-pos-y')) || 50;
            setPos(px, py);
        };
        card.addEventListener('pointerup', end);
        card.addEventListener('pointercancel', end);
        card.addEventListener('pointerleave', end);
    })();
})();
</script>

<script id="bg-opacity-range">
(function(){
  const rng=document.getElementById('bgOpacity');
  const schemaEl=document.getElementById('schema_json');
  if(!rng||!schemaEl) return;

  function readSchema(){ try{ return JSON.parse(schemaEl.value||'{}')||{} }catch{ return {} } }
  function writeSchema(j){ try{ schemaEl.value=JSON.stringify(j); schemaEl.dispatchEvent(new Event('input',{bubbles:true})); }catch{} }
  function setOpacity(p){
    const a=Math.max(0,Math.min(100, +p))/100;
    document.documentElement.style.setProperty('--title-cover-opacity', String(a));
    const j=readSchema(); (j.header||={}).title_image_opacity=a; writeSchema(j);
  }

  // æ¢å¤
  try{
    const j=readSchema(); if(typeof j?.header?.title_image_opacity==='number'){
      rng.value=String(Math.round(j.header.title_image_opacity*100));
      setOpacity(rng.value);
    }
  }catch{}

  rng.addEventListener('input', ()=>setOpacity(rng.value));
})();
</script>

<script>
(function(){
  const modal = document.getElementById('previewModal');
  if (!modal) return;

  // ç‚¹é»‘è‰²è’™å±‚å…³é—­ï¼ˆåªåœ¨ç‚¹åˆ°æœ€å¤–å±‚æ—¶å…³é—­ï¼Œé¿å…ç‚¹åˆ° iframe ä¹Ÿå…³é—­ï¼‰
  modal.addEventListener('click', function(e){
    if (e.target === modal) modal.classList.remove('show');
  });

  // å¦‚æœä½ ä¿ç•™äº†é‚£ä¸ªâ€œâœ–â€æŒ‰é’®ï¼Œä¹Ÿè®©å®ƒèƒ½å…³é—­ï¼ˆå¯é€‰ï¼‰
  document.getElementById('closePreview')?.addEventListener('click', function(){
    modal.classList.remove('show');
  });

  // ESC å…³é—­
  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') modal.classList.remove('show');
  });
})();
</script>

location.href = successURL;   // ç›´æ¥è·³æˆåŠŸé¡µ


<style id="preview-centered-iframe">
  /* ä¿ç•™é»‘è‰²åŠé€æ˜è’™å±‚ä¸å±…ä¸­ */
  #previewModal {
    padding: 0 16px !important;
    background: rgba(0, 0, 0, .45) !important;
    z-index: 10000 !important;
  }
  /* å»æ‰å¤–å±‚ç™½è‰²å¡ç‰‡å£³ï¼šæ— èƒŒæ™¯ã€æ— è¾¹æ¡†ã€æ— é˜´å½±ã€æ— å†…è¾¹è· */
  #previewModal .box{
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
    padding: 0 !important;

    /* ä»ä½œä¸ºâ€œä¸­é—´å¼¹çª—â€æ˜¾ç¤ºï¼šå›ºå®šå°ºå¯¸+åœ†è§’è£åˆ‡å†…å®¹ */
    width: min(980px, 92vw) !important;
    height: 86vh !important;
    max-width: none !important;
    max-height: none !important;
    border-radius: 18px !important;
    overflow: hidden !important;
  }
  /* åªä¿ç•™ iframe å†…å®¹ï¼Œéšè—æ ‡é¢˜é‚£è¡Œç­‰ */
  #previewModal .box > *:not(#previewRoot){
    display: none !important;
  }
  /* è®© iframe æ­£å¥½é“ºæ»¡è¿™ä¸ªä¸­é—´å¼¹çª— */
  #previewRoot,
  #previewRoot iframe{
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    border: 0 !important;
    border-radius: 0 !important; /* éœ€è¦çš„è¯ä¹Ÿå¯ä¿ç•™åœ†è§’ */
  }
</style>

<style id="kill-preview-shell-hard">
  /* è’™å±‚ä»ç„¶åŠé€æ˜ï¼Œä¿æŒå±…ä¸­ */
  #previewModal {
    padding: 0 16px !important;
    background: rgba(0,0,0,.45) !important;
    z-index: 10000 !important;
  }

  /* æŠŠå¤–å±‚ç™½è‰²å¡ç‰‡å£³å½»åº•å¹²æ‰ */
  #previewModal.modal > .box,
  #previewModal > .box {
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
    padding: 0 !important;
    max-width: none !important;
    color: inherit !important;
    /* ä¸­é—´å¼¹çª—çš„å°ºå¯¸ä¸åœ†è§’ï¼Œä»…ç”¨äºè£åˆ‡å†…éƒ¨å†…å®¹ */
    width: min(980px, 92vw) !important;
    height: 86vh !important;
    border-radius: 18px !important;
    overflow: hidden !important;
  }
  #previewModal.modal > .box::before,
  #previewModal.modal > .box::after,
  #previewModal > .box::before,
  #previewModal > .box::after {
    content: none !important;
  }

  /* åªä¿ç•™ iframe å†…å®¹ï¼Œéšè—â€œè¡¨å•é¢„è§ˆ/âœ–â€é‚£è¡Œ */
  #previewModal.modal > .box > *:not(#previewRoot),
  #previewModal > .box > *:not(#previewRoot) {
    display: none !important;
  }

  /* è®© iframe æ­£å¥½é“ºæ»¡ä¸­é—´å¼¹çª— */
  #previewRoot,
  #previewRoot iframe {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
    border: 0 !important;
    border-radius: 0 !important;
  }
</style>

<script>
(() => {
  const card = document.querySelector('.form-basic');
  const schemaInput = document.getElementById('schema_json');
  if (!card || !schemaInput) return;

  let dragging = false, start = {x:0,y:0}, startPos = {x:50,y:50};

  const getPos = () => ({
    x: parseFloat(getComputedStyle(card).getPropertyValue('--title-pos-x')) || 50,
    y: parseFloat(getComputedStyle(card).getPropertyValue('--title-pos-y')) || 50
  });
  const clamp = v => Math.max(0, Math.min(100, v));
  const setPos = (x,y) => {
    card.style.setProperty('--title-pos-x', clamp(x) + '%');
    card.style.setProperty('--title-pos-y', clamp(y) + '%');
  };

  card.addEventListener('mousedown', e => {
    if (!card.classList.contains('has-cover')) return;
    dragging = true;
    start = {x: e.clientX, y: e.clientY};
    startPos = getPos();
    // æŒ‰ä¸‹å¤„ç›´æ¥å®šä½ä¸€æ¬¡
    const rect = card.getBoundingClientRect();
    setPos(((e.clientX-rect.left)/rect.width)*100, ((e.clientY-rect.top)/rect.height)*100);
  });

  window.addEventListener('mousemove', e => {
    if (!dragging) return;
    const rect = card.getBoundingClientRect();
    const dx = (e.clientX - start.x) / rect.width * 100;
    const dy = (e.clientY - start.y) / rect.height * 100;
    setPos(startPos.x + dx, startPos.y + dy);
  });

    window.addEventListener('mouseup', () => {
        if (!dragging) return;
        dragging = false;
        try {
            const j = JSON.parse(schemaInput.value || '{}') || {};
            const px = getComputedStyle(card).getPropertyValue('--title-pos-x').trim() || '50%';
            const py = getComputedStyle(card).getPropertyValue('--title-pos-y').trim() || '50%';

            // å…¼å®¹æ—§æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰
            (j.header ||= {}).title_pos = {x: px, y: py};
            // âœ… å…¬å¼€/é¢„è§ˆä½¿ç”¨çš„å­—ç¬¦ä¸²æ ¼å¼ï¼ˆå…³é”®ï¼‰
            j.header.title_image_pos = `${px} ${py}`;

            schemaInput.value = JSON.stringify(j);
            // âœ… è§¦å‘ç¼–è¾‘å™¨/è‡ªåŠ¨ä¿å­˜
            schemaInput.dispatchEvent(new Event('input', {bubbles: true}));
            schemaInput.dispatchEvent(new Event('change', {bubbles: true}));
        } catch (_) {
        }
    });
})();
</script>

<script id="picker-fallback">
(() => {
  const lab = document.querySelector('label.btn.icon[for="headerImagePicker"]');
  const inp = document.getElementById('headerImagePicker');
  if (!lab || !inp) return;
  lab.addEventListener('click', (e) => {
    // æŸäº›æµè§ˆå™¨ label->file å¯èƒ½ä¸è§¦å‘ï¼Œæ‰‹åŠ¨å…œåº•
    if (typeof inp.showPicker === 'function') { try { inp.showPicker(); return; } catch {} }
    inp.click();
  });
})();
</script>

<!-- AUTOSAVE: ç²˜è´´åˆ° create_form.html çš„ </body> å‰ä¸€è¡Œ -->
<script>
(function(){
  // ===== ä¸Šä¸‹æ–‡ =====
  var USER_ID = window.CURRENT_USER_ID || (document.body.dataset.uid || 'anon');
  var SITE = (document.body.dataset.site || new URLSearchParams(location.search).get('site') || '').trim();
  var DRAFT_KEY = `draft:${USER_ID}:site:${SITE||'__new__'}`;
  window.schema = window.schema || {};
  var DIRTY=false, TIMER=null;

  function ensureHeader(){ window.schema.header = window.schema.header || {}; return window.schema.header; }
  function markDirty(){
    try{ localStorage.setItem(DRAFT_KEY, JSON.stringify({header: window.schema.header||{}})); }catch(_){}
    if (TIMER) clearTimeout(TIMER);
    TIMER = setTimeout(serverSave, 800);
    DIRTY = true;
  }
  async function serverSave(){
    if (!DIRTY || !SITE) return;
    DIRTY = false;
    let url = `/site/${encodeURIComponent(SITE)}/admin/api/save_schema`;
    try{
      const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({schema:window.schema})});
      if (!res.ok) throw 0;
    }catch(_){
      // å…œåº•è·¯å¾„ï¼ˆè‹¥ä½ çš„ä¿å­˜æ¥å£æ˜¯è¿™ä¸ªï¼‰
      await fetch(`/site/${encodeURIComponent(SITE)}/admin/api/schema`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({schema:window.schema})
      }).catch(()=>{});
    }
  }
  document.addEventListener('visibilitychange', function(){
    if (document.visibilityState==='hidden' && SITE){
      try{
        const blob = new Blob([JSON.stringify({schema:window.schema})], {type:'application/json'});
        navigator.sendBeacon(`/site/${encodeURIComponent(SITE)}/admin/api/save_schema`, blob);
      }catch(_){}
    }
  });
  window.addEventListener('beforeunload', function(){
    try{ localStorage.setItem(DRAFT_KEY, JSON.stringify({header: window.schema.header||{}})); }catch(_){}
  });

  // ===== é€šç”¨é€‰æ‹©å™¨ï¼ˆé›¶é…ç½®ï¼‰ï¼šæ”¯æŒ name=... æˆ– data-role=... =====
  function $cover(){ return document.querySelector('[name="title_image"], [data-role="title-image"]'); }
  function $opacity(){ return document.querySelector('[name="title_image_opacity"], [data-role="title-image-opacity"]'); }
  function $pos(){ return document.querySelector('[name="title_image_pos"], [data-role="title-image-pos"]'); }

  // æŠŠå½“å‰æ§ä»¶å€¼å†™å…¥ schema.header
  function syncFromControls(){
    var h = ensureHeader();
    var c = $cover(), o = $opacity(), p = $pos();
    if (c && typeof c.value === 'string') { h.title_image = (c.value || c.dataset.url || '').trim(); }
    if (o && o.value != null) {
      var v = Math.max(0, Math.min(1, Number(o.value)));
      h.title_image_opacity = isFinite(v) ? v : 0.72;
    }
    if (p && typeof p.value === 'string') { h.title_image_pos = p.value || 'center'; }
  }

  // é¦–æ¬¡åŠ è½½ï¼šæ¢å¤æœ¬åœ°è‰ç¨¿
  try{
    var draft = localStorage.getItem(DRAFT_KEY);
    if (draft) {
      var d = JSON.parse(draft);
      window.schema.header = Object.assign({}, window.schema.header, d.header||{});
    }
  }catch(_){}
  // å›å¡«åˆ°æ§ä»¶ï¼ˆè‹¥æ§ä»¶å­˜åœ¨ï¼‰
  (function restoreControls(){
    var h = window.schema.header||{};
    var c = $cover(), o = $opacity(), p = $pos();
    if (c && h.title_image && !c.value) c.value = h.title_image;
    if (o && typeof h.title_image_opacity === 'number') o.value = h.title_image_opacity;
    if (p && h.title_image_pos) p.value = h.title_image_pos;
  })();

  // äº‹ä»¶å§”æ‰˜ï¼šç›‘å¬å…¨å±€ input/changeï¼ˆæ§ä»¶åŠ¨æ€æ¸²æŸ“ä¹Ÿèƒ½æ•æ‰åˆ°ï¼‰
  document.addEventListener('input', onEvt, true);
  document.addEventListener('change', onEvt, true);
  function onEvt(e){
    var t = e.target;
    if (!t) return;
    if (
      t.matches('[name="title_image"], [data-role="title-image"]') ||
      t.matches('[name="title_image_opacity"], [data-role="title-image-opacity"]') ||
      t.matches('[name="title_image_pos"], [data-role="title-image-pos"]')
    ){
      syncFromControls();
      markDirty();
    }
  }

  // å…œåº•ï¼šæœ‰äº›ä¸Šä¼ å™¨æ˜¯å¼‚æ­¥å›å¡« valueï¼Œè¿™é‡Œè½®è¯¢å‡ æ¬¡
  var tries = 0;
  var poll = setInterval(function(){
    tries++;
    syncFromControls(); markDirty();
    if (tries >= 5) clearInterval(poll);
  }, 1200);
})();
</script>

<script>
(function(){
  const SITE = (document.body.dataset.site || new URLSearchParams(location.search).get('site') || '').trim();

  async function fetchSubmissions(){
    const urls = [
      `/site/${encodeURIComponent(SITE)}/admin/api/submissions?q=`,
      `/site/${encodeURIComponent(SITE)}/admin/api/responses?q=`
    ];
    for (const u of urls){
      try{
        const r = await fetch(u, {credentials:'same-origin'});
        if (r.ok){
          const j = await r.json();
          return Array.isArray(j) ? j : (j.items || j.data || []);
        }
      }catch(e){}
    }
    return [];
  }

  function renderPassRate(list){
    let ok = 0, ng = 0;
    for (const x of list){
      const s = String(x?.status || x?.state || x?.å®¡æ ¸çŠ¶æ€ || x?.review_status || '').toLowerCase();
      if (/approved|pass|é€šè¿‡|å·²é€šè¿‡|accept|accepted/.test(s)) ok++; else ng++;
    }
    const all = ok + ng;
    const rate = all ? ok/all : 0;

    document.getElementById('okCnt').textContent  = ok;
    document.getElementById('ngCnt').textContent  = ng;
    document.getElementById('allCnt').textContent = all;
    document.getElementById('passDonut').style.setProperty('--p', String(rate));
    document.getElementById('passText').textContent = Math.round(rate*100) + '%';
  }

  function renderLine(list){
    const times = list.map(x=>{
      const raw = x.created_at || x.create_time || x.ts || x.submit_time || x.æäº¤æ—¶é—´ || x.time || x.date;
      const t = raw ? new Date(raw) : null;
      return t && !isNaN(+t) ? t : null;
    }).filter(Boolean);
    if (!times.length) return drawLine([], []);

    const fmt = d => d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    const countByDay = new Map();
    times.forEach(t => { const k = fmt(t); countByDay.set(k,(countByDay.get(k)||0)+1); });

    const days = Array.from(countByDay.keys()).sort();
    const start = new Date(days[0]), end = new Date(days[days.length-1]);
    const seq = []; for (let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) seq.push(fmt(d));
    const values = seq.map(k => countByDay.get(k)||0);
    drawLine(seq, values);
  }

  function drawLine(labels, data){
    const c = document.getElementById('lineChart'), ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const W=c.width, H=c.height, P=36;
    // è½´
    ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(P,H-P); ctx.lineTo(W-P,H-P); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(P,H-P); ctx.lineTo(P,P); ctx.stroke();

    if (!data.length){ ctx.fillStyle='#64748b'; ctx.fillText('æš‚æ— æ•°æ®', P+8, H/2); return; }

    const maxV=Math.max(...data,5), xStep=(W-P*2)/Math.max(1,data.length-1), yScale=(H-P*2)/maxV;

    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--brand') || '#6366f1';
    ctx.lineWidth=2; ctx.beginPath();
    data.forEach((v,i)=>{ const x=P+i*xStep, y=H-P-v*yScale; i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.stroke();

    const g=ctx.createLinearGradient(0,P,0,H-P); g.addColorStop(0,'rgba(99,102,241,.25)'); g.addColorStop(1,'rgba(99,102,241,0)');
    ctx.fillStyle=g; ctx.lineTo(W-P,H-P); ctx.lineTo(P,H-P); ctx.closePath(); ctx.fill();

    ctx.fillStyle='#64748b'; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto';
    const step=Math.ceil(labels.length/6);
    labels.forEach((lb,i)=>{ if(i%step===0){ const x=P+i*xStep; ctx.fillText(lb.slice(5), Math.max(P, Math.min(x-12, W-48)), H-P+16); }});
    const yStepVal=Math.max(1, Math.ceil(maxV/4));
    for(let v=0; v<=maxV; v+=yStepVal){ const y=H-P-v*yScale; ctx.fillText(String(v), 6, y+4); ctx.strokeStyle='#eef2f7'; ctx.beginPath(); ctx.moveTo(P,y); ctx.lineTo(W-P,y); ctx.stroke(); }
  }

  fetchSubmissions().then(list=>{ renderPassRate(list); renderLine(list); })
                    .catch(()=>{ renderPassRate([]); renderLine([]); });
})();
</script>
</body>
</html>
