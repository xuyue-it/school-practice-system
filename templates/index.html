<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç¦æºå ‚å™¨æå¤–å€Ÿç”³è¯·</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    :root{
      --card:#fff; --bd:#e5e5e5; --muted:#666;
      --primary:#0a58ff; --shadow:rgba(0,0,0,.12);
    }
    body{background:#f7f7f7;color:#000;padding:24px;}
    h1,h2,h3,label,.muted,.tabs button,.nav-title{font-family:"Microsoft YaHei","å¾®è½¯é›…é»‘",sans-serif;}
    h1{font-size:32px;font-weight:900;text-align:center;margin:0 0 6px}
    h3{font-size:16px;text-align:center;margin:0 0 18px;color:#444;font-weight:700}
    .tabs{display:flex;justify-content:center;gap:14px;margin:10px 0 22px}
    .btn-tab{
      position:relative; padding:10px 18px; border-radius:12px; border:1px solid var(--bd);
      background:#fff; cursor:pointer; font-weight:800;
      box-shadow:0 3px 0 #cfd6ff, 0 8px 16px var(--shadow);
      transition:transform .08s ease, box-shadow .15s ease;
    }
    .btn-tab:hover{transform:translateY(-1px); box-shadow:0 4px 0 #c5ceff,0 10px 18px var(--shadow);}
    .btn-tab:active{transform:translateY(2px); box-shadow:0 1px 0 #c5ceff,0 4px 10px var(--shadow);}
    form{max-width:1000px;margin:0 auto}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px 18px;margin-bottom:16px;box-shadow:0 6px 16px var(--shadow)}
    .card h2{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:900;margin:0 0 12px}
    .icon{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .row{display:flex;flex-direction:column;gap:6px}
    .row label{font-weight:800}
    input[type="text"],input[type="email"],input[type="tel"],input[type="date"],
    input[type="time"],input[type="number"],select,textarea{
      padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff;outline:none;
      font-family:inherit;
    }
    textarea{resize:vertical;min-height:90px}
    .equip-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .select-all{display:flex;align-items:center;gap:8px;font-weight:800}
    .equip-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .equip-item{border:1px solid var(--bd);border-radius:12px;padding:10px;display:flex;align-items:center;justify-content:space-between;background:#fff}
    .equip-left{display:flex;align-items:center;gap:8px}
    .qty{display:none;align-items:center;gap:6px}
    .qty input{width:72px;text-align:center}
    .muted{color:var(--muted);font-size:13px}
    .submit-wrap{text-align:center;margin-top:14px}
    .btn-submit{
      padding:12px 22px;border:none;border-radius:12px;background:var(--primary);color:#fff;
      font-weight:900;font-size:16px;cursor:pointer;
      box-shadow:0 4px 0 #063fc7, 0 10px 18px var(--shadow);
      transition:transform .08s ease, box-shadow .15s ease;
    }
    .btn-submit:hover{transform:translateY(-1px); box-shadow:0 5px 0 #063fc7,0 12px 20px var(--shadow);}
    .btn-submit:active{transform:translateY(2px); box-shadow:0 2px 0 #063fc7,0 6px 12px var(--shadow);}
    #statusForm{max-width:520px;margin:0 auto 18px;display:none}
    .status-card{max-width:520px;margin:12px auto 0;padding:12px 14px;border-radius:12px;background:#fff;border:1px solid var(--bd)}
    .status-row{display:flex;justify-content:space-between;margin:6px 0}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px}
  </style>
</head>
<body>
  <h1 class="nav-title">ç¦æºå ‚å™¨æå¤–å€Ÿç”³è¯·</h1>
  <h3>Masland Methodist Church èµ„è®¯å§”å‘˜ä¼š</h3>

  <div class="tabs">
    <button class="btn-tab" onclick="window.location.href='/'">ç”³è¯·è¡¨æ ¼</button>
    <button class="btn-tab" onclick="toggleStatusForm()">æŸ¥è¯¢çŠ¶æ€</button>
  </div>

  <!-- æŸ¥è¯¢çŠ¶æ€è¡¨å• -->
  <form id="statusForm" class="card" onsubmit="return false">
    <h2><span class="icon">ğŸ”</span>æŸ¥è¯¢å®¡æ ¸çŠ¶æ€</h2>
    <div class="row">
      <label for="status_name">å§“å *</label>
      <input type="text" id="status_name" required>
    </div>
    <div class="submit-wrap"><button class="btn-submit" type="button" onclick="doLookup()">æŸ¥è¯¢</button></div>
    <div id="statusResult" class="status-card" style="display:none;"></div>
  </form>

  <!-- ä¸»è¡¨å• -->
  <form action="/submit" method="post" id="mainForm">
    <!-- ç”³è¯·äººä¿¡æ¯ -->
    <section class="card">
      <h2><span class="icon">ğŸ‘¤</span>ç”³è¯·äººä¿¡æ¯</h2>
      <div class="grid-2">
        <div class="row"><label>å§“å *</label><input type="text" name="name" required></div>
        <div class="row"><label>è”ç³»ç”µè¯ *</label><input type="tel" name="phone" required></div>
        <div class="row"><label>ç”µå­é‚®ç®± *</label><input type="email" name="email" required></div>
        <div class="row"><label>æ‰€å±å›¢å¥‘/å°ç»„ *</label><input type="text" name="group" required></div>
      </div>
    </section>

    <!-- æ´»åŠ¨ä¿¡æ¯ -->
    <section class="card">
      <h2><span class="icon">ğŸ“…</span>æ´»åŠ¨ä¿¡æ¯</h2>
      <div class="grid-2">
        <div class="row"><label>æ´»åŠ¨åç§° *</label><input type="text" name="event_name" required></div>
        <div class="row"><label>æ´»åŠ¨åœ°ç‚¹ *</label><input type="text" name="location" required></div>
        <div class="row"><label>å¼€å§‹æ—¥æœŸ *</label><input type="date" name="start_date" required></div>
        <div class="row"><label>å¼€å§‹æ—¶é—´ *</label><input type="time" name="start_time" required></div>
        <div class="row"><label>ç»“æŸæ—¥æœŸ *</label><input type="date" name="end_date" required></div>
        <div class="row"><label>ç»“æŸæ—¶é—´ *</label><input type="time" name="end_time" required></div>
        <div class="row"><label>æ´»åŠ¨æ€§è´¨ *</label>
          <select name="event_type" required>
            <option value="">è¯·é€‰æ‹©æ´»åŠ¨æ€§è´¨</option>
            <option value="å†…éƒ¨">å†…éƒ¨</option>
            <option value="å¤–å€Ÿ">å¤–å€Ÿ</option>
          </select>
        </div>
        <div class="row"><label>é¢„è®¡å‚ä¸äººæ•° *</label><input type="number" name="participants" min="1" step="1" required></div>
      </div>
    </section>

    <!-- å™¨æéœ€æ±‚ -->
    <section class="card">
      <h2><span class="icon">ğŸ› </span>å™¨æéœ€æ±‚</h2>
      <div class="equip-head">
        <div class="muted">è¯·é€‰æ‹©éœ€è¦çš„å™¨æï¼Œå‹¾é€‰åå¯å¡«å†™æ•°é‡</div>
        <label class="select-all"><input type="checkbox" id="equip_select_all">å…¨é€‰å™¨æ</label>
      </div>
      <div class="equip-grid">
        <!-- æ— çº¿éº¦å…‹é£ -->
        <div class="equip-item">
          <div class="equip-left">
            <input type="checkbox" id="equip_mic_wireless" name="equip_mic_wireless">
            <label for="equip_mic_wireless">æ— çº¿éº¦å…‹é£</label>
          </div>
          <div class="qty" id="qty_mic_wireless">
            <span class="muted">æ•°é‡</span>
            <input type="number" name="equip_mic_wireless_qty" min="1" step="1" value="1">
          </div>
        </div>
        <!-- æœ‰çº¿éº¦å…‹é£ -->
        <div class="equip-item">
          <div class="equip-left">
            <input type="checkbox" id="equip_mic_wired" name="equip_mic_wired">
            <label for="equip_mic_wired">æœ‰çº¿éº¦å…‹é£</label>
          </div>
          <div class="qty" id="qty_mic_wired">
            <span class="muted">æ•°é‡</span>
            <input type="number" name="equip_mic_wired_qty" min="1" step="1" value="1">
          </div>
        </div>
        <!-- å…¶ä»–å™¨æ -->
        {% for key, cname in equip_map.items() %}
        <div class="equip-item">
          <div class="equip-left">
            <input type="checkbox" id="equip_{{key}}" name="equip_{{key}}">
            <label for="equip_{{key}}">{{ cname }}</label>
          </div>
          <div class="qty" id="qty_{{key}}">
            <span class="muted">æ•°é‡</span>
            <input type="number" name="equip_{{key}}_qty" min="1" step="1" value="1">
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="row" style="margin-top:12px"><label>ç‰¹æ®Šéœ€æ±‚</label><textarea name="special_request"></textarea></div>
    </section>

    <!-- æ„Ÿæ©å¥‰çŒ® -->
    <section class="card">
      <h2><span class="icon">â¤ï¸</span>æ„Ÿæ©å¥‰çŒ®ï¼ˆå¯é€‰ï¼‰</h2>
      <label style="display:flex;align-items:center;gap:8px;font-weight:800">
        <input type="checkbox" id="donation_consent" name="donation_consent">æˆ‘æ„¿æ„ä¸ºæ­¤æ¬¡å™¨æä½¿ç”¨çŒ®ä¸Šæ„Ÿæ©å¥‰çŒ®
      </label>
      <div class="grid-3" id="donation_block" style="margin-top:10px;display:none">
        <div class="row"><label>å¥‰çŒ®é‡‘é¢ï¼ˆRMï¼‰ *</label><input type="number" id="donation_amount" name="donation_amount" min="1" step="1"></div>
        <div class="row"><label>å¥‰çŒ®æ–¹å¼ *</label>
          <select id="donation_method" name="donation_method">
            <option value="">-- è¯·é€‰æ‹© --</option>
            <option value="ç°é‡‘">ç°é‡‘</option>
            <option value="é“¶è¡Œè½¬è´¦">é“¶è¡Œè½¬è´¦</option>
          </select>
        </div>
        <div class="row"><span class="muted">ï¼ˆæœªå‹¾é€‰ä¸Šæ–¹å¤é€‰æ¡†åˆ™æ— éœ€å¡«å†™ï¼‰</span></div>
      </div>
    </section>

    <!-- å…¶ä»–ä¿¡æ¯ -->
    <section class="card">
      <h2><span class="icon">â„¹ï¸</span>å…¶ä»–ä¿¡æ¯</h2>
      <div class="grid-2">
        <div class="row"><label>å¤‡æ³¨</label><textarea name="remarks"></textarea></div>
        <div class="row"><label>ç´§æ€¥è”ç³»äººå§“å</label><input type="text" name="emergency_name" id="emergency_name"></div>
        <div class="row"><label>ç´§æ€¥è”ç³»äººç”µè¯</label><input type="text" name="emergency_phone" id="emergency_phone"></div>
      </div>
    </section>
    <div class="submit-wrap"><button class="btn-submit" type="submit">æäº¤ç”³è¯·</button></div>
  </form>

<script>
function toggleStatusForm(){
  const f=document.getElementById('statusForm');
  f.style.display=(f.style.display==='none'||!f.style.display)?'block':'none';
}
async function doLookup(){
  const name=(document.getElementById('status_name').value||'').trim();
  const box=document.getElementById('statusResult');
  if(!name){ box.style.display='block'; box.textContent='è¯·è¾“å…¥å§“å'; return; }
  box.style.display='block'; box.textContent='æŸ¥è¯¢ä¸­...';
  try{
    const res=await fetch(`/check_status_api?name=${encodeURIComponent(name)}`);
    const data=await res.json();
    if(!data||!data.status){ box.textContent='æœåŠ¡å™¨è¿”å›å¼‚å¸¸'; return; }
    if(data.status==='not_found'){ box.textContent=`æœªæ‰¾åˆ°ã€${name}ã€‘çš„ç”³è¯·è®°å½•ã€‚`; return;}
    if(data.status==='error'){ box.textContent=data.message||'æŸ¥è¯¢å‡ºé”™'; return;}
    const s=data.data.review_status||'';
    box.innerHTML=
      `<div class="status-row"><span class="muted">å§“å</span><b>${data.data.name}</b></div>
       <div class="status-row"><span class="muted">æ´»åŠ¨åç§°</span><b>${data.data.event_name||'-'}</b></div>
       <div class="status-row"><span class="muted">å®¡æ ¸çŠ¶æ€</span><span class="badge">${s}</span></div>
       <div class="status-row"><span class="muted">å®¡æ ¸è¯´æ˜</span><b>${data.data.review_comment||'æ— '}</b></div>`;
  }catch(e){ box.textContent='ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸'; }
}
(function initEquip(){
  const ids={{ equip_map.keys()|list|tojson }};
  const allBox=document.getElementById('equip_select_all');
  function syncOne(k){
    const cb=document.getElementById(`equip_${k}`);
    const box=document.getElementById(`qty_${k}`);
    const qty=document.querySelector(`input[name="equip_${k}_qty"]`);
    if(!cb||!box||!qty) return;
    if(cb.checked){ box.style.display='flex'; qty.required=true; if(!qty.value) qty.value=1;}
    else{ box.style.display='none'; qty.required=false; }
  }
  ids.forEach(k=>{const cb=document.getElementById(`equip_${k}`);if(cb){cb.addEventListener('change',()=>syncOne(k));syncOne(k);}});
  if(allBox){allBox.addEventListener('change',()=>{const on=allBox.checked;ids.forEach(k=>{const cb=document.getElementById(`equip_${k}`);if(cb){cb.checked=on;syncOne(k);}});});}
  // åŒæ­¥éº¦å…‹é£ä¸¤ä¸ªå•ç‹¬çš„
  ["mic_wireless","mic_wired"].forEach(k=>{
    const cb=document.getElementById(`equip_${k}`);
    const box=document.getElementById(`qty_${k}`);
    const qty=document.querySelector(`input[name="equip_${k}_qty"]`);
    if(cb){cb.addEventListener('change',()=>{if(cb.checked){box.style.display='flex'; qty.required=true;}else{box.style.display='none'; qty.required=false;}});}
  });
})();
(function initDonation(){
  const consent=document.getElementById('donation_consent');
  const block=document.getElementById('donation_block');
  const amount=document.getElementById('donation_amount');
  const method=document.getElementById('donation_method');
  const sync=()=>{const on=consent.checked;block.style.display=on?'grid':'none';amount.required=on;method.required=on;if(!on){amount.value='';method.value='';}};
  consent.addEventListener('change',sync); sync();
})();
document.getElementById('mainForm').addEventListener('submit',function(e){
  const name=(this.querySelector('input[name="name"]').value||'').trim();
  const phone=(this.querySelector('input[name="phone"]').value||'').trim();
  const en=(document.getElementById('emergency_name').value||'').trim();
  const ep=(document.getElementById('emergency_phone').value||'').trim();
  if(en&&en===name){ e.preventDefault(); alert("âš ï¸ ç´§æ€¥è”ç³»äººå§“åè¦ä¸ç”³è¯·äººå§“åä¸ä¸€è‡´"); }
  else if(ep&&ep===phone){ e.preventDefault(); alert("âš ï¸ ç´§æ€¥è”ç³»äººç”µè¯è¦ä¸ç”³è¯·äººè”ç³»ç”µè¯ä¸ä¸€è‡´"); }
});
</script>
</body>
</html>
